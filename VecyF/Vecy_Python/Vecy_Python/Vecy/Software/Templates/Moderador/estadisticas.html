{% extends 'Layout_M.html' %}
{% load static %}

{% block title %}Estadísticas - Dashboard Moderador{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header de la página -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="fas fa-chart-bar me-2"></i>Estadísticas Generales</h1>
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-calendar me-2"></i>Todos los tiempos
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#">Últimos 7 días</a></li>
                <li><a class="dropdown-item" href="#">Últimos 30 días</a></li>
                <li><a class="dropdown-item" href="#">Últimos 90 días</a></li>
                <li><a class="dropdown-item" href="#">Este año</a></li>
            </ul>
        </div>
    </div>

    <!-- Métricas Principales -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Usuarios Registrados
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_usuarios }}</div>
                            <div class="text-xs text-muted">{{ usuarios_activos }} activos</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Negocios Activos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ negocios_activos }}</div>
                            <div class="text-xs text-muted">de {{ total_negocios }} totales</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-store fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Reseñas Activas
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ resenas_activas }}</div>
                            <div class="text-xs text-muted">{{ promedio_estrellas }}★ promedio</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-star fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Negocios Suspendidos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ negocios_suspendidos }}</div>
                            <div class="text-xs text-muted">{{ negocios_inactivos }} rechazados</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-slash fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row">
        <!-- Negocios por Estado -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Negocios por Estado</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="estadoNegociosChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Negocios por Categoría -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Negocios por Categoría (Top 5)</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="categoriasChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Distribución de Usuarios -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Distribución de Negocios</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="distribucionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen de Actividad -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Resumen de Plataforma</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h4 class="text-primary">{{ total_usuarios }}</h4>
                                    <small class="text-muted">Usuarios Totales</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h4 class="text-success">{{ total_negocios }}</h4>
                                    <small class="text-muted">Negocios Totales</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h4 class="text-warning">{{ total_resenas }}</h4>
                                    <small class="text-muted">Reseñas Totales</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h4 class="text-info">{{ promedio_estrellas }}</h4>
                                    <small class="text-muted">Rating Promedio</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Categorías Detallada -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Negocios por Categoría</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Categoría</th>
                                    <th>Total de Negocios</th>
                                    <th>Porcentaje</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for categoria in negocios_por_categoria %}
                                <tr>
                                    <td>{{ categoria.fktiponeg_neg__desc_tiponeg }}</td>
                                    <td>{{ categoria.total }}</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar"
                                                style="width: {{ categoria.total|divisibleby:total_negocios|floatformat:2 }}%">
                                            </div>
                                        </div>
                                        {{ categoria.total|divisibleby:total_negocios|floatformat:1 }}%
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center">No hay datos disponibles</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .border-left-primary {
        border-left: 0.25rem solid #4e73df !important;
    }

    .border-left-success {
        border-left: 0.25rem solid #1cc88a !important;
    }

    .border-left-warning {
        border-left: 0.25rem solid #f6c23e !important;
    }

    .border-left-danger {
        border-left: 0.25rem solid #e74a3b !important;
    }

    .chart-container {
        position: relative;
    }

    .progress {
        height: 10px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Gráfico de estado de negocios
    const estadoCtx = document.getElementById('estadoNegociosChart').getContext('2d');
    const estadoChart = new Chart(estadoCtx, {
        type: 'doughnut',
        data: {
            labels: ['Activos', 'Rechazados', 'Suspendidos'],
            datasets: [{
                data: [{{ negocios_activos }}, {{ negocios_inactivos }}, {{ negocios_suspendidos }}],
    backgroundColor: ['#1cc88a', '#e74a3b', '#f6c23e'],
        hoverBackgroundColor: ['#17a673', '#d52a1e', '#dda20a'],
            borderWidth: 2
            }]
        },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
    });

    // Gráfico de categorías
    const catCtx = document.getElementById('categoriasChart').getContext('2d');
    const catChart = new Chart(catCtx, {
        type: 'bar',
        data: {
            labels: {{ categorias_nombres| safe }},
    datasets: [{
        label: 'Negocios',
        data: {{ categorias_totales| safe }},
        backgroundColor: '#4e73df',
        borderColor: '#2e59d9',
        borderWidth: 1
            }]
        },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                scales: {
            y: {
                beginAtZero: true,
                    ticks: {
                    stepSize: 1
                }
            }
        }
    }
    });

    // Gráfico de distribución
    const distCtx = document.getElementById('distribucionChart').getContext('2d');
    const distChart = new Chart(distCtx, {
        type: 'pie',
        data: {
            labels: ['Usuarios', 'Negocios', 'Reseñas'],
            datasets: [{
                data: [{{ total_usuarios }}, {{ total_negocios }}, {{ total_resenas }}],
    backgroundColor: ['#4e73df', '#1cc88a', '#f6c23e'],
        hoverBackgroundColor: ['#2e59d9', '#17a673', '#dda20a']
            }]
        },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
    });
</script>
{% endblock %}