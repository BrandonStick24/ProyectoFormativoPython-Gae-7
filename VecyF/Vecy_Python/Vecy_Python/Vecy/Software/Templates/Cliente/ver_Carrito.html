{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tu Carrito</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{% static 'css/carrito.css' %}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>

  <body class="p-4">
    <div class="container">
      <h2><i class="fas fa-cart-shopping"></i>Tu Carrito</h2>
      <div class="prodCarrito">
        {% for c in carrito_items %}
        <div class="cardProds">
          <div class="imgP">
            <img src="{{ c.item.fkproducto.img_prod.url }}" alt="" />
          </div>
          <div class="indicaciones">
            <span id="nom">{{ c.item.fkproducto.nom_prod }}</span> <br />
            <span
              ><strong>Cantidad:</strong
              ><span id="cant">{{ c.item.cantidad }}</span></span
            >
            <br />
            <span id="pre"
              ><strong>Precio: </strong>${{ c.item.precio_unitario }}</span
            >
          </div>
          <div class="subtotal">
            <span id="sub"><strong>Subtotal: </strong></span> <br />
            <h5>${{ c.subtotal }}</h5>
          </div>
        </div>
        {% endfor %}
        <div class="totalCarrito">
          <span id="tot"><strong>Total Compra: </strong></span>
          <span id="total">${{ total_carrito }}</span>
        </div>
      </div>

      {% if carrito_items %}
      <form id="checkoutForm" action="{% url 'procesar_pago' %}" method="post">
        {% csrf_token %}
        <div class="mb-3">
          <label for="metodo_pago"><strong>Método de pago</strong></label>
          <div class="rowPagos" id="logos_pagos">
            <div class="tarjeta logo" data-metodo="tarjeta">
              <img
                src="{% static 'img/tarjeta.jpg' %}"
                alt="Tarjeta"
                class="img-fluid"
              />
              <span>Tarjeta Crédito</span>
            </div>
            <div class="nequi logo" data-metodo="nequi">
              <img
                src="{% static 'img/nequi.jpg' %}"
                alt="Nequi"
                class="img-fluid"
              />
              <span>Nequi</span>
            </div>
            <div class="daviplata logo" data-metodo="daviplata">
              <img
                src="{% static 'img/daviplata.jpeg' %}"
                alt="Daviplata"
                class="img-fluid"
              />
              <span>Daviplata</span>
            </div>
            <div class="entrega logo" data-metodo="contra_entrega">
              <img
                src="{% static 'img/entrega.jpg' %}"
                alt="Contra entrega"
                class="img-fluid"
              />
              <span>Contra entrega</span>
            </div>
          </div>
          <input type="hidden" name="metodo_pago" id="metodo_pago" required />
        </div>

        <!-- Contenedor dinámico para campos según método -->
        <div id="methodContainer" class="mb-3" style="display: none"></div>

        <!-- Vista previa de la tarjeta -->
        <div
          id="cardPreview"
          class="card p-3 shadow-sm mb-3 d-none"
          style="
            max-width: 350px;
            border-radius: 15px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
          "
        >
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span id="cardBrand">CARD</span>
            <img
              src="https://cdn-icons-png.flaticon.com/512/196/196578.png"
              alt="chip"
              width="40"
            />
          </div>
          <div
            style="letter-spacing: 2px; font-size: 1.2rem"
            id="cardNumberPreview"
          >
            •••• •••• •••• ••••
          </div>
          <div class="d-flex justify-content-between mt-3">
            <div>
              <small>TITULAR</small><br />
              <span id="cardNamePreview">NOMBRE TITULAR</span>
            </div>
            <div>
              <small>VENCE</small><br />
              <span id="cardExpPreview">MM/AA</span>
            </div>
          </div>
        </div>

        <!-- Inputs ocultos que se envían al backend -->
        <input
          type="hidden"
          name="amount"
          id="amountInput"
          value="{{ total_carrito }}"
        />
        <input type="hidden" name="payment_token" id="paymentToken" value="" />
        <input
          type="hidden"
          name="transaction_id"
          id="transactionId"
          value=""
        />

        <div class="d-flex gap-2 mb-3">
          <button
            type="button"
            id="btnOpenModal"
            class="btn btn-success flex-grow-1"
          >
            Procesar pago
          </button>
        </div>
      </form>
      {% endif %}
    </div>

    <!-- Modal único de pasarela -->
    <div class="modal fade" id="gatewayModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Pasarela de pago</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body" id="gatewayBody"></div>
          <div class="modal-footer"></div>
        </div>
      </div>
    </div>

    <!-- Modal resultado -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Resultado del pago</h5>
          </div>
          <div class="modal-body" id="resultBody"></div>
          <div class="modal-footer">
            <button class="btn btn-primary" data-bs-dismiss="modal">
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {% if carrito_items %}
    <script>
      const carritoJS = [
        {% for c in carrito_items %}
          {
            nombre: "{{ c.item.fkproducto.nom_prod|escapejs }}",
            cantidad: {{ c.item.cantidad }},
            precio: {{ c.item.precio_unitario }},
            subtotal: {{ c.subtotal }}
          }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];
      const totalCarritoJS = {{ total_carrito }};
    </script>
    {% endif %}

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        /* ---------- Variables globales ---------- */
        const metodoSelect = document.getElementById("metodo_pago");
        const methodContainer = document.getElementById("methodContainer");
        const btnOpenModal = document.getElementById("btnOpenModal");
        const gatewayModal = new bootstrap.Modal(
          document.getElementById("gatewayModal")
        );
        const gatewayBody = document.getElementById("gatewayBody");
        const resultModal = new bootstrap.Modal(
          document.getElementById("resultModal")
        );
        const resultBody = document.getElementById("resultBody");
        const checkoutForm = document.getElementById("checkoutForm");

        const cardNumberPreview = document.getElementById("cardNumberPreview");
        const cardNamePreview = document.getElementById("cardNamePreview");
        const cardExpPreview = document.getElementById("cardExpPreview");
        const cardBrand = document.getElementById("cardBrand");

        const amountInput = document.getElementById("amountInput");
        const paymentToken = document.getElementById("paymentToken");
        const transactionIdInput = document.getElementById("transactionId");

        let selectedMethod = "";

        /* ---------- Helpers ---------- */
        function luhnCheck(cardNumber) {
          const nums = cardNumber
            .replace(/\D/g, "")
            .split("")
            .reverse()
            .map((x) => parseInt(x));
          let sum = 0;
          for (let i = 0; i < nums.length; i++) {
            let val = nums[i];
            if (i % 2 === 1) {
              val *= 2;
              if (val > 9) val -= 9;
            }
            sum += val;
          }
          return sum % 10 === 0;
        }

        function detectCardBrand(number) {
          const n = number.replace(/\D/g, "");
          if (/^4/.test(n)) return "VISA";
          if (/^(5[1-5])/.test(n)) return "MASTERCARD";
          if (/^3[47]/.test(n)) return "AMEX";
          if (/^6/.test(n)) return "DISCOVER";
          return "CARD";
        }

        function formatCardNumber(value) {
          return value
            .replace(/\D/g, "")
            .replace(/(.{4})/g, "$1 ")
            .trim();
        }

        function validateForm() {
          if (!selectedMethod) {
            alert("Por favor selecciona un método de pago");
            return false;
          }

          // Validaciones específicas por método
          if (selectedMethod === "tarjeta") {
            const cardName = document.getElementById("cardName");
            const cardNumber = document.getElementById("cardNumber");
            const cardExp = document.getElementById("cardExp");
            const cardCvv = document.getElementById("cardCvv");

            if (!cardName?.value.trim()) {
              alert("Ingresa el nombre en la tarjeta");
              return false;
            }
            if (!cardNumber?.value.trim() || !luhnCheck(cardNumber.value)) {
              alert("Número de tarjeta inválido");
              return false;
            }
            if (!cardExp?.value || !/^\d{2}\/\d{2}$/.test(cardExp.value)) {
              alert("Formato de expiración inválido (MM/AA)");
              return false;
            }
            if (!cardCvv?.value || cardCvv.value.length < 3) {
              alert("CVV inválido");
              return false;
            }
          } else if (
            selectedMethod === "nequi" ||
            selectedMethod === "daviplata"
          ) {
            const phone = document.getElementById("mmPhone");
            const pin = document.getElementById("mmPin");

            if (!phone?.value || phone.value.length < 10) {
              alert("Teléfono inválido (10 dígitos)");
              return false;
            }
            if (!pin?.value || pin.value.length !== 6) {
              alert("Clave dinámica inválida (6 dígitos)");
              return false;
            }
          } else if (selectedMethod === "contra_entrega") {
            // No necesita validación adicional
          }

          return true;
        }

        /* ---------- Render campos dinámicos ---------- */
        function renderMethodFields(method) {
          methodContainer.style.display = "block";
          methodContainer.innerHTML = "";

          if (method === "tarjeta") {
            methodContainer.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Nombre en la tarjeta *</label>
                    <input id="cardName" class="form-control" placeholder="Juan Pérez" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Número de tarjeta *</label>
                    <input id="cardNumber" maxlength="19" class="form-control" placeholder="4111 1111 1111 1111" required>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Fecha expiración (MM/AA) *</label>
                        <input id="cardExp" class="form-control" placeholder="12/25" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">CVV *</label>
                        <input id="cardCvv" class="form-control" placeholder="123" maxlength="4" required>
                    </div>
                </div>
                <div class="form-text">Usa números de prueba: <strong>4111 1111 1111 1111</strong> (Visa)</div>
            `;

            // Event listeners para vista previa
            setTimeout(() => {
              const cardName = document.getElementById("cardName");
              const cardNumber = document.getElementById("cardNumber");
              const cardExp = document.getElementById("cardExp");

              cardName?.addEventListener("input", () => {
                cardNamePreview.textContent =
                  cardName.value.toUpperCase() || "NOMBRE TITULAR";
              });

              cardNumber?.addEventListener("input", (e) => {
                e.target.value = formatCardNumber(e.target.value);
                cardNumberPreview.textContent =
                  e.target.value || "•••• •••• •••• ••••";
                cardBrand.textContent = detectCardBrand(e.target.value);
              });

              cardExp?.addEventListener("input", (e) => {
                cardExpPreview.textContent = e.target.value || "MM/AA";
              });
            }, 100);
          } else if (method === "nequi" || method === "daviplata") {
            methodContainer.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Teléfono (10 dígitos) *</label>
                    <input id="mmPhone" type="tel" class="form-control" placeholder="3001234567" maxlength="10" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Clave Dinámica (6 dígitos) *</label>
                    <input id="mmPin" type="password" class="form-control" maxlength="6" placeholder="1234" required>
                </div>
            `;
          } else if (method === "contra_entrega") {
            methodContainer.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Instrucciones de entrega (opcional)</label>
                    <textarea id="codEntrega" class="form-control" placeholder="Dejar en portería, llamar al llegar..."></textarea>
                </div>
                <div class="form-text">Pago en efectivo al recibir el pedido</div>
            `;
          }
        }

        /* ---------- Selección de método de pago ---------- */
        document.querySelectorAll(".rowPagos .logo").forEach((logo) => {
          logo.addEventListener("click", function () {
            // Quitar selección previa
            document
              .querySelectorAll(".rowPagos .logo")
              .forEach((l) => l.classList.remove("activo"));

            // Marcar selección actual
            this.classList.add("activo");

            // Guardar método seleccionado
            selectedMethod = this.dataset.metodo;
            document.getElementById("metodo_pago").value = selectedMethod;

            // Renderizar campos
            renderMethodFields(selectedMethod);

            // Mostrar/ocultar vista previa de tarjeta
            const cardPreview = document.getElementById("cardPreview");
            if (cardPreview) {
              cardPreview.classList.toggle(
                "d-none",
                selectedMethod !== "tarjeta"
              );
            }
          });
        });

        /* ---------- Abrir modal de pasarela ---------- */
        btnOpenModal.addEventListener("click", () => {
          if (!validateForm()) {
            return;
          }

          let html = "";
          if (selectedMethod === "tarjeta") {
            html = `
                <div class="processing-screen text-center">
                    <div class="mb-4">
                        <h5>Procesando pago con Tarjeta</h5>
                        <p class="text-muted">Simulación de pasarela de pago</p>
                    </div>
                    <div class="d-flex gap-2 justify-content-center">
                        <button id="gwProcessSuccess" class="btn btn-success">Simular pago exitoso</button>
                        <button id="gwProcessFail" class="btn btn-danger">Simular rechazo</button>
                    </div>
                </div>
            `;
          } else if (
            selectedMethod === "nequi" ||
            selectedMethod === "daviplata"
          ) {
            let productosHtml = "";
            carritoJS.forEach((p) => {
              productosHtml += `<div class="d-flex justify-content-between mb-1"><span>${p.nombre} x${p.cantidad}</span><span>$${p.subtotal} COP</span></div>`;
            });

            html = `
                <div>
                    <div class="mb-3"><strong>Dinero móvil (${selectedMethod.toUpperCase()})</strong></div>
                    <div class="mb-3">
                        <strong>Resumen de compra:</strong>
                        <div class="p-2 border rounded">
                            ${productosHtml}
                            <div class="d-flex justify-content-between mt-2 border-top pt-2">
                                <strong>Total:</strong> <strong>$${totalCarritoJS} COP</strong>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2 justify-content-center">
                        <button id="gwProcessSuccess" class="btn btn-success">Confirmar Pago</button>
                        <button id="gwProcessFail" class="btn btn-danger">Cancelar</button>
                    </div>
                </div>
            `;
          } else if (selectedMethod === "contra_entrega") {
            html = `
                <div class="processing-screen text-center">
                    <div class="mb-4">
                        <h5>Confirmar Pedido - Contra Entrega</h5>
                        <p class="text-muted">El cliente pagará en efectivo al recibir el pedido</p>
                    </div>
                    <div class="d-flex gap-2 justify-content-center">
                        <button id="gwProcessSuccess" class="btn btn-success">Confirmar Pedido</button>
                        <button id="gwProcessFail" class="btn btn-danger">Cancelar</button>
                    </div>
                </div>
            `;
          }

          gatewayBody.innerHTML = html;
          gatewayModal.show();

          // Agregar event listeners a los botones del modal
          setTimeout(() => {
            document
              .getElementById("gwProcessSuccess")
              ?.addEventListener("click", () => simulateGatewayResponse(true));
            document
              .getElementById("gwProcessFail")
              ?.addEventListener("click", () => simulateGatewayResponse(false));
          }, 100);
        });

        /* ---------- Simular respuesta de pasarela ---------- */
        function simulateGatewayResponse(success = true) {
          // Mostrar procesamiento
          gatewayBody.innerHTML = `
            <div class="processing-screen text-center">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                <div><strong>Procesando transacción...</strong></div>
            </div>
        `;

          setTimeout(() => {
            const transactionId = "TX-" + Date.now().toString(36).toUpperCase();
            const paymentTokenValue =
              "token_" + Math.random().toString(36).slice(2, 15);

            // Actualizar campos ocultos
            paymentToken.value = paymentTokenValue;
            transactionIdInput.value = transactionId;

            gatewayModal.hide();

            if (success) {
              showResult(true, {
                transaction_id: transactionId,
                amount: amountInput.value,
                method: selectedMethod,
              });
            } else {
              showResult(false, {
                transaction_id: transactionId,
                amount: amountInput.value,
                method: selectedMethod,
              });
            }
          }, 2000);
        }

        /* ---------- Mostrar resultado ---------- */
        function showResult(success, details) {
          let html = "";

          if (success) {
            html = `
                <div class="success-screen text-center">
                    <div class="mb-3">
                        <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="text-success">¡Pago Exitoso!</h4>
                    <p class="text-muted">Tu transacción ha sido procesada correctamente</p>
                    
                    <div class="card mt-3">
                        <div class="card-body text-start">
                            <h6 class="card-title">Detalles de la transacción:</h6>
                            <p><strong>Método:</strong> ${details.method}</p>
                            <p><strong>Monto:</strong> $${
                              details.amount
                            } COP</p>
                            <p><strong>ID Transacción:</strong> ${
                              details.transaction_id
                            }</p>
                            <p><strong>Fecha:</strong> ${new Date().toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 d-flex flex-column align-items-center gap-2">
    <button id="sendToServer" class="btn btn-primary btn-lg w-100">Finalizar y Confirmar Pedido</button>
    <a href="/descargar_comprobante/${details.transaction_id}/?metodo=${
              details.method
            }&monto=${details.amount}" 
       class="btn btn-outline-secondary w-100" 
       target="_blank">
       Descargar Comprobante PDF
    </a>
</div>

                </div>
            `;
          } else {
            html = `
                <div class="text-center">
                    <div class="mb-3">
                        <i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="text-danger">Pago Rechazado</h4>
                    <p class="text-muted">La transacción no pudo ser procesada</p>
                    <button class="btn btn-secondary mt-3" data-bs-dismiss="modal">Intentar Nuevamente</button>
                </div>
            `;
          }

          resultBody.innerHTML = html;
          resultModal.show();

          // Event listener para enviar al servidor
          const btnSend = document.getElementById("sendToServer");
          if (btnSend) {
            btnSend.addEventListener("click", function () {
              // Deshabilitar botón para evitar múltiples clics
              this.disabled = true;
              this.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Procesando...';

              // Enviar formulario al backend
              checkoutForm.submit();
            });
          }
        }

        /* ---------- Inicialización ---------- */
        console.log("Sistema de pago inicializado");
      });
    </script>
  </body>
</html>
