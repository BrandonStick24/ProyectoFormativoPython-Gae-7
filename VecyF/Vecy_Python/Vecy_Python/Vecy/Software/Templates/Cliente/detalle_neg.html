{% extends 'base.html' %}
{% load static %}
{% block title %}Página Principal{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/detalle_neg.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
{% endblock %}
{% block content %}
<div class="containerv">
    <div class="header">
        <div class="logo"><span>VECY</span></div>
        <div class="menu-desplegable">
            <span style="font-weight: bold;" data-bs-toggle="offcanvas" data-bs-target="#menuLateral">
                <i class="fas fa-bars iconm"></i> Menú
            </span>
        </div>
        <div class="input-group1">
            <input class="input" type="search" placeholder="Busca negocios, productos...">
            <i class="fas fa-search iconl"></i>
        </div>
        <div class="iniSesion">
            <i class="fas fa-house"></i>
            <a href="{% url 'cliente_dash' %}">Inicio</a>
        </div>
        <div class="iniSesion">
            <i class="fas fa-truck-fast"></i>
            <a href="" id="it2">Pedidos</a>
        </div>
        <div class="iniSesion">
            <i class="fas fa-cart-shopping"></i>
            <a href="{% url 'ver_carrito' %}">Carrito</a>
        </div>
        <div class="iniSesion">
            <i class="fas fa-heart"></i>
            <a href="">Favoritos</a>
        </div>
        <div class="iniSesion">
            <i class="fas fa-user-circle"></i>
            <a href="">Cuenta</a>
        </div>
    </div>
    <!--Menu lateral-->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="menuLateral" aria-labelledby="menuLateralLabel">
        <div class="offcanvas-header headerM">
            <h5 class="offcanvas-title" id="menuLateralLabel">VECY</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
                aria-label="Cerrar"></button>
        </div>
        <div class="offcanvas-body bodyM">
            <ul class="list-unstyled">
                <span class="cat mb-5">Categorías</span>
                <br>
                {% for categoria in categorias %}
                <li><a href="#" class="d-block categorias">{{ categoria.desc_cp }}</a></li>
                {% empty %}
                <li><span class="text-white-50">No hay categorías disponibles</span></li>
                {% endfor %}

            </ul>
        </div>
    </div>
    <div class="negocios">
        <img class="img_neg" src="{{ negocio.img_neg.url }}" alt="">
        <div class="propietario">
            <img class="img_prop" src="{% static " img/Usuario.jpg" %}" alt="">
        </div>
    </div>
    <div class="detalle_neg">
        <span>
            <h1>{{negocio.nom_neg}}</h1>
        </span>
        <span class="nom_neg"><strong class="em1">Dirección: </strong>{{negocio.direcc_neg}}</span> <br>
        <span class="nom_neg"><strong class="em1">Tipo Negocio: </strong>{{tipo_negocio.desc_tiponeg}}</span> <br>
        <span class="nom_neg"><strong class="em1">Sobre Nosotros: </strong>{{negocio.desc_neg}}</span>
        <span class="nom_neg"><strong class="em1">Calificación: </strong>
            <i class="fas fa-star iconc"></i>
            <i class="fas fa-star iconc"></i>
            <i class="fas fa-star iconc"></i>
            <i class="fas fa-star iconc"></i>
            <i class="fas fa-star iconc"></i>
        </span>
    </div>
</div>
<div class="catalogo_productos" data-aos="fade-up">
    <h2>Nuestro Catálogo de Productos</h2>
    <p>Encuentra el helado que más te guste</p>

    <div class="filtrarP" data-aos="fade-up">
        <input type="search" id="buscarProducto" placeholder="Buscar Productos...">
        <select id="filtroPrecio" name="filtroPrecio" class="select2" required>
            <option value="" selected>Filtrar por precio</option>
            <option value="0-5000">Hasta $5,000</option>
            <option value="5001-10000">$5,001 - $10,000</option>
            <option value="10001-20000">$10,001 - $20,000</option>
            <option value="20001-999999">Más de $20,000</option>
        </select>
    </div>

    <div class="productos">
        {% for prod in productos %}
        <div class="producto" data-nombre="{{ prod.nom_prod|lower }}" data-precio="{{ prod.precio_prod }}"
            data-aos="fade-up">
            <img class="prods" src="{{ prod.img_prod.url }}" alt="">
            <div class="info_prod">
                <h6>{{ prod.nom_prod }}</h6>
                <span><strong>Precio:</strong> ${{ prod.precio_prod }}</span> <br>
                <span><strong>Cantidad Disponible:</strong> {{ prod.stock_prod }}</span> <br>
                <span><strong>Descripción:</strong> {{ prod.desc_prod }}</span>
                <div class="solicitar d-flex align-items-center gap-2">
                    <button class="btn-minus btn btn-sm btn-outline-secondary">-</button>
                    <input type="number" class="cantidad-prod form-control form-control-sm" value="1" min="1"
                        style="width:50px;">
                    <button class="btn-plus btn btn-sm btn-outline-secondary">+</button>
                    <a href="#" class="btn btn-sm btn-success agregar-carrito" data-prod="{{ prod.pkid_prod }}">
                        <i class="fas fa-cart-plus"></i> Añadir al carrito
                    </a>


                </div>


            </div>
        </div>


        {% empty %}
        <p>No hay productos registrados para este negocio.</p>
        {% endfor %}
    </div>
</div>
<div class="resenas" data-aos="fade-up">
    <h2>Calificaciónes Y Opiniónes</h2>
    <p>En este apartado puedes calificar tu experiencia con el Negocio</p>
</div>
<div class="list_resenas" data-aos="fade-up">
    <div class="calificar">
        <h3>Califíca tu Experiencia</h3>
        <p>Comparte tu opinión con otros usuarios</p>
        <div class="evaluar-negocio">
            <form id="formResena" method="POST" action="{% url 'guardar_resena' %}">
                {% csrf_token %}
                <div class="estrellas">
                    <span class="star" data-value="1">&#9734;</span>
                    <span class="star" data-value="2">&#9734;</span>
                    <span class="star" data-value="3">&#9734;</span>
                    <span class="star" data-value="4">&#9734;</span>
                    <span class="star" data-value="5">&#9734;</span>
                </div>
                <input type="hidden" name="estrellas" id="estrellas_input" value="5">
                <textarea name="comentario" placeholder="Escribe tu opinión..."></textarea>
                <input type="hidden" name="fknegocio_resena" value="{{ negocio.pkid_neg }}"> <br>
                <button class="env_resena" type="submit">Enviar</button>
            </form>
        </div>
    </div>
    <div class="user_calificar">
        <h3>Opiniones de Usuarios</h3>
        <p>Visualiza las opiniones realizadas por otros usuarios</p>
        <h4>Reseñas:</h4>

        {% for r in resenas %}
        <div class="resena">
            <div class="resena-header">
                <img src="{% static 'img/Usuario.jpg' %}" alt="Usuario" class="img-resena">
            </div>

            <div class="resena-body">
                <span><strong>Usuario: </strong>{{ r.fkusuario_resena.fkuser.first_name }}</span><br>
                <span><strong>Comentario: </strong>{{ r.comentario }}</span><br>
                <span><strong>Calificación: </strong>{{ r.estrellas }}</span><br>
                <small><strong>Fecha: </strong>{{ r.fecha_resena|date:"d/m/Y H:i" }}</small><br>

                {% if r.respuesta_vendedor %}
                <div class="respuesta-vendedor mt-2 p-2 border rounded bg-light">
                    <strong>Respuesta del vendedor:</strong><br>
                    <p>{{ r.respuesta_vendedor }}</p>
                    {% if r.fecha_respuesta %}
                    <small><em>Respondido el {{ r.fecha_respuesta|date:"d/m/Y H:i" }}</em></small>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        <hr>
        {% empty %}
        <p>No hay reseñas todavía.</p>
        {% endfor %}
    </div>

</div>


{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {

    // ================== SISTEMA DE ESTRELLAS ==================
    const stars = document.querySelectorAll('.star');
    const inputEstrellas = document.getElementById('estrellas_input');

    stars.forEach((star, index) => {
        star.addEventListener('mouseover', () => {
            stars.forEach((s, i) => s.innerHTML = i <= index ? '&#9733;' : '&#9734;');
        });

        star.addEventListener('click', () => {
            inputEstrellas.value = star.dataset.value;
        });
    });

    document.querySelector('.estrellas').addEventListener('mouseleave', () => {
        const val = parseInt(inputEstrellas.value) || 0;
        stars.forEach((s, i) => s.innerHTML = i < val ? '&#9733;' : '&#9734;');
    });

    // ================== BOTONES + Y - ==================
    const productos = document.querySelectorAll('.producto');

    productos.forEach(prod => {
        const btnMinus = prod.querySelector('.btn-minus');
        const btnPlus = prod.querySelector('.btn-plus');
        const inputCantidad = prod.querySelector('.cantidad-prod');

        btnMinus.addEventListener('click', (e) => {
            e.preventDefault();
            let val = parseInt(inputCantidad.value) || 1;
            if (val > 1) inputCantidad.value = val - 1;
        });

        btnPlus.addEventListener('click', (e) => {
            e.preventDefault();
            let val = parseInt(inputCantidad.value) || 1;
            inputCantidad.value = val + 1;
        });
    });

    // ================== AGREGAR AL CARRITO AJAX ==================
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const botonesCarrito = document.querySelectorAll('.agregar-carrito');
    botonesCarrito.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();

            const prodId = this.dataset.prod;
            const inputCantidad = this.closest('.solicitar').querySelector('.cantidad-prod');
            const cantidad = parseInt(inputCantidad.value) || 1;

            fetch("{% url 'agregar_carrito_ajax' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken,
                },
                body: JSON.stringify({
                    'prod_id': prodId,
                    'cantidad': cantidad
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.success){
                    alert("Producto agregado al carrito!");
                } else {
                    alert("Error al agregar al carrito.");
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>
{% endblock %}
