{% extends 'base.html' %}
{% load static %}
{% block title %}P√°gina Principal{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/detalle_neg.css' %}">
{% endblock %}
{% block content %}
<div class="containerv">
    <div class="menu">
        <a class="item_menu i1" href="{% url 'cliente_dash' %}">
            <i class="fas fa-house"></i> Inicio</a>
        <a class="item_menu i2" href="">
            <i class="fas fa-basket-shopping"></i> Productos</a>
        <a class="item_menu i3" href="#" data-bs-toggle="modal" data-bs-target="#modalCarrito">
            <i class="fas fa-shopping-cart"></i> Carrito de pedidos
            <span id="contadorCarrito" class="badge bg-danger">0</span>
        </a>
        <a class="item_menu i5" href="#" data-bs-toggle="modal" data-bs-target="#modalMisPedidos">
            <i class="fas fa-box"></i> Mis Pedidos
        </a>

        <a class="item_menu i4" href="">
            <i class="fas fa-heart"></i> Favoritos</a>
        <div class="dropdown">
            <a href="" class="dropdown-toggle item_menu item1" data-bs-toggle="dropdown" aria-expanded="false">
                {{ nombre }}
                <i class="fa-solid fa-chevron-down ms-2"></i>
            </a>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="">Editar Cuenta</a></li>
                <li><a class="dropdown-item" href="{% url "cerrar_sesion" %}">Salir</a></li>
            </ul>
        </div>
    </div>
    <div class="negocios">
        <img class="img_neg" src="{{ negocio.img_neg.url }}" alt="">
        <div class="propietario">
            <img class="img_prop" src="{% static "img/Usuario.jpg" %}" alt="">
        </div>
    </div>
    <div class="detalle_neg">
        <span>
            <h1>{{negocio.nom_neg}}</h1>
        </span>
        <span class="nom_neg"><strong class="em1">Direcci√≥n: </strong>{{negocio.direcc_neg}}</span> <br>
        <span class="nom_neg"><strong class="em1">Tipo Negocio: </strong>{{tipo_negocio.desc_tiponeg}}</span> <br>
        <span class="nom_neg"><strong class="em1">Sobre Nosotros: </strong>{{negocio.desc_neg}}</span>
        <span class="nom_neg"><strong class="em1">Calificaci√≥n: </strong>
            <i class="fas fa-star iconc"></i>
            <i class="fas fa-star iconc"></i>
            <i class="fas fa-star iconc"></i>
            <i class="fas fa-star iconc"></i>
            <i class="fas fa-star iconc"></i>
        </span>
    </div>
</div>
<div class="catalogo_productos" data-aos="fade-up">
    <h2>Nuestro Cat√°logo de Productos</h2>
    <p>Encuentra el helado que m√°s te guste</p>

    <div class="filtrarP" data-aos="fade-up">
        <input type="search" id="buscarProducto" placeholder="Buscar Productos...">
        <select id="filtroPrecio" name="filtroPrecio" class="select2" required>
            <option value="" selected>Filtrar por precio</option>
            <option value="0-5000">Hasta $5,000</option>
            <option value="5001-10000">$5,001 - $10,000</option>
            <option value="10001-20000">$10,001 - $20,000</option>
            <option value="20001-999999">M√°s de $20,000</option>
        </select>
    </div>

    <div class="productos">
        {% for prod in productos %}
        <div class="producto" data-nombre="{{ prod.nom_prod|lower }}" data-precio="{{ prod.precio_prod }}"
            data-aos="fade-up">
            <img class="prods" src="{{ prod.img_prod.url }}" alt="">
            <div class="info_prod">
                <h6>{{ prod.nom_prod }}</h6>
                <span><strong>Precio:</strong> ${{ prod.precio_prod }}</span> <br>
                <span><strong>Cantidad Disponible:</strong> {{ prod.stock_prod }}</span> <br>
                <span><strong>Descripci√≥n:</strong> {{ prod.desc_prod }}</span>
                <div class="solicitar">
                    <button class="btn-add-carrito" data-producto="{{ prod.pkid_prod }}"
                        data-negocio="{{ negocio.pkid_neg }}" data-img="{{ prod.img_prod.url }}">
                        <i class="fas fa-cart-plus" style="font-size: 20px;"></i>
                    </button>

                    <i class="fas fa-heart icons"></i>
                </div>

            </div>
        </div>


        {% empty %}
        <p>No hay productos registrados para este negocio.</p>
        {% endfor %}
    </div>
</div>
<div class="resenas" data-aos="fade-up">
    <h2>Calificaci√≥nes Y Opini√≥nes</h2>
    <p>En este apartado puedes calificar tu experiencia con el Negocio</p>
</div>
<div class="list_resenas" data-aos="fade-up">
    <div class="calificar">
        <h3>Calif√≠ca tu Experiencia</h3>
        <p>Comparte tu opini√≥n con otros usuarios</p>
        <div class="evaluar-negocio">
            <form id="formResena" method="POST" action="{% url 'guardar_resena' %}">
                {% csrf_token %}
                <div class="estrellas">
                    <span class="star" data-value="1">&#9734;</span>
                    <span class="star" data-value="2">&#9734;</span>
                    <span class="star" data-value="3">&#9734;</span>
                    <span class="star" data-value="4">&#9734;</span>
                    <span class="star" data-value="5">&#9734;</span>
                </div>
                <input type="hidden" name="estrellas" id="estrellas_input" value="5">
                <textarea name="comentario" placeholder="Escribe tu opini√≥n..."></textarea>
                <input type="hidden" name="fknegocio_resena" value="{{ negocio.pkid_neg }}"> <br>
                <button class="env_resena" type="submit">Enviar</button>
            </form>
        </div>
    </div>
    <div class="user_calificar">
        <h3>Opiniones de Usuarios</h3>
        <p>Visualiza las opiniones realizadas por otros usuarios</p>
        <h4>Rese√±as:</h4>

        {% for r in resenas %}
        <div class="resena">
            <div class="resena-header">
                <img src="{% static 'img/Usuario.jpg' %}" alt="Usuario" class="img-resena">
            </div>

            <div class="resena-body">
                <span><strong>Usuario: </strong>{{ r.fkusuario_resena.fkuser.first_name }}</span><br>
                <span><strong>Comentario: </strong>{{ r.comentario }}</span><br>
                <span><strong>Calificaci√≥n: </strong>{{ r.estrellas }}</span><br>
                <small><strong>Fecha: </strong>{{ r.fecha_resena|date:"d/m/Y H:i" }}</small><br>

                {% if r.respuesta_vendedor %}
                <div class="respuesta-vendedor mt-2 p-2 border rounded bg-light">
                    <strong>Respuesta del vendedor:</strong><br>
                    <p>{{ r.respuesta_vendedor }}</p>
                    {% if r.fecha_respuesta %}
                    <small><em>Respondido el {{ r.fecha_respuesta|date:"d/m/Y H:i" }}</em></small>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        <hr>
        {% empty %}
        <p>No hay rese√±as todav√≠a.</p>
        {% endfor %}
    </div>

</div>
<!-- Modal Carrito de Pedidos -->
<div class="modal fade" id="modalCarrito" tabindex="-1" aria-labelledby="modalCarritoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCarritoLabel">
                    <i class="fas fa-shopping-cart"></i> Tu Carrito de Pedidos
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <!-- Input oculto con el id del negocio -->
                <input type="hidden" id="fknegocio" value="{{ negocio.pkid_neg }}">

                <!-- Contenedor de productos -->
                <div id="carritoContainer">
                    <p class="text-center text-muted">Tu carrito est√° vac√≠o üõí</p>
                </div>

                <hr>

                <!-- Progreso del Pedido -->
                <div id="progresoPedido" class="mt-4" style="display:none;">
                    <h6>Estado del Pedido:</h6>
                    <div class="progress">
                        <div id="barraProgreso" class="progress-bar" role="progressbar" style="width: 0%;"
                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">Pendiente</div>
                    </div>
                </div>

                <!-- Total y botones -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <h5><strong>Total:</strong> $<span id="totalCarrito">0</span></h5>
                    <div>
                        <button id="btnConfirmarPedido" class="confirmPe">Confirmar pedido</button>
                        <button id="btnCancelarPedido" class="btn btn-outline-danger">Cancelar pedido</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal Mis Pedidos -->
<div class="modal fade" id="modalMisPedidos" tabindex="-1" aria-labelledby="modalMisPedidosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalMisPedidosLabel">
                    <i class="fas fa-box"></i> Mis Pedidos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaPedidos">
                        <!-- Los pedidos se llenar√°n desde JS -->
                        <tr><td colspan="5" class="text-center text-muted">Cargando pedidos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>



{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {

    // ================== FILTRO DE PRODUCTOS ==================
    const buscarProducto = document.getElementById('buscarProducto');
    const filtroPrecio = document.getElementById('filtroPrecio');

    function filtrarProductos() {
        let busqueda = buscarProducto.value.toLowerCase();
        let rango = filtroPrecio.value;
        let min = 0, max = Infinity;

        if (rango) {
            let limites = rango.split('-');
            min = parseFloat(limites[0]);
            max = parseFloat(limites[1]);
        }

        document.querySelectorAll('.producto').forEach(prod => {
            let nombre = prod.dataset.nombre.toLowerCase();
            let precio = parseFloat(prod.dataset.precio);
            prod.style.display = (nombre.includes(busqueda) && precio >= min && precio <= max) ? '' : 'none';
        });
    }

    buscarProducto.addEventListener('keyup', filtrarProductos);
    filtroPrecio.addEventListener('change', filtrarProductos);

    // ================== SISTEMA DE ESTRELLAS ==================
    const stars = document.querySelectorAll('.star');
    const inputEstrellas = document.getElementById('estrellas_input');

    stars.forEach((star, index) => {
        star.addEventListener('mouseover', () => {
            stars.forEach((s, i) => s.innerHTML = i <= index ? '&#9733;' : '&#9734;');
        });
        star.addEventListener('click', () => inputEstrellas.value = star.dataset.value);
    });

    document.querySelector('.estrellas').addEventListener('mouseleave', () => {
        const val = parseInt(inputEstrellas.value) || 0;
        stars.forEach((s, i) => s.innerHTML = i < val ? '&#9733;' : '&#9734;');
    });

    // ================== CARRITO ==================
    let carrito = [];
    let pedidoId = null;
    let intervaloProgreso = null;

    document.querySelectorAll('.btn-add-carrito').forEach(btn => {
        btn.addEventListener('click', function () {
            const productoId = this.dataset.producto;
            const card = this.closest('.producto');
            const nombre = card.querySelector('h6').textContent;
            const precio = parseFloat(card.dataset.precio);
            const imagen = this.dataset.img;

            const existente = carrito.find(p => p.id === productoId);
            if (existente) existente.cantidad++;
            else carrito.push({ id: productoId, nombre, precio, cantidad: 1, imagen });

            actualizarModalCarrito();
        });
    });

    function actualizarModalCarrito() {
        const contenedor = document.getElementById('carritoContainer');
        const total = document.getElementById('totalCarrito');
        const contador = document.getElementById('contadorCarrito');

        contenedor.innerHTML = '';
        if (!carrito.length) {
            contenedor.innerHTML = '<p class="text-center text-muted">Tu carrito est√° vac√≠o üõí</p>';
            total.textContent = '0';
            contador.textContent = '0';
            return;
        }

        let totalPrecio = 0, totalCantidad = 0;

        carrito.forEach((p, index) => {
            const subtotal = p.precio * p.cantidad;
            totalPrecio += subtotal;
            totalCantidad += p.cantidad;

            const div = document.createElement('div');
            div.classList.add('carrito-producto', 'p-3', 'mb-2', 'shadow-sm', 'rounded', 'd-flex', 'justify-content-between', 'align-items-center');
            div.innerHTML = `
            <div class="d-flex align-items-center justify-content-between mb-2 p-2 shadow-sm rounded" style="background:#fff;">
                <div class="d-flex align-items-center">
                    <div class="carrito-imagen me-3">
                        <img src="${p.imagen}" alt="${p.nombre}" class="rounded" style="width:60px; height:60px; object-fit:cover;">
                    </div>
                    <div class="carrito-info">
                        <h6 class="mb-1">${p.nombre}</h6>
                        <div class="d-flex flex-column">
                            <span class="carrito-precio text-muted"><strong>Precio:</strong> $${p.precio}</span>
                            <span class="carrito-cantidad badge rounded-pill" style="background-color: #55AD9B;">Cantidad: ${p.cantidad}</span>
                            <span class="carrito-subtotal"><strong>Subtotal:</strong> $${subtotal}</span>
                        </div>
                    </div>
                </div>
                <div class="carrito-acciones ms-3">
                    <button class="btn btn-sm btn-outline-danger eliminar-item" data-index="${index}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
            contenedor.appendChild(div);
        });

        total.textContent = totalPrecio;
        contador.textContent = totalCantidad;

        document.querySelectorAll('.eliminar-item').forEach(btn => {
            btn.addEventListener('click', function () {
                carrito.splice(this.dataset.index, 1);
                actualizarModalCarrito();
            });
        });
    }

    // ================== CSRF ==================
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie) {
            document.cookie.split(';').forEach(cookie => {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            });
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // ================== CONFIRMAR PEDIDO ==================
    const btnConfirm = document.getElementById('btnConfirmarPedido');

    btnConfirm.addEventListener('click', () => {
        if (!carrito.length) { alert('‚ö†Ô∏è No tienes productos en el carrito.'); return; }

        const fknegocio = document.getElementById('fknegocio').value;

        fetch("{% url 'guardar_pedido' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify({ carrito, fknegocio })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("‚úÖ Pedido guardado correctamente!");
                carrito = [];
                actualizarModalCarrito();
                pedidoId = data.pedido_id;
                iniciarActualizacionProgreso(pedidoId);
            } else {
                alert("‚ö†Ô∏è Error: " + (data.error || "No se pudo guardar el pedido"));
            }
        })
        .catch(err => console.error(err));
    });

    // ================== BARRA DE PROGRESO ==================
    const estados = ['pendiente', 'confirmado', 'preparando', 'enviado', 'entregado', 'cancelado'];

    function mostrarProgresoPedido(estadoActual) {
        const barra = document.getElementById('barraProgreso');
        if (!barra) return;

        const index = estados.indexOf(estadoActual);
        const porcentaje = ((index + 1) / (estados.length - 1)) * 100;

        barra.style.width = porcentaje + '%';
        barra.textContent = estadoActual.charAt(0).toUpperCase() + estadoActual.slice(1);
        barra.parentElement.style.display = 'block';
    }

    function iniciarActualizacionProgreso(pedidoId) {
        const barra = document.getElementById('barraProgreso');
        barra.parentElement.style.display = 'block';

        if (intervaloProgreso) clearInterval(intervaloProgreso);

        intervaloProgreso = setInterval(() => {
            fetch(`/estado_pedido/${pedidoId}/`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        mostrarProgresoPedido(data.estado);
                        if (data.estado === 'entregado' || data.estado === 'cancelado') {
                            clearInterval(intervaloProgreso);
                        }
                    }
                })
                .catch(err => console.error(err));
        }, 5000);
    }

    // ================== MODAL MIS PEDIDOS ==================
    const modalPedidos = document.getElementById('modalMisPedidos');

    function cargarPedidos() {
        const tbody = document.getElementById('tablaPedidos');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Cargando pedidos...</td></tr>';

        fetch("{% url 'mis_pedidos_json' %}")
            .then(res => res.json())
            .then(data => {
                tbody.innerHTML = '';
                if(data.pedidos.length === 0){
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No tienes pedidos.</td></tr>';
                    return;
                }

                data.pedidos.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-id', p.id);
                    tr.innerHTML = `
                        <td>${p.id}</td>
                        <td>${p.fecha}</td>
                        <td>$${p.total}</td>
                        <td>${p.estado}</td>
                        <td>
                            ${p.estado !== 'cancelado' && p.estado !== 'entregado' 
                              ? `<button class="btn btn-sm btn-danger btn-cancelar" data-id="${p.id}">Cancelar</button>` 
                              : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // ================== BOTONES CANCELAR ==================
document.querySelectorAll('.btn-cancelar').forEach(btn => {
    btn.addEventListener('click', function () {
        const id = this.dataset.id;

        if(!confirm("¬øEst√°s seguro de cancelar este pedido?")) return;

        fetch(`/cancelar_pedido/${id}/`, {
            method: "POST",
            headers: { "X-CSRFToken": csrftoken }
        })
        .then(res => res.json())
        .then(resp => {
            if(resp.success){
                alert('‚úÖ Pedido cancelado');
                // Actualizar la fila para mostrar estado cancelado
                const fila = document.querySelector(`#tablaPedidos tr[data-id='${id}']`);
                if(fila){
                    fila.querySelector('td:nth-child(4)').textContent = 'cancelado';
                    // Quitar el bot√≥n de cancelar
                    const btnAccion = fila.querySelector('.btn-cancelar');
                    if(btnAccion) btnAccion.remove();
                }
            } else {
                alert('‚ö†Ô∏è Error al cancelar pedido');
            }
        })
        .catch(err => console.error(err));
    });
});
            })
            .catch(err => {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error cargando pedidos</td></tr>';
                console.error(err);
            });
    }

    modalPedidos.addEventListener('show.bs.modal', cargarPedidos);

});
</script>
{% endblock %}
