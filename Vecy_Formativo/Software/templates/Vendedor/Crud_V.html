<!-- templates/Vendedor/Crud_V.html -->
{% extends 'Layout_V.html' %}
{% load static %}

{% block title %}Gesti√≥n de Productos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'vendedor/css/crud_V.css' %}">
<style>
/* Estilos para el modal de importaci√≥n */
.importacion-guia {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    border: 2px solid #bae6fd;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.pasos-importacion {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1.5rem 0;
}

.paso-card {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
}

.paso-numero {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #4F46E5, #7C3AED);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-weight: bold;
}

.plantilla-preview {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}

.columnas-tabla {
    font-size: 0.9rem;
    color: #475569;
}

.badge-columna {
    background: #4F46E5;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    margin-right: 0.5rem;
}

.archivo-cargado {
    background: #f0fdf4;
    border: 2px solid #bbf7d0;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}

.btn-descargar {
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-descargar:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    color: white;
}

/* Nuevos estilos para la informaci√≥n de stock detallada */
.stock-detallado {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
}

.stock-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
}

.stock-total {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
}

.stock-oferta {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #92400e;
    border: 1px solid #fbbf24;
}

.stock-normal {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #10b981;
}

.stock-bajo {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #f59e0b;
}

.stock-critico {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #ef4444;
}

.badge-oferta {
    background: linear-gradient(135deg, #ec4899, #8b5cf6);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

</style>
{% endblock %}

{% block content %}
<!-- Header Mejorado con Gr√°ficas -->
<div class="tarjeta-bienvenida">
    <div class="row align-items-center">
        <div class="col-md-6">
            <h2>Gesti√≥n de Productos</h2>
            <p class="text-muted">Administra tu inventario de productos y sus variantes.</p>
        </div>
        <div class="col-md-6">
            <div class="estadisticas-grid">
                <div class="estadistica-card total">
                    <div class="estadistica-icono">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="estadistica-numero">{{ productos_con_variantes|length }}</div>
                    <div class="estadistica-titulo">Total Productos</div>
                </div>
                
                <div class="estadistica-card disponibles">
                    <div class="estadistica-icono">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="estadistica-numero">{{ productos_disponibles.count }}</div>
                    <div class="estadistica-titulo">Disponibles</div>
                </div>
                
                <div class="estadistica-card oferta">
                    <div class="estadistica-icono">
                        <i class="fas fa-tag"></i>
                    </div>
                    <div class="estadistica-numero">{{ productos_en_oferta|length }}</div>
                    <div class="estadistica-titulo">En Oferta</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}

<!-- Barra de Herramientas Mejorada -->
<div class="barra-herramientas">
    <div class="grupo-botones-accion">
        <button class="boton-accion boton-primario" data-bs-toggle="modal" data-bs-target="#modalAgregarProducto">
            <i class="fas fa-plus"></i> Agregar Producto
        </button>
        <button class="boton-accion boton-masivo" data-bs-toggle="modal" data-bs-target="#modalImportarProductos">
            <i class="fas fa-file-import"></i> Carga Masiva
        </button>
    </div>

    <div class="grupo-busqueda-filtros">
        <div class="contenedor-busqueda">
            <i class="fas fa-search icono-busqueda" title="Haz clic para limpiar b√∫squeda"></i>
            <input type="text" id="inputBusqueda" class="input-busqueda" placeholder="Buscar por nombre, descripci√≥n o categor√≠a...">
        </div>
        
        <div class="contenedor-filtros">
            <select class="select-filtro" id="selectFiltro">
                <option value="todos">Todos los productos</option>
                <option value="disponible">Disponibles</option>
                <option value="sin-stock">Sin stock</option>
                <option value="stock-bajo">Stock bajo (‚â§ 5)</option>
                <option value="oferta">En oferta</option>
            </select>
            
            <button class="boton-accion boton-secundario" id="btnOrdenAsc" title="Ordenar productos">
                <i class="fas fa-sort-amount-up"></i>
            </button>
        </div>
    </div>
</div>

<!-- Lista de Productos con Variantes -->
<div class="contenedor-productos">
    {% for producto_data in productos_con_variantes %}
    {% with producto=producto_data.producto variantes=producto_data.variantes %}
    {% with oferta_producto=producto_data.oferta stock_oferta_producto=producto_data.stock_oferta %}
    <div class="producto-card">
        <div class="producto-header">
            <div class="producto-info">
                <div class="producto-imagen">
                    {% if producto.img_prod %}
                    <img src="{{ producto.img_prod.url }}" alt="{{ producto.nom_prod }}">
                    {% else %}
                    <div class="img-placeholder">
                        <i class="fas fa-box"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="producto-details">
                    <h5>{{ producto.nom_prod }}</h5>
                    <p class="producto-descripcion">{{ producto.desc_prod|default:"Sin descripci√≥n"|truncatewords:20 }}</p>
                    <div class="producto-meta">
                        <span class="precio">${{ producto.precio_prod }}</span>
                        <span class="categoria">{{ producto.fkcategoria_prod.desc_cp }}</span>
                        
                        <!-- Informaci√≥n de Stock Detallada para Producto Base -->
        
                        <div class="stock-detallado">
                            <span class="stock-item stock-total">
                                <i class="fas fa-boxes"></i> Total: {{ producto_data.stock_total }}
                            </span>
                            {% if producto_data.en_oferta %}
                            <span class="stock-item stock-oferta">
                                <i class="fas fa-tag"></i> Oferta: {{ producto_data.stock_oferta }}
                            </span>
                            <span class="stock-item stock-normal">
                                <i class="fas fa-cube"></i> Base: {{ producto_data.stock_normal }}
                            </span>
                            {% else %}
                            <span class="stock-item {% if producto_data.stock_total == 0 %}stock-critico{% elif producto_data.stock_total <= 5 %}stock-bajo{% else %}stock-normal{% endif %}">
                                <i class="fas fa-cube"></i> Base: {{ producto_data.stock_total }}
                            </span>
                            {% endif %}
                        </div>

                        {% if producto_data.en_oferta %}
                        <span class="badge-oferta">
                            <i class="fas fa-percentage"></i> {{ producto_data.descuento }}% OFF
                        </span>
                        {% endif %}
                        
                        {% if oferta_producto %}
                        <span class="badge-oferta">
                            <i class="fas fa-percentage"></i> {{ oferta_producto.porcentaje_descuento }}% OFF
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="producto-actions">
                <!-- Bot√≥n Editar - Ahora abre directamente el modal con datos -->
                <button class="btn btn-warning btn-sm" 
                        data-bs-toggle="modal" 
                        data-bs-target="#modalEditarProducto"
                        onclick="cargarDatosProducto('{{ producto.pkid_prod }}', '{{ producto.nom_prod }}', '{{ producto.precio_prod }}', '{{ producto.stock_prod }}', '{{ producto.estado_prod }}', '{{ producto.fkcategoria_prod.pkid_cp }}', `{{ producto.desc_prod|default:''|escapejs }}`)">
                    <i class="fas fa-edit"></i> Editar
                </button>

                <!-- Bot√≥n Ajustar Stock -->
                <button class="btn btn-info btn-sm" 
                        data-bs-toggle="modal" 
                        data-bs-target="#modalAjustarStock"
                        onclick="cargarDatosStock('{{ producto.pkid_prod }}', '{{ producto.nom_prod }}', '{{ producto.stock_prod }}')">
                    <i class="fas fa-boxes"></i> Stock
                </button>
                
                <!-- Bot√≥n Variantes -->
                <a href="{% url 'gestionar_variantes' producto.pkid_prod %}" class="btn btn-variantes btn-sm">
                    <i class="fas fa-layer-group"></i> Variantes 
                    <span class="contador-variantes-boton">{{ variantes|length }}</span>
                </a>
                
                <!-- Bot√≥n Eliminar -->
                <button class="btn btn-danger btn-sm" 
                        data-bs-toggle="modal" 
                        data-bs-target="#modalEliminarProducto"
                        onclick="cargarDatosEliminar('{{ producto.pkid_prod }}', '{{ producto.nom_prod }}')">
                    <i class="fas fa-trash"></i>
                </button>
                
                <i class="fas fa-chevron-down flecha-acordeon"></i>
            </div>
        </div>

        <!-- Secci√≥n de Variantes -->
        <div class="variantes-section">
            <div class="variantes-header">
                <h6>
                    <i class="fas fa-layer-group"></i>
                    Variantes del Producto
                    <span class="contador-variantes">{{ variantes|length }} variante{{ variantes|length|pluralize }}</span>
                </h6>
            </div>
            
            {% if variantes %}
            <div class="variantes-grid">
                {% for variante in variantes %}
                <div class="variante-card">
                    <div class="variante-header">
                        <span class="variante-nombre">{{ variante.nombre }}</span>
                        <span class="variante-precio">${{ variante.precio_total }}</span>
                    </div>
                    <div class="variante-detalles">
                        <div class="variante-info">
                            <span>Precio adicional: ${{ variante.precio_adicional }}</span>
                        </div>
                        
                        <!-- Informaci√≥n de Stock Detallada para Variante -->
                        <!-- Informaci√≥n de Stock Detallada para Variante -->
                        <div class="stock-detallado">
                            <span class="stock-item stock-total">
                                <i class="fas fa-box"></i> Total: {{ variante.stock }}
                            </span>
                            {% if variante.en_oferta %}
                            <span class="stock-item stock-oferta">
                                <i class="fas fa-tag"></i> Oferta: {{ variante.stock_oferta }}
                            </span>
                            <span class="stock-item stock-normal">
                                <i class="fas fa-cube"></i> Normal: {{ variante.stock_normal }}
                            </span>
                            {% else %}
                            <span class="stock-item {% if variante.stock == 0 %}stock-critico{% elif variante.stock <= 5 %}stock-bajo{% else %}stock-normal{% endif %}">
                                <i class="fas fa-cube"></i> Base: {{ variante.stock }}
                            </span>
                            {% endif %}
                        </div>

                        {% if variante.en_oferta %}
                        <div class="variante-info">
                            <span class="badge-oferta">
                                <i class="fas fa-percentage"></i> {{ variante.porcentaje_oferta }}% OFF
                            </span>
                        </div>
                        {% endif %}
                        
                        {% if variante.sku %}
                        <div class="variante-info">
                            <span class="text-muted">SKU: {{ variante.sku }}</span>
                        </div>
                        {% endif %}
                        
                        {% if variante.en_oferta %}
                        <div class="variante-info">
                            <span class="badge-oferta">
                                <i class="fas fa-percentage"></i> {{ variante.porcentaje_oferta }}% OFF
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-3">
                <i class="fas fa-layer-group fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">Este producto no tiene variantes registradas.</p>
                <a href="{% url 'gestionar_variantes' producto.pkid_prod %}" class="btn btn-variantes btn-sm mt-2">
                    <i class="fas fa-plus"></i> Agregar primera variante
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endwith %}
    {% endwith %}
    {% empty %}
    <div class="text-center py-5">
        <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
        <h4 class="text-muted">No hay productos registrados</h4>
        <p class="text-muted">Comienza agregando tu primer producto.</p>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAgregarProducto">
            <i class="fas fa-plus"></i> Agregar primer producto
        </button>
    </div>
    {% endfor %}
</div>

<!-- Modal Agregar Producto -->
<div class="modal fade" id="modalAgregarProducto" tabindex="-1" aria-labelledby="modalAgregarProductoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAgregarProductoLabel">Agregar Nuevo Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'crear_producto_P' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nom_prod" class="form-label">Nombre del Producto *</label>
                                <input type="text" class="form-control" id="nom_prod" name="nom_prod" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="precio_prod" class="form-label">Precio *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="precio_prod" name="precio_prod" step="0.01" min="0" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoria_prod" class="form-label">Categor√≠a *</label>
                                <select class="form-control" id="categoria_prod" name="categoria_prod" required>
                                    <option value="">Selecciona una categor√≠a...</option>
                                    {% for categoria in categorias %}
                                    <option value="{{ categoria.id }}">{{ categoria.descripcion }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stock_prod" class="form-label">Stock</label>
                                <input type="number" class="form-control" id="stock_prod" name="stock_prod" min="0" value="0">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="estado_prod" class="form-label">Estado del Producto</label>
                                <select class="form-control" id="estado_prod" name="estado_prod">
                                    <option value="disponible">Disponible</option>
                                    <option value="no_disponible">No Disponible</option>
                                    <option value="agotado">Agotado</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="img_prod" class="form-label">Imagen del Producto</label>
                                <input type="file" class="form-control" id="img_prod" name="img_prod" accept="image/*">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="desc_prod" class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" id="desc_prod" name="desc_prod" rows="3" placeholder="Describe tu producto..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Producto -->
<div class="modal fade" id="modalEditarProducto" tabindex="-1" aria-labelledby="modalEditarProductoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarProductoLabel">Editar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formEditarProducto" method="post" action="" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" id="producto_id_editar" name="producto_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nom_prod_editar" class="form-label">Nombre del Producto *</label>
                                <input type="text" class="form-control" id="nom_prod_editar" name="nom_prod" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="precio_prod_editar" class="form-label">Precio *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="precio_prod_editar" name="precio_prod" step="0.01" min="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoria_prod_editar" class="form-label">Categor√≠a *</label>
                                <select class="form-control" id="categoria_prod_editar" name="categoria_prod" required>
                                    <option value="">Selecciona una categor√≠a...</option>
                                    {% for categoria in categorias %}
                                    <option value="{{ categoria.id }}">{{ categoria.descripcion }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stock_prod_editar" class="form-label">Stock</label>
                                <input type="number" class="form-control" id="stock_prod_editar" name="stock_prod" min="0" value="0">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="estado_prod_editar" class="form-label">Estado del Producto</label>
                                <select class="form-control" id="estado_prod_editar" name="estado_prod">
                                    <option value="disponible">Disponible</option>
                                    <option value="no_disponible">No Disponible</option>
                                    <option value="agotado">Agotado</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="img_prod_editar" class="form-label">Imagen del Producto</label>
                                <input type="file" class="form-control" id="img_prod_editar" name="img_prod" accept="image/*">
                                <div class="form-text">La imagen actual se mantendr√° si no se selecciona una nueva</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="desc_prod_editar" class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" id="desc_prod_editar" name="desc_prod" rows="3" placeholder="Describe tu producto..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Actualizar Producto</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ajustar Stock -->
<div class="modal fade" id="modalAjustarStock" tabindex="-1" aria-labelledby="modalAjustarStockLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAjustarStockLabel">Ajustar Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formAjustarStock" method="post" action="">
                {% csrf_token %}
                <input type="hidden" id="producto_id_stock" name="producto_id">
                <div class="modal-body">
                    <p>Producto: <strong id="nombre_producto_stock"></strong></p>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stock_actual" class="form-label">Stock Actual:</label>
                                <input type="number" class="form-control" id="stock_actual" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo_ajuste" class="form-label">Tipo de Ajuste:</label>
                                <select class="form-control" id="tipo_ajuste" name="tipo_ajuste">
                                    <option value="entrada">Entrada (+)</option>
                                    <option value="salida">Salida (-)</option>
                                    <option value="ajuste">Ajuste Manual</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="cantidad_ajuste" class="form-label">Cantidad:</label>
                        <input type="number" class="form-control" id="cantidad_ajuste" name="cantidad_ajuste" min="0" required>
                        <div class="form-text" id="texto_ayuda">
                            Ingrese la cantidad a sumar o restar
                        </div>
                    </div>

                    <div class="mb-3" id="campo_stock_final" style="display: none;">
                        <label for="stock_final" class="form-label">Stock Final:</label>
                        <input type="number" class="form-control" id="stock_final" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="motivo_ajuste" class="form-label">Motivo del Ajuste:</label>
                        <select class="form-control" id="motivo_ajuste" name="motivo_ajuste">
                            <option value="compra_proveedor">Compra a Proveedor</option>
                            <option value="devolucion_cliente">Devoluci√≥n de Cliente</option>
                            <option value="inventario_fisico">Ajuste por Inventario F√≠sico</option>
                            <option value="danio_perdida">Da√±o o P√©rdida</option>
                            <option value="promocion">Preparaci√≥n para Promoci√≥n</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Actualizar Stock</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Eliminar Producto -->
<div class="modal fade" id="modalEliminarProducto" tabindex="-1" aria-labelledby="modalEliminarProductoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalEliminarProductoLabel">
                    <i class="fas fa-trash-alt me-2"></i>Eliminar Producto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formEliminarProducto" method="post" action="">
                {% csrf_token %}
                <input type="hidden" id="producto_id_eliminar" name="producto_id">
                
                <div class="modal-body">
                    <!-- Informaci√≥n del producto -->
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle fa-lg me-3"></i>
                            <div>
                                <h6 class="alert-heading mb-1">Producto a eliminar:</h6>
                                <span class="fw-bold text-danger fs-5" id="nombre_producto_eliminar"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Campo de motivo de eliminaci√≥n -->
                    <div class="mb-4">
                        <label for="motivo_eliminacion" class="form-label fw-bold">
                            <i class="fas fa-clipboard-list me-2"></i>Motivo de eliminaci√≥n:
                        </label>
                        <select class="form-select form-select-lg" id="motivo_eliminacion" name="motivo_eliminacion" required>
                            <option value="" disabled selected>Selecciona un motivo...</option>
                            <option value="Producto descontinuado">üì¶ Producto descontinuado</option>
                            <option value="Baja demanda">üìâ Baja demanda</option>
                            <option value="Problemas con proveedor">üöö Problemas con proveedor</option>
                            <option value="Cambio de temporada">üçÇ Cambio de temporada</option>
                            <option value="Reestructuraci√≥n de inventario">üìä Reestructuraci√≥n de inventario</option>
                            <option value="Error en registro">‚ùå Error en registro</option>
                            <option value="Calidad insuficiente">‚≠ê Calidad insuficiente</option>
                            <option value="Precio no competitivo">üí∞ Precio no competitivo</option>
                            <option value="Falta de materias primas">‚öôÔ∏è Falta de materias primas</option>
                            <option value="Otro motivo">üîç Otro motivo</option>
                        </select>
                        <div class="form-text text-muted">
                            <i class="fas fa-history me-1"></i>
                            Este motivo se registrar√° permanentemente en el historial de movimientos de stock.
                        </div>
                    </div>

                    <!-- Campo para motivo personalizado -->
                    <div class="mb-3" id="campo_motivo_personalizado" style="display: none;">
                        <label for="motivo_personalizado" class="form-label fw-bold">
                            <i class="fas fa-edit me-2"></i>Especificar motivo:
                        </label>
                        <textarea class="form-control" id="motivo_personalizado" name="motivo_personalizado" 
                                  rows="2" placeholder="Describe el motivo espec√≠fico de la eliminaci√≥n..."></textarea>
                    </div>

                    <!-- Advertencias importantes -->
                    <div class="alert alert-warning border-warning">
                        <div class="d-flex">
                            <i class="fas fa-exclamation-triangle fa-2x me-3 text-warning"></i>
                            <div>
                                <h6 class="alert-heading mb-2">‚ö†Ô∏è Acci√≥n irreversible</h6>
                                <ul class="mb-0 ps-3">
                                    <li>El producto ser√° <strong>eliminado permanentemente</strong> del sistema</li>
                                    <li>Todas las <strong>variantes asociadas</strong> ser√°n eliminadas</li>
                                    <li>Las <strong>promociones relacionadas</strong> ser√°n removidas</li>
                                    <li>Se registrar√° un <strong>movimiento de stock</strong> con el motivo seleccionado</li>
                                    <li class="text-danger"><strong>Esta acci√≥n no se puede deshacer</strong></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Confirmaci√≥n final -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirmar_eliminacion" required>
                        <label class="form-check-label fw-bold text-danger" for="confirmar_eliminacion">
                            <i class="fas fa-check-circle me-1"></i>
                            Confirmo que entiendo las consecuencias y deseo proceder con la eliminaci√≥n
                        </label>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-danger" id="btn_confirmar_eliminacion" disabled>
                        <i class="fas fa-trash-alt me-1"></i> Confirmar Eliminaci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal Importar Productos - AGREGAR DESPU√âS DEL MODAL ELIMINAR -->
<div class="modal fade" id="modalImportarProductos" tabindex="-1" aria-labelledby="modalImportarProductosLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalImportarProductosLabel">
                    <i class="fas fa-file-excel me-2"></i>
                    Importar Productos desde Excel
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'importar_productos_excel' %}" enctype="multipart/form-data" id="formImportarExcel">
                {% csrf_token %}
                <div class="modal-body">
                    
                    <!-- Gu√≠a R√°pida -->
                    <div class="importacion-guia">
                        <h6 class="mb-3">
                            <i class="fas fa-lightbulb me-2"></i>
                            ¬øC√≥mo importar tus productos?
                        </h6>
                        
                        <div class="pasos-importacion">
                            <div class="paso-card">
                                <div class="paso-numero">1</div>
                                <h6>Descarga Plantilla</h6>
                                <p class="text-muted small">Obt√©n el formato correcto</p>
                            </div>
                            <div class="paso-card">
                                <div class="paso-numero">2</div>
                                <h6>Llena los Datos</h6>
                                <p class="text-muted small">Productos y variantes</p>
                            </div>
                            <div class="paso-card">
                                <div class="paso-numero">3</div>
                                <h6>Sube el Archivo</h6>
                                <p class="text-muted small">Procesamiento autom√°tico</p>
                            </div>
                        </div>
                    </div>

                    <!-- Descargar Plantilla -->
                    <div class="text-center mb-4">
                        <a href="{% url 'descargar_plantilla_productos' %}" class="btn btn-descargar">
                            <i class="fas fa-download me-1"></i>
                            Descargar Plantilla Excel
                        </a>
                    </div>

                    <!-- Vista Previa de Columnas -->
                    <div class="plantilla-preview">
                        <h6 class="mb-3">
                            <i class="fas fa-table me-2"></i>
                            Estructura de la Plantilla
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">üìã PRODUCTOS BASE</h6>
                                <div class="columnas-tabla">
                                    <div><span class="badge-columna">A</span> nombre*</div>
                                    <div><span class="badge-columna">B</span> precio*</div>
                                    <div><span class="badge-columna">C</span> descripcion</div>
                                    <div><span class="badge-columna">D</span> stock_inicial</div>
                                    <div><span class="badge-columna">E</span> categoria*</div>
                                    <div><span class="badge-columna">F</span> estado</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">üé® VARIANTES (Opcional)</h6>
                                <div class="columnas-tabla">
                                    <div><span class="badge-columna">A</span> producto_base*</div>
                                    <div><span class="badge-columna">B</span> nombre_variante*</div>
                                    <div><span class="badge-columna">C</span> precio_adicional</div>
                                    <div><span class="badge-columna">D</span> stock</div>
                                    <div><span class="badge-columna">E</span> estado</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Tip:</strong> Las variantes se vinculan autom√°ticamente al producto base por nombre
                        </div>
                    </div>

                    <!-- Subir Archivo -->
                    <div class="mb-3">
                        <label for="archivo_excel" class="form-label">
                            <i class="fas fa-upload me-2"></i>
                            Selecciona tu archivo Excel
                        </label>
                        <input type="file" class="form-control" id="archivo_excel" name="archivo_excel" accept=".xlsx, .xls" required>
                        <div class="form-text">
                            Formatos aceptados: .xlsx, .xls (M√°x: 10MB)
                        </div>
                    </div>

                    <!-- Opciones de Importaci√≥n -->
                    <div class="mb-3">
                        <label class="form-label">Opciones de importaci√≥n:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="sobrescribir_existentes" id="sobrescribir_existentes">
                            <label class="form-check-label" for="sobrescribir_existentes">
                                Sobrescribir productos existentes (mismo nombre)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="crear_categorias" id="crear_categorias" checked>
                            <label class="form-check-label" for="crear_categorias">
                                Crear categor√≠as autom√°ticamente si no existen
                            </label>
                        </div>
                    </div>

                    <!-- Preview del archivo seleccionado -->
                    <div id="preview-archivo" class="archivo-cargado" style="display: none;">
                        <h6 class="mb-2">
                            <i class="fas fa-file-excel text-success me-2"></i>
                            Archivo listo para importar
                        </h6>
                        <p class="mb-1" id="nombre-archivo"></p>
                        <p class="mb-0 text-muted small" id="tama√±o-archivo"></p>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnImportar">
                        <i class="fas fa-upload me-1"></i> Importar Productos
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'vendedor/js/Crud_V.js' %}"></script>
<script>
// Script para el modal de importaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    const archivoInput = document.getElementById('archivo_excel');
    const previewArchivo = document.getElementById('preview-archivo');
    const nombreArchivo = document.getElementById('nombre-archivo');
    const tama√±oArchivo = document.getElementById('tama√±o-archivo');
    const btnImportar = document.getElementById('btnImportar');
    const formImportar = document.getElementById('formImportarExcel');

    // Mostrar preview del archivo
    if (archivoInput) {
        archivoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileName = file.name;
                const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
                
                nombreArchivo.textContent = `Archivo: ${fileName}`;
                tama√±oArchivo.textContent = `Tama√±o: ${fileSize} MB`;
                previewArchivo.style.display = 'block';
                
                // Validar tama√±o m√°ximo (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('‚ùå El archivo es demasiado grande. M√°ximo 10MB permitido.');
                    archivoInput.value = '';
                    previewArchivo.style.display = 'none';
                }
            } else {
                previewArchivo.style.display = 'none';
            }
        });
    }

    // Validaci√≥n antes de enviar
    if (formImportar) {
        formImportar.addEventListener('submit', function(e) {
            const archivo = archivoInput.files[0];
            if (!archivo) {
                e.preventDefault();
                alert('‚ùå Por favor selecciona un archivo Excel.');
                return false;
            }
            
            // Mostrar loading
            btnImportar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Importando...';
            btnImportar.disabled = true;
            
            return true;
        });
    }

    // Resetear bot√≥n cuando se cierre el modal
    const modalImportar = document.getElementById('modalImportarProductos');
    if (modalImportar) {
        modalImportar.addEventListener('hidden.bs.modal', function() {
            if (btnImportar) {
                btnImportar.innerHTML = '<i class="fas fa-upload me-1"></i> Importar Productos';
                btnImportar.disabled = false;
            }
            if (previewArchivo) {
                previewArchivo.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}


