{% extends 'Layout_V.html' %}
{% load static %}

{% block title %}Rese√±as de Clientes{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header con Estad√≠sticas -->
    <div class="tarjeta-bienvenida">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2><i class="fas fa-comments me-2"></i> Rese√±as de Clientes</h2>
                <p style="white">Gestiona y responde a los comentarios de tus clientes.</p>
            </div>
            <div class="col-md-6">
                <div class="estadisticas-grid">
                    <div class="estadistica-card">
                        <div class="estadistica-icono">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="estadistica-numero">{{ total_resenas }}</div>
                        <div class="estadistica-titulo">Total Rese√±as</div>
                    </div>
                    
                    <div class="estadistica-card">
                        <div class="estadistica-icono">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="estadistica-numero">{{ promedio_estrellas }}/5</div>
                        <div class="estadistica-titulo">Calificaci√≥n</div>
                    </div>
                    
                    <div class="estadistica-card">
                        <div class="estadistica-icono">
                            <i class="fas fa-reply"></i>
                        </div>
                        <div class="estadistica-numero">{{ resenas_respondidas }}</div>
                        <div class="estadistica-titulo">Respondidas</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de Filtros -->
    <div class="barra-filtros-resenas mb-4">
        <div class="row g-3">
            <div class="col-md-3">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" id="buscador-resenas" class="form-control border-start-0" placeholder="Buscar rese√±as...">
                </div>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="filtro-calificacion">
                    <option value="todas">‚≠ê Todas las estrellas</option>
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê (3)</option>
                    <option value="2">‚≠ê‚≠ê (2)</option>
                    <option value="1">‚≠ê (1)</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="filtro-estado">
                    <option value="todas">üìã Todos los estados</option>
                    <option value="pendiente">‚è≥ Pendientes</option>
                    <option value="respondida">‚úÖ Respondidas</option>
                    <option value="reportada">üö© Reportadas</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="filtro-orden">
                    <option value="reciente">üìÖ M√°s recientes</option>
                    <option value="antiguo">üìÖ M√°s antiguas</option>
                    <option value="mejor">‚≠ê Mejor calificaci√≥n</option>
                    <option value="peor">‚≠ê Peor calificaci√≥n</option>
                </select>
            </div>
            <div class="col-md-3">
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary flex-grow-1" id="btn-limpiar-filtros">
                        <i class="fas fa-times me-1"></i> Limpiar
                    </button>
                    <span class="badge bg-primary align-self-center" id="contador-filtrado">
                        {{ total_resenas }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Layout Principal -->
    <div class="row g-4">
        <!-- Columna Izquierda: Lista de Rese√±as -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i> Lista de Rese√±as</h5>
                        <div class="d-flex gap-2">
                            <span class="badge bg-primary">{{ total_resenas }}</span>
                            <span class="badge bg-warning">{{ total_resenas|add:"-resenas_respondidas" }}</span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="contenedor-lista-resenas" style="max-height: 65vh; overflow-y: auto;">
                        {% if resenas %}
                            <div class="lista-resenas" id="lista-resenas">
                                {% for resena in resenas %}
                                <div class="resena-item {% if resena.tiene_respuesta %}resena-respondida{% endif %} {% if resena.reportada %}resena-reportada{% endif %}" 
                                     data-index="{{ forloop.counter0 }}"
                                     data-id="{{ resena.id }}"
                                     data-calificacion="{{ resena.calificacion }}"
                                     data-estado="{% if resena.reportada %}reportada{% elif resena.tiene_respuesta %}respondida{% else %}pendiente{% endif %}"
                                     onclick="mostrarResena({{ forloop.counter0 }})">
                                    <div class="resena-header">
                                        <div class="resena-avatar bg-primary">
                                            {{ resena.cliente|slice:":1"|upper }}
                                        </div>
                                        <div class="resena-info">
                                            <div class="resena-info-top">
                                                <h6 class="resena-cliente mb-0">{{ resena.cliente }}</h6>
                                                <div class="estrellas-resena">
                                                    {% for i in "12345" %}
                                                        {% if forloop.counter <= resena.calificacion %}
                                                            <i class="fas fa-star text-warning"></i>
                                                        {% else %}
                                                            <i class="far fa-star text-warning"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="resena-meta">
                                                <small class="text-muted">
                                                    <i class="far fa-clock me-1"></i>{{ resena.fecha }}
                                                </small>
                                                <span class="badge {% if resena.reportada %}bg-danger{% elif resena.tiene_respuesta %}bg-success{% else %}bg-warning{% endif %}">
                                                    {% if resena.reportada %}
                                                        <i class="fas fa-flag me-1"></i>Reportada
                                                    {% elif resena.tiene_respuesta %}
                                                        <i class="fas fa-check-circle me-1"></i>Respondida
                                                    {% else %}
                                                        <i class="fas fa-clock me-1"></i>Pendiente
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="resena-comentario mt-2">
                                        <p class="text-truncate mb-0">{{ resena.comentario }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-comments fa-4x text-muted mb-3"></i>
                                <h5 class="text-muted">A√∫n no tienes rese√±as</h5>
                                <p class="text-muted">Los comentarios de tus clientes aparecer√°n aqu√≠.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Detalle y Respuesta -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-comment-dots me-2"></i> Detalle de Rese√±a</h5>
                        <button class="btn btn-sm btn-outline-primary" id="btn-exportar-resena">
                            <i class="fas fa-download me-1"></i> Exportar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="detalle-resena">
                        <div class="text-center py-5">
                            <div class="empty-state">
                                <i class="fas fa-mouse-pointer fa-3x text-muted mb-3"></i>
                                <h4 class="text-muted">Selecciona una rese√±a</h4>
                                <p class="text-muted">Haz clic en una rese√±a de la lista para ver los detalles y responder</p>
                                <div class="mt-4 text-start">
                                    <div class="d-flex align-items-start mb-2">
                                        <i class="fas fa-lightbulb text-warning mt-1 me-2"></i>
                                        <small>Las respuestas profesionales mejoran la confianza</small>
                                    </div>
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-clock text-info mt-1 me-2"></i>
                                        <small>Responde en menos de 24 horas para mejor experiencia</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Reportar Rese√±a -->
<div class="modal fade" id="modalReportar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-gradient-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-flag me-2"></i>Reportar Rese√±a
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-reportar">
                    {% csrf_token %}
                    <input type="hidden" id="resena_id_reportar" name="resena_id">
                    
                    <div class="alert alert-light border mb-3">
                        <div id="preview-resena-reportar">
                            <!-- Se llena con JavaScript -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Motivo del Reporte *</label>
                        <select class="form-select" id="motivo_reporte" name="motivo" required>
                            <option value="">Selecciona un motivo</option>
                            <option value="contenido_inapropiado">üö´ Contenido inapropiado</option>
                            <option value="lenguaje_ofensivo">üí¢ Lenguaje ofensivo</option>
                            <option value="spam">üì¢ Spam o publicidad</option>
                            <option value="informacion_falsa">‚ùå Informaci√≥n falsa</option>
                            <option value="acoso">‚ö†Ô∏è Acoso o bullying</option>
                            <option value="otro">üîç Otro motivo</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Descripci√≥n (opcional)</label>
                        <textarea class="form-control" id="descripcion_reporte" name="descripcion" rows="3" 
                                  placeholder="Proporciona m√°s detalles sobre el reporte..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="enviarReporte()">
                    <i class="fas fa-flag me-1"></i> Reportar Rese√±a
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Template para el detalle de rese√±a -->
<div id="template-resena" style="display: none;">
    <div class="resena-detalle-completa">
        <!-- Header de la rese√±a -->
        <div class="resena-detalle-header">
            <div class="d-flex align-items-start">
                <div class="resena-avatar-detalle bg-primary">
                    <span id="detalle-avatar-inicial">U</span>
                </div>
                <div class="ms-3 flex-grow-1">
                    <h5 class="mb-1" id="detalle-cliente"></h5>
                    <div class="d-flex align-items-center flex-wrap gap-2">
                        <small class="text-muted">
                            <i class="far fa-calendar me-1"></i>
                            <span id="detalle-fecha"></span>
                        </small>
                        <span class="badge" id="detalle-estado-badge"></span>
                        <span class="badge bg-secondary">ID: <span id="detalle-id"></span></span>
                    </div>
                </div>
                <div class="text-end">
                    <div class="calificacion-badge" id="calificacion-badge">
                        <span id="detalle-calificacion-numero"></span><small>/5</small>
                    </div>
                    <div class="estrellas-detalle" id="detalle-estrellas"></div>
                </div>
            </div>
        </div>

        <!-- Comentario del cliente -->
        <div class="seccion-comentario-cliente mt-4">
            <h6 class="text-muted mb-2">
                <i class="fas fa-user-edit me-2"></i>Comentario del Cliente
            </h6>
            <div class="card border">
                <div class="card-body">
                    <div class="comentario-content">
                        <p class="mb-0" id="detalle-comentario"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Respuesta Existente -->
        <div class="seccion-respuesta-existente mt-4" id="respuesta-existente" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="text-success mb-0">
                    <i class="fas fa-check-circle me-2"></i>Tu Respuesta
                </h6>
                <small class="text-muted" id="fecha-respuesta"></small>
            </div>
            <div class="card border-success">
                <div class="card-body">
                    <div class="respuesta-content">
                        <p class="mb-0" id="texto-respuesta"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario de Respuesta -->
        <div class="seccion-formulario-respuesta mt-4">
            <h6 class="text-muted mb-3">
                <i class="fas fa-edit me-2"></i>
                <span id="titulo-formulario">Responder a la Rese√±a</span>
            </h6>
            <form method="post" action="" id="form-respuesta">
                {% csrf_token %}
                <div class="card border">
                    <div class="card-body">
                        <div class="campo-respuesta">
                            <textarea name="respuesta" class="form-control" 
                                      placeholder="Escribe tu respuesta profesional aqu√≠... Recuerda ser amable y profesional. Tu respuesta ser√° visible para todos los clientes." 
                                      rows="4" id="textarea-respuesta" required></textarea>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted" id="estado-reportada-mensaje" style="display: none;">
                                    <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                    Esta rese√±a ha sido reportada
                                </small>
                                <small class="text-muted">
                                    <span id="contador-caracteres">0</span>/1000 caracteres
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="mostrarModalReportar()">
                                <i class="fas fa-flag me-1"></i> Reportar Rese√±a
                            </button>
                            <div>
                                <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="btn-cancelar-respuesta">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="fas fa-paper-plane me-1"></i> 
                                    <span id="texto-boton-respuesta">Publicar Respuesta</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* ===== ESTILOS GENERALES ===== */
:root {
    --primary-color: #5F85DB;
    --primary-light: #90B8F8;
    --success-color: #10B981;
    --warning-color: #F59E0B;
    --danger-color: #EF4444;
}

/* ===== TARJETA DE BIENVENIDA ===== */
.tarjeta-bienvenida {
    background: linear-gradient(135deg, #26282B 0%, #353941 100%);
    color: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.tarjeta-bienvenida::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 200%;
    background: rgba(95, 133, 219, 0.1);
    transform: rotate(30deg);
}

.tarjeta-bienvenida h2 {
    color: white;
    margin-bottom: 0.5rem;
    font-weight: 700;
    position: relative;
}

.tarjeta-bienvenida p {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 0;
    position: relative;
}

/* ===== ESTAD√çSTICAS ===== */
.estadisticas-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-top: 1rem;
}

.estadistica-card {
    background: rgba(95, 133, 219, 0.15);
    backdrop-filter: blur(10px);
    padding: 1.5rem;
    border-radius: 15px;
    text-align: center;
    border: 1px solid rgba(95, 133, 219, 0.25);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.estadistica-card:hover {
    transform: translateY(-5px);
    background: rgba(95, 133, 219, 0.25);
    border-color: rgba(144, 184, 248, 0.4);
}

.estadistica-icono {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    opacity: 0.9;
    color: #90B8F8;
}

.estadistica-numero {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    color: white;
}

.estadistica-titulo {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* ===== BARRA DE FILTROS ===== */
.barra-filtros-resenas {
    background: white;
    padding: 1.5rem;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
}

/* ===== LISTA DE RESE√ëAS ===== */
.contenedor-lista-resenas {
    padding: 0;
}

.lista-resenas {
    display: flex;
    flex-direction: column;
}

.resena-item {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #F3F4F6;
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}

.resena-item:hover {
    background: #F9FAFB;
    transform: translateX(2px);
}

.resena-item.activa {
    background: #5F85DB;
    color: white;
    border-left-color: #5F85DB;
}

.resena-item.activa .resena-cliente,
.resena-item.activa .resena-comentario p,
.resena-item.activa .text-muted {
    color: white !important;
}

.resena-item.activa .badge {
    background: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
}

.resena-respondida {
    border-left-color: #10B981;
}

.resena-reportada {
    border-left-color: #EF4444;
}

.resena-header {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.resena-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    flex-shrink: 0;
}

.resena-avatar.bg-primary { background: var(--primary-color); }
.resena-avatar.bg-success { background: var(--success-color); }
.resena-avatar.bg-warning { background: var(--warning-color); }
.resena-avatar.bg-danger { background: var(--danger-color); }

.resena-info {
    flex: 1;
}

.resena-info-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.25rem;
}

.resena-cliente {
    font-weight: 600;
    color: #1F2937;
    margin: 0;
    font-size: 1rem;
}

.estrellas-resena {
    font-size: 0.8rem;
    color: #F59E0B;
}

.resena-meta {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
}

.resena-comentario p {
    color: #6B7280;
    font-size: 0.9rem;
    line-height: 1.4;
    margin: 0;
}

/* ===== DETALLE DE RESE√ëA ===== */
.resena-detalle-completa {
    animation: fadeInUp 0.3s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.resena-detalle-header {
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #E5E7EB;
    margin-bottom: 1.5rem;
}

.resena-avatar-detalle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.calificacion-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 12px;
    font-size: 1.25rem;
    font-weight: 700;
    background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
    color: #065F46;
}

.estrellas-detalle {
    color: #F59E0B;
    font-size: 1rem;
    margin-top: 0.25rem;
}

/* ===== SECCIONES DE CONTENIDO ===== */
.seccion-comentario-cliente .card,
.seccion-respuesta-existente .card {
    border-left: 4px solid var(--primary-color);
}

.seccion-respuesta-existente .card {
    border-left-color: var(--success-color);
}

/* ===== FORMULARIO DE RESPUESTA ===== */
.seccion-formulario-respuesta .card {
    border: 1px solid #E5E7EB;
}

.campo-respuesta textarea {
    resize: vertical;
    min-height: 120px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    transition: all 0.3s;
}

.campo-respuesta textarea:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(95, 133, 219, 0.1);
    outline: none;
}

/* ===== BOTONES ===== */
.btn-primary {
    background: linear-gradient(135deg, #5F85DB, #90B8F8);
    border: none;
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #4a6bb8, #5F85DB);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(95, 133, 219, 0.4);
}

/* ===== MODAL ===== */
.modal-content {
    border-radius: 15px;
    border: none;
    box-shadow: 0 20px 60px rgba(95, 133, 219, 0.3);
}

.modal-header.bg-gradient-danger {
    background: linear-gradient(135deg, var(--danger-color), #DC2626);
    color: white;
}

/* ===== NOTIFICACIONES ===== */
.notificacion-flotante {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
    max-width: 400px;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 1200px) {
    .estadisticas-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 992px) {
    .tarjeta-bienvenida {
        padding: 1.5rem;
    }
    
    .estadisticas-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
    }
    
    .estadistica-card {
        padding: 1rem;
    }
    
    .estadistica-numero {
        font-size: 2rem;
    }
}

@media (max-width: 768px) {
    .estadisticas-grid {
        grid-template-columns: 1fr;
    }
    
    .resena-detalle-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .resena-info-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
}

@media (max-width: 576px) {
    .tarjeta-bienvenida {
        padding: 1.25rem;
    }
    
    .barra-filtros-resenas {
        padding: 1rem;
    }
    
    .resena-item {
        padding: 1rem;
    }
    
    .seccion-formulario-respuesta .card-footer .d-flex {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .seccion-formulario-respuesta .card-footer .d-flex > div {
        width: 100%;
        display: flex;
        justify-content: space-between;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Datos de las rese√±as para JavaScript
const resenasData = [
    {% for resena in resenas %}
    {
        id: {{ resena.id }},
        cliente: "{{ resena.cliente|escapejs }}",
        fecha: "{{ resena.fecha }}",
        calificacion: {{ resena.calificacion }},
        comentario: `{{ resena.comentario|escapejs }}`,
        respuesta: `{{ resena.respuesta|escapejs }}`,
        tiene_respuesta: {{ resena.tiene_respuesta|yesno:"true,false" }},
        fecha_respuesta: "{{ resena.fecha_respuesta }}",
        reportada: {{ resena.reportada|yesno:"true,false" }},
        url_responder: "{% url 'responder_resena' resena.id %}",
        url_reportar: "{% url 'reportar_resena' resena.id %}"
    },
    {% endfor %}
];

let resenaSeleccionada = null;

// Funci√≥n para mostrar rese√±a en el detalle
function mostrarResena(index) {
    if (index < 0 || index >= resenasData.length) return;
    
    resenaSeleccionada = resenasData[index];
    const template = document.getElementById('template-resena').innerHTML;
    const detalleDiv = document.getElementById('detalle-resena');
    
    detalleDiv.innerHTML = template;
    
    // Llenar datos b√°sicos
    document.getElementById('detalle-cliente').textContent = resenaSeleccionada.cliente;
    document.getElementById('detalle-fecha').textContent = resenaSeleccionada.fecha;
    document.getElementById('detalle-comentario').textContent = resenaSeleccionada.comentario;
    document.getElementById('detalle-id').textContent = resenaSeleccionada.id;
    
    // Avatar
    const avatarInicial = document.getElementById('detalle-avatar-inicial');
    avatarInicial.textContent = resenaSeleccionada.cliente.charAt(0).toUpperCase();
    
    // Estrellas
    let estrellasHtml = '';
    for (let i = 1; i <= 5; i++) {
        if (i <= resenaSeleccionada.calificacion) {
            estrellasHtml += '<i class="fas fa-star text-warning"></i>';
        } else {
            estrellasHtml += '<i class="far fa-star text-warning"></i>';
        }
    }
    document.getElementById('detalle-estrellas').innerHTML = estrellasHtml;
    document.getElementById('detalle-calificacion-numero').textContent = resenaSeleccionada.calificacion;
    
    // Badge de estado
    const estadoBadge = document.getElementById('detalle-estado-badge');
    if (resenaSeleccionada.reportada) {
        estadoBadge.className = 'badge bg-danger';
        estadoBadge.innerHTML = '<i class="fas fa-flag me-1"></i>Reportada';
    } else if (resenaSeleccionada.tiene_respuesta) {
        estadoBadge.className = 'badge bg-success';
        estadoBadge.innerHTML = '<i class="fas fa-check-circle me-1"></i>Respondida';
    } else {
        estadoBadge.className = 'badge bg-warning';
        estadoBadge.innerHTML = '<i class="fas fa-clock me-1"></i>Pendiente';
    }
    
    // Badge de calificaci√≥n
    const badge = document.getElementById('calificacion-badge');
    if (resenaSeleccionada.calificacion >= 4) {
        badge.style.background = 'linear-gradient(135deg, #D1FAE5, #A7F3D0)';
        badge.style.color = '#065F46';
    } else if (resenaSeleccionada.calificacion >= 3) {
        badge.style.background = 'linear-gradient(135deg, #FEF3C7, #FDE68A)';
        badge.style.color = '#92400E';
    } else {
        badge.style.background = 'linear-gradient(135deg, #FEE2E2, #FECACA)';
        badge.style.color = '#DC2626';
    }
    
    // Configurar respuesta existente
    const respuestaDiv = document.getElementById('respuesta-existente');
    const form = document.getElementById('form-respuesta');
    const textarea = document.getElementById('textarea-respuesta');
    const contador = document.getElementById('contador-caracteres');
    const tituloFormulario = document.getElementById('titulo-formulario');
    
    if (resenaSeleccionada.tiene_respuesta) {
        respuestaDiv.style.display = 'block';
        document.getElementById('texto-respuesta').textContent = resenaSeleccionada.respuesta;
        document.getElementById('fecha-respuesta').textContent = resenaSeleccionada.fecha_respuesta || resenaSeleccionada.fecha;
        
        // Cambiar texto del formulario para edici√≥n
        tituloFormulario.textContent = 'Editar Respuesta';
        document.getElementById('texto-boton-respuesta').textContent = 'Actualizar Respuesta';
        textarea.value = resenaSeleccionada.respuesta;
    } else {
        respuestaDiv.style.display = 'none';
        tituloFormulario.textContent = 'Responder a la Rese√±a';
        document.getElementById('texto-boton-respuesta').textContent = 'Publicar Respuesta';
        textarea.value = '';
    }
    
    // Actualizar contador de caracteres
    contador.textContent = textarea.value.length;
    textarea.addEventListener('input', function() {
        contador.textContent = this.value.length;
    });
    
    // Mostrar mensaje de reporte si est√° reportada
    const mensajeReporte = document.getElementById('estado-reportada-mensaje');
    if (resenaSeleccionada.reportada) {
        mensajeReporte.style.display = 'block';
    } else {
        mensajeReporte.style.display = 'none';
    }
    
    // Actualizar action del formulario
    form.action = resenaSeleccionada.url_responder;
    
    // Configurar bot√≥n cancelar
    document.getElementById('btn-cancelar-respuesta').addEventListener('click', function() {
        textarea.value = resenaSeleccionada.respuesta || '';
        contador.textContent = textarea.value.length;
    });
    
    // Resaltar item seleccionado
    document.querySelectorAll('.resena-item').forEach(item => {
        item.classList.remove('activa');
    });
    
    // Encontrar y resaltar el item correcto
    const items = document.querySelectorAll('.resena-item');
    if (items[index]) {
        items[index].classList.add('activa');
        items[index].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// Funci√≥n para mostrar modal de reporte
function mostrarModalReportar() {
    if (!resenaSeleccionada) {
        mostrarNotificacion('Por favor selecciona una rese√±a primero', 'warning');
        return;
    }
    
    // Mostrar preview de la rese√±a
    const preview = document.getElementById('preview-resena-reportar');
    preview.innerHTML = `
        <div class="preview-resena">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <strong>${resenaSeleccionada.cliente}</strong>
                <span class="badge bg-warning">${resenaSeleccionada.calificacion}/5</span>
            </div>
            <p class="mb-0 text-muted">
                "${resenaSeleccionada.comentario.substring(0, 120)}${resenaSeleccionada.comentario.length > 120 ? '...' : ''}"
            </p>
        </div>
    `;
    
    document.getElementById('resena_id_reportar').value = resenaSeleccionada.id;
    document.getElementById('motivo_reporte').value = '';
    document.getElementById('descripcion_reporte').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('modalReportar'));
    modal.show();
}

// Funci√≥n para enviar reporte
function enviarReporte() {
    const form = document.getElementById('form-reportar');
    const formData = new FormData(form);
    
    fetch(resenaSeleccionada.url_reportar, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalReportar'));
            modal.hide();
            
            // Mostrar notificaci√≥n
            mostrarNotificacion('‚úÖ Reporte enviado correctamente', 'success');
            
            // Recargar despu√©s de 1.5 segundos
            setTimeout(() => location.reload(), 1500);
        } else {
            mostrarNotificacion('‚ùå Error al enviar el reporte: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarNotificacion('‚ùå Error al enviar el reporte', 'error');
    });
}

// Funci√≥n para filtrar rese√±as
function filtrarResenas() {
    const filtroCalificacion = document.getElementById('filtro-calificacion').value;
    const filtroEstado = document.getElementById('filtro-estado').value;
    const filtroOrden = document.getElementById('filtro-orden').value;
    const busqueda = document.getElementById('buscador-resenas').value.toLowerCase();
    
    let resenasFiltradas = resenasData;
    
    // Filtrar por calificaci√≥n
    if (filtroCalificacion !== 'todas') {
        resenasFiltradas = resenasFiltradas.filter(resena => 
            resena.calificacion == parseInt(filtroCalificacion)
        );
    }
    
    // Filtrar por estado
    if (filtroEstado !== 'todas') {
        if (filtroEstado === 'pendiente') {
            resenasFiltradas = resenasFiltradas.filter(resena => 
                !resena.tiene_respuesta && !resena.reportada
            );
        } else if (filtroEstado === 'respondida') {
            resenasFiltradas = resenasFiltradas.filter(resena => 
                resena.tiene_respuesta && !resena.reportada
            );
        } else if (filtroEstado === 'reportada') {
            resenasFiltradas = resenasFiltradas.filter(resena => 
                resena.reportada
            );
        }
    }
    
    // Filtrar por b√∫squeda
    if (busqueda) {
        resenasFiltradas = resenasFiltradas.filter(resena => 
            resena.cliente.toLowerCase().includes(busqueda) || 
            resena.comentario.toLowerCase().includes(busqueda)
        );
    }
    
    // Ordenar
    if (filtroOrden === 'reciente') {
        resenasFiltradas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    } else if (filtroOrden === 'antiguo') {
        resenasFiltradas.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    } else if (filtroOrden === 'mejor') {
        resenasFiltradas.sort((a, b) => b.calificacion - a.calificacion);
    } else if (filtroOrden === 'peor') {
        resenasFiltradas.sort((a, b) => a.calificacion - b.calificacion);
    }
    
    // Actualizar contador
    const contador = document.getElementById('contador-filtrado');
    contador.textContent = resenasFiltradas.length;
    
    // Actualizar lista HTML
    const listaHtml = document.getElementById('lista-resenas');
    const items = document.querySelectorAll('.resena-item');
    
    // Ocultar/mostrar elementos seg√∫n filtros
    items.forEach((item, index) => {
        const resena = resenasData[index];
        const mostrar = resenasFiltradas.includes(resena);
        item.style.display = mostrar ? 'flex' : 'none';
        item.style.flexDirection = 'column';
    });
}

// Funci√≥n para mostrar notificaciones
function mostrarNotificacion(mensaje, tipo = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[tipo] || 'alert-info';

    const notificacionHTML = `
        <div class="notificacion-flotante alert ${alertClass} alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'times-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                <span>${mensaje}</span>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        </div>
    `;
    
    // Eliminar notificaciones anteriores
    document.querySelectorAll('.notificacion-flotante').forEach(el => el.remove());
    
    // Agregar nueva notificaci√≥n
    document.body.insertAdjacentHTML('beforeend', notificacionHTML);
    
    // Auto-eliminar despu√©s de 4 segundos
    setTimeout(() => {
        const alert = document.querySelector('.notificacion-flotante');
        if (alert) {
            alert.remove();
        }
    }, 4000);
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    // Configurar filtros
    document.getElementById('filtro-calificacion').addEventListener('change', filtrarResenas);
    document.getElementById('filtro-estado').addEventListener('change', filtrarResenas);
    document.getElementById('filtro-orden').addEventListener('change', filtrarResenas);
    document.getElementById('buscador-resenas').addEventListener('input', filtrarResenas);
    
    // Limpiar filtros
    document.getElementById('btn-limpiar-filtros').addEventListener('click', function() {
        document.getElementById('filtro-calificacion').value = 'todas';
        document.getElementById('filtro-estado').value = 'todas';
        document.getElementById('filtro-orden').value = 'reciente';
        document.getElementById('buscador-resenas').value = '';
        filtrarResenas();
    });
    
    // Exportar rese√±a
    document.getElementById('btn-exportar-resena').addEventListener('click', function() {
        if (!resenaSeleccionada) {
            mostrarNotificacion('Selecciona una rese√±a para exportar', 'warning');
            return;
        }
        
        const contenido = `
Rese√±a #${resenaSeleccionada.id}
Cliente: ${resenaSeleccionada.cliente}
Fecha: ${resenaSeleccionada.fecha}
Calificaci√≥n: ${resenaSeleccionada.calificacion}/5
Estado: ${resenaSeleccionada.reportada ? 'Reportada' : resenaSeleccionada.tiene_respuesta ? 'Respondida' : 'Pendiente'}
Comentario: ${resenaSeleccionada.comentario}
${resenaSeleccionada.respuesta ? `Respuesta: ${resenaSeleccionada.respuesta}` : 'Sin respuesta'}
        `;
        
        const blob = new Blob([contenido], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `resena-${resenaSeleccionada.id}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        mostrarNotificacion('‚úÖ Rese√±a exportada correctamente', 'success');
    });
    
    // Mostrar primera rese√±a si existe
    if (resenasData.length > 0) {
        mostrarResena(0);
    }
    
    // Inicializar filtros
    filtrarResenas();
});
</script>
{% endblock %}