<!-- templates/Vendedor/Dashboard_V.html -->
{% extends 'Layout_V.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'vendedor/css/Dashboard_V.css' %}">
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* Estilos adicionales para hacer el dashboard más compacto */
.dashboard-compact .card {
    margin-bottom: 1rem;
}

.dashboard-compact .card-header {
    padding: 0.75rem 1rem;
}

.dashboard-compact .card-body {
    padding: 1rem;
}

.dashboard-compact .list-group-item {
    padding: 0.75rem 1rem;
}

.dashboard-compact .table-sm td, 
.dashboard-compact .table-sm th {
    padding: 0.5rem 0.75rem;
}

/* Alturas fijas para contenedores con scroll */
.scroll-container {
    max-height: 300px;
    overflow-y: auto;
}

.scroll-container-sm {
    max-height: 200px;
    overflow-y: auto;
}

.scroll-container-lg {
    max-height: 400px;
    overflow-y: auto;
}

/* Estilos para las tarjetas de métricas más compactas */
.metric-card {
    height: 100%;
}

.metric-card .card-body {
    padding: 1rem;
}

.metric-icon {
    font-size: 1.5rem;
    opacity: 0.7;
}

/* Gráficos más compactos */
.compact-chart {
    height: 200px !important;
}

.medium-chart {
    height: 250px !important;
}

/* Mejoras visuales para scrollbars */
.scroll-container::-webkit-scrollbar {
    width: 6px;
}

.scroll-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.scroll-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.scroll-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid dashboard-compact">
    <!-- Encabezado compacto -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h4 mb-0 text-primary">Dashboard - {{ negocio_activo.nom_neg }}</h1>
                <div class="text-end">
                    <small class="text-muted">Actualizado: {% now "H:i" %}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas de Métricas Principales - Más compactas -->
    <div class="row">
        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
            <div class="card metric-card border-left-primary">
                <div class="card-body py-2">
                    <div class="row no-gutters align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Ventas Hoy
                            </div>
                            <div class="h6 mb-0 font-weight-bold text-gray-800">{{ ventas_hoy }}</div>
                            <div class="text-muted small">${{ total_ventas_hoy|floatformat:0 }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-cart metric-icon text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
            <div class="card metric-card border-left-success">
                <div class="card-body py-2">
                    <div class="row no-gutters align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Clientes
                            </div>
                            <div class="h6 mb-0 font-weight-bold text-gray-800">{{ clientes_activos }}</div>
                            <div class="text-muted small">+{{ crecimiento_clientes }}%</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users metric-icon text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
            <div class="card metric-card border-left-warning">
                <div class="card-body py-2">
                    <div class="row no-gutters align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Productos
                            </div>
                            <div class="h6 mb-0 font-weight-bold text-gray-800">{{ total_productos }}</div>
                            <div class="text-muted small">{{ productos_stock_bajo }} bajos</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-box metric-icon text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
            <div class="card metric-card border-left-info">
                <div class="card-body py-2">
                    <div class="row no-gutters align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Ingresos Mes
                            </div>
                            <div class="h6 mb-0 font-weight-bold text-gray-800">${{ ingresos_mensuales|floatformat:0 }}</div>
                            <div class="text-muted small">{{ crecimiento_ingresos }}%</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign metric-icon text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
            <div class="card metric-card border-left-secondary">
                <div class="card-body py-2">
                    <div class="row no-gutters align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                                Pedidos Activos
                            </div>
                            <div class="h6 mb-0 font-weight-bold text-gray-800">{{ pedidos_activos }}</div>
                            <div class="text-muted small">{{ pedidos_pendientes }} pendientes</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-list metric-icon text-secondary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
            <div class="card metric-card border-left-danger">
                <div class="card-body py-2">
                    <div class="row no-gutters align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Stock Bajo
                            </div>
                            <div class="h6 mb-0 font-weight-bold text-gray-800">{{ productos_stock_bajo }}</div>
                            <div class="text-muted small">de {{ total_productos }} productos</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle metric-icon text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Primera Fila: Gráficos Principales -->
    <div class="row">
        <!-- Gráfico de Ventas -->
        <div class="col-xl-6 col-lg-6 mb-3">
            <div class="card tarjeta-dashboard h-100">
                <div class="card-header bg-white py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-chart-line me-1"></i>Ventas 7 Días
                        </h6>
                        <small class="text-muted">Total: ${{ total_ventas_semana|floatformat:0 }}</small>
                    </div>
                </div>
                <div class="card-body p-2">
                    <div class="chart-container">
                        <canvas id="ventasChart" class="compact-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico de Categorías -->
        <div class="col-xl-6 col-lg-6 mb-3">
            <div class="card tarjeta-dashboard h-100">
                <div class="card-header bg-white py-2">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-chart-bar me-1"></i>Ventas por Categoría
                    </h6>
                </div>
                <div class="card-body p-2">
                    <div class="chart-container">
                        <canvas id="categoriasChart" class="compact-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda Fila: Gráficos Secundarios y Listas -->
    <div class="row">
        <!-- Estado de Pedidos -->
        <div class="col-xl-4 col-lg-4 mb-3">
            <div class="card tarjeta-dashboard h-100">
                <div class="card-header bg-white py-2">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-clipboard-check me-1"></i>Estado de Pedidos
                    </h6>
                </div>
                <div class="card-body p-2">
                    <div class="chart-container">
                        <canvas id="pedidosChart" class="compact-chart"></canvas>
                    </div>
                    <div class="row text-center mt-2">
                        <div class="col-4">
                            <div class="h6 mb-0 text-primary">{{ pedidos_pendientes }}</div>
                            <small class="text-muted">Pendientes</small>
                        </div>
                        <div class="col-4">
                            <div class="h6 mb-0 text-warning">{{ pedidos_proceso }}</div>
                            <small class="text-muted">En Proceso</small>
                        </div>
                        <div class="col-4">
                            <div class="h6 mb-0 text-success">{{ pedidos_completados }}</div>
                            <small class="text-muted">Completados</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Productos Destacados -->
        <div class="col-xl-4 col-lg-4 mb-3">
            <div class="card tarjeta-dashboard h-100">
                <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-star me-1"></i>Productos Destacados
                    </h6>
                    <a href="{% url 'Crud_V' %}" class="btn btn-sm btn-outline-primary py-0">Ver todos</a>
                </div>
                <div class="card-body p-0">
                    <div class="scroll-container-sm">
                        <div class="list-group list-group-flush">
                            {% for producto in productos_destacados %}
                            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <div class="d-flex align-items-center">
                                    {% if producto.img_prod %}
                                    <img src="{{ producto.img_prod.url }}" alt="{{ producto.nom_prod }}" 
                                         class="img-thumbnail me-2" style="width: 35px; height: 35px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-light rounded me-2 d-flex align-items-center justify-content-center" 
                                         style="width: 35px; height: 35px;">
                                        <i class="fas fa-box text-muted"></i>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div class="fw-bold small">{{ producto.nom_prod|truncatechars:20 }}</div>
                                        <small class="text-muted">${{ producto.precio_prod|floatformat:0 }}</small>
                                    </div>
                                </div>
                                <span class="badge {% if producto.stock_prod > 5 %}bg-success{% else %}bg-warning text-dark{% endif %}">
                                    {{ producto.stock_prod }}
                                </span>
                            </div>
                            {% empty %}
                            <div class="list-group-item text-center text-muted py-3">
                                <i class="fas fa-box fa-lg mb-2"></i>
                                <p class="small mb-0">No hay productos destacados</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pedidos Recientes -->
        <div class="col-xl-4 col-lg-4 mb-3">
            <div class="card tarjeta-dashboard h-100">
                <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-clock me-1"></i>Pedidos Recientes
                    </h6>
                    <a href="{% url 'gestionar_ventas' %}" class="btn btn-sm btn-outline-primary py-0">Ver todos</a>
                </div>
                <div class="card-body p-0">
                    <div class="scroll-container-sm">
                        <div class="list-group list-group-flush">
                            {% for pedido in pedidos_recientes %}
                            <div class="list-group-item py-2">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <div>
                                        <strong class="small">#{{ pedido.id }}</strong>
                                        <div class="text-muted small">
                                            {{ pedido.cliente_nombre|truncatechars:15 }}
                                        </div>
                                    </div>
                                    <span class="badge 
                                        {% if pedido.estado == 'pendiente' %}bg-warning
                                        {% elif pedido.estado == 'confirmado' %}bg-info
                                        {% elif pedido.estado == 'preparando' %}bg-primary
                                        {% elif pedido.estado == 'enviado' %}bg-secondary
                                        {% elif pedido.estado == 'entregado' %}bg-success
                                        {% else %}bg-danger{% endif %} small">
                                        {{ pedido.estado|title }}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">${{ pedido.total|floatformat:0 }}</small>
                                    <small class="text-muted">{{ pedido.fecha_creacion|timesince }}</small>
                                </div>
                            </div>
                            {% empty %}
                            <div class="list-group-item text-center text-muted py-3">
                                <i class="fas fa-shopping-bag fa-lg mb-2"></i>
                                <p class="small mb-0">No hay pedidos recientes</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tercera Fila: Inventario y Actividad -->
    <div class="row">
        <!-- Estado de Inventario -->
        <div class="col-xl-4 col-lg-4 mb-3">
            <div class="card tarjeta-dashboard h-100">
                <div class="card-header bg-white py-2">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-boxes me-1"></i>Estado de Inventario
                    </h6>
                </div>
                <div class="card-body p-2">
                    <div class="chart-container">
                        <canvas id="inventarioChart" class="compact-chart"></canvas>
                    </div>
                    <div class="mt-2">
                        <div class="d-flex justify-content-between mb-1 small">
                            <span class="text-muted">Disponibles</span>
                            <span class="font-weight-bold">{{ productos_disponibles }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-1 small">
                            <span class="text-muted">Stock Bajo</span>
                            <span class="font-weight-bold text-warning">{{ productos_stock_bajo }}</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">Sin Stock</span>
                            <span class="font-weight-bold text-danger">{{ productos_sin_stock }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actividad Reciente -->
        <div class="col-xl-8 col-lg-8 mb-3">
            <div class="card tarjeta-dashboard h-100">
                <div class="card-header bg-white py-2">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-history me-1"></i>Actividad Reciente
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="scroll-container">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="small">Fecha</th>
                                        <th class="small">Tipo</th>
                                        <th class="small">Descripción</th>
                                        <th class="small">Usuario</th>
                                        <th class="small text-end">Cantidad</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for movimiento in movimientos_recientes %}
                                    <tr>
                                        <td class="text-nowrap small">{{ movimiento.fecha|date:"H:i" }}</td>
                                        <td>
                                            <span class="badge small
                                                {% if movimiento.tipo == 'entrada' %}bg-success
                                                {% elif movimiento.tipo == 'salida' %}bg-danger
                                                {% else %}bg-warning{% endif %}">
                                                {{ movimiento.tipo|title }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="fw-bold small">{{ movimiento.producto|truncatechars:25 }}</div>
                                            <small class="text-muted">{{ movimiento.motivo|truncatechars:30 }}</small>
                                        </td>
                                        <td class="small">{{ movimiento.usuario|truncatechars:15 }}</td>
                                        <td class="text-end">
                                            <span class="badge bg-info small">{{ movimiento.cantidad }}</span>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-3 small">
                                            No hay actividad reciente
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Datos para los gráficos
const datosDashboard = {
    ventasUltimosDias: {
        labels: {{ ventas_labels|safe }},
        datos: {{ ventas_data|safe }}
    },
    inventario: {
        disponibles: {{ productos_disponibles }},
        stockBajo: {{ productos_stock_bajo }},
        sinStock: {{ productos_sin_stock }}
    },
    categorias: {
        labels: {{ categorias_labels|safe }},
        datos: {{ categorias_data|safe }}
    },
    pedidos: {
        pendientes: {{ pedidos_pendientes }},
        proceso: {{ pedidos_proceso }},
        completados: {{ pedidos_completados }}
    }
};

// Inicializar gráficos cuando el documento esté listo
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de Ventas por Día (Línea)
    const ventasCtx = document.getElementById('ventasChart').getContext('2d');
    new Chart(ventasCtx, {
        type: 'line',
        data: {
            labels: datosDashboard.ventasUltimosDias.labels,
            datasets: [{
                label: 'Ventas ($)',
                data: datosDashboard.ventasUltimosDias.datos,
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Gráfico de Estado de Inventario (Barra)
    const inventarioCtx = document.getElementById('inventarioChart').getContext('2d');
    new Chart(inventarioCtx, {
        type: 'bar',
        data: {
            labels: ['Disponibles', 'Stock Bajo', 'Sin Stock'],
            datasets: [{
                data: [
                    datosDashboard.inventario.disponibles,
                    datosDashboard.inventario.stockBajo,
                    datosDashboard.inventario.sinStock
                ],
                backgroundColor: [
                    '#1cc88a',
                    '#f6c23e',
                    '#e74a3b'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Gráfico de Ventas por Categoría (Barra Horizontal)
    const categoriasCtx = document.getElementById('categoriasChart').getContext('2d');
    new Chart(categoriasCtx, {
        type: 'bar',
        data: {
            labels: datosDashboard.categorias.labels,
            datasets: [{
                label: 'Ventas ($)',
                data: datosDashboard.categorias.datos,
                backgroundColor: [
                    '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', 
                    '#e74a3b', '#858796', '#5a5c69', '#6f42c1'
                ],
                borderWidth: 0
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Gráfico de Estado de Pedidos (Doughnut)
    const pedidosCtx = document.getElementById('pedidosChart').getContext('2d');
    new Chart(pedidosCtx, {
        type: 'doughnut',
        data: {
            labels: ['Pendientes', 'En Proceso', 'Completados'],
            datasets: [{
                data: [
                    datosDashboard.pedidos.pendientes,
                    datosDashboard.pedidos.proceso,
                    datosDashboard.pedidos.completados
                ],
                backgroundColor: [
                    '#4e73df',
                    '#f6c23e',
                    '#1cc88a'
                ],
                hoverBackgroundColor: [
                    '#2e59d9',
                    '#d4a017',
                    '#17a673'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
});
</script>
{% endblock %}