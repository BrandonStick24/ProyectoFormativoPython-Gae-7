{% extends 'base.html' %}
{% load static %}

{% block title %}{{ negocio.nom_neg }} - VECY{% endblock %}

{% block extra_css %}
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="{% static 'cliente/css/detalle_neg.css' %}">
{% endblock %}

{% block content %}
<!-- Hero Section 칄lite -->
<section class="business-hero-section">
    <div class="container">
        <div class="row align-items-center min-vh-50">
            <div class="col-lg-8">
                <div class="business-hero-content" data-aos="fade-right">
                    <!-- Header Principal -->
                    <div class="d-flex align-items-center flex-wrap gap-3 mb-4">
                        <h1 class="display-4 fw-bold mb-0 text-dark">{{ negocio.nom_neg }}</h1>
                        <span class="business-verified-badge">
                            <i class="fas fa-check me-2"></i>Negocio Verificado
                        </span>
                    </div>
                    
                    <!-- Categor칤a -->
                    <div class="category-tag mb-4">
                        <span class="badge-vecy">
                            <i class="fas fa-tag me-2"></i>{{ tipo_negocio.desc_tiponeg }}
                        </span>
                    </div>

                    <!-- Estad칤sticas Destacadas -->
                    <div class="business-stats-grid">
                        <!-- Rating -->
                        <div class="business-stat-card" data-aos="zoom-in" data-aos-delay="100">
                            <span class="business-stat-number">{{ promedio_calificacion|floatformat:1 }}</span>
                            <div class="business-stat-label">
                                <div class="stars text-warning mb-2">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= promedio_calificacion %}
                                            <i class="fas fa-star"></i>
                                        {% elif forloop.counter <= promedio_calificacion|add:0.5 %}
                                            <i class="fas fa-star-half-alt"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {{ total_resenas }} Rese침as
                            </div>
                        </div>

                        <!-- Productos -->
                        <div class="business-stat-card" data-aos="zoom-in" data-aos-delay="200">
                            <span class="business-stat-number">{{ productos.count }}</span>
                            <div class="business-stat-label">
                                <i class="fas fa-box-open me-2"></i>Productos
                            </div>
                        </div>

                        <!-- Experiencia -->
                        <div class="business-stat-card" data-aos="zoom-in" data-aos-delay="300">
                            <span class="business-stat-number">100%</span>
                            <div class="business-stat-label">
                                <i class="fas fa-award me-2"></i>Confianza
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Imagen del Negocio -->
            <div class="col-lg-4">
                <div class="business-hero-image" data-aos="fade-left" data-aos-delay="400">
                    {% if negocio.img_neg %}
                        <img src="{{ negocio.img_neg.url }}" alt="{{ negocio.nom_neg }}" 
                             class="img-fluid w-100" style="height: 320px; object-fit: cover;">
                    {% else %}
                        <div class="bg-gradient-primary text-white p-5 text-center h-100 d-flex align-items-center justify-content-center rounded-3">
                            <div>
                                <i class="fas fa-store fa-4x mb-3"></i>
                                <h3 class="fw-bold mb-0">{{ negocio.nom_neg }}</h3>
                                <p class="mb-0 opacity-80">{{ tipo_negocio.desc_tiponeg }}</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Contenido Principal -->
<div class="container py-5">
    <div class="row">
        <!-- Columna Principal -->
        <div class="col-lg-8">
            <!-- Descripci칩n del Negocio -->
            {% if negocio.desc_neg %}
            <section class="business-contact-card mb-5" data-aos="fade-up">
                <div class="d-flex align-items-center mb-4">
                    <i class="fas fa-info-circle fa-2x text-primary me-3"></i>
                    <h3 class="section-title mb-0">Sobre Nosotros</h3>
                </div>
                <p class="lead text-muted lh-lg mb-0">{{ negocio.desc_neg }}</p>
            </section>
            {% endif %}

            <!-- Cat치logo de Productos -->
            <section class="mb-5" data-aos="fade-up">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-boxes fa-2x text-primary me-3"></i>
                        <h3 class="section-title mb-0">Cat치logo de Productos</h3>
                    </div>
                    <span class="badge-vecy">{{ productos.count }} productos</span>
                </div>

                {% if productos %}
                <div class="product-grid-vecy">
                    {% for producto in productos %}
                    <article class="product-card-vecy" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:1 }}00">
                        <div class="product-image-vecy">
                            {% if producto.img_prod %}
                                <img src="{{ producto.img_prod.url }}" alt="{{ producto.nom_prod }}" 
                                     class="w-100 h-100">
                            {% else %}
                                <div class="w-100 h-100 bg-gradient-light d-flex align-items-center justify-content-center">
                                    <div class="text-center">
                                        <i class="fas fa-image fa-3x text-muted mb-3"></i>
                                        <p class="text-muted small mb-0">Imagen no disponible</p>
                                    </div>
                                </div>
                            {% endif %}
                            
                            <!-- Badge de Estado -->
                            <span class="product-badge-vecy {% if producto.stock_prod == 0 %}product-badge-out-of-stock{% endif %}">
                                {% if producto.stock_prod > 0 %}
                                    <i class="fas fa-check me-1"></i>Disponible
                                {% else %}
                                    <i class="fas fa-times me-1"></i>Agotado
                                {% endif %}
                            </span>
                        </div>
                        
                        <div class="product-info-vecy">
                            <!-- Informaci칩n del Producto -->
                            <h4 class="product-title-vecy">{{ producto.nom_prod }}</h4>
                            
                            {% if producto.desc_prod %}
                            <p class="product-description-vecy">{{ producto.desc_prod }}</p>
                            {% endif %}
                            
                            <!-- Categor칤a -->
                            <span class="product-category-vecy">
                                <i class="fas fa-tag me-1"></i>{{ producto.fkcategoria_prod.desc_cp }}
                            </span>
                            
                            <!-- Precio -->
                            <div class="product-price-vecy">
                                ${{ producto.precio_prod|floatformat:0 }}
                            </div>
                            
                            <!-- Stock -->
                            <div class="stock-info mb-3">
                                <small class="text-muted d-flex align-items-center">
                                    <i class="fas fa-box me-2"></i>
                                    {% if producto.stock_prod > 0 %}
                                        <strong class="text-success">{{ producto.stock_prod }}</strong> unidades disponibles
                                    {% else %}
                                        <strong class="text-danger">Producto agotado</strong>
                                    {% endif %}
                                </small>
                            </div>
                            
                            <!-- Acci칩n -->
                            {% if producto.stock_prod > 0 %}
                            <button class="add-to-cart-btn-vecy" onclick="showLoginAlert()">
                                <i class="fas fa-cart-plus"></i>
                                Agregar al Carrito
                            </button>
                            {% else %}
                            <button class="add-to-cart-btn-vecy" disabled>
                                <i class="fas fa-clock"></i>
                                Pr칩ximamente
                            </button>
                            {% endif %}
                        </div>
                    </article>
                    {% endfor %}
                </div>
                {% else %}
                <!-- Estado Vac칤o Productos -->
                <div class="empty-state-vecy" data-aos="fade-up">
                    <div class="empty-state-content">
                        <div class="empty-state-icon">
                            <i class="fas fa-box-open"></i>
                        </div>
                        <h4 class="text-muted mb-3">Cat치logo Vac칤o</h4>
                        <p class="text-muted mb-4">Este negocio est치 preparando sus productos. Vuelve pronto para descubrir su oferta.</p>
                        <button class="btn-vecy-primary" onclick="showNotification('Te notificaremos cuando haya productos')">
                            <i class="fas fa-bell me-2"></i>Notificarme
                        </button>
                    </div>
                </div>
                {% endif %}
            </section>

            <!-- Rese침as y Opiniones -->
            <section class="mb-5" data-aos="fade-up">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-star fa-2x text-warning me-3"></i>
                        <h3 class="section-title mb-0">Opiniones de Clientes</h3>
                    </div>
                    <button class="btn-vecy-primary" onclick="showLoginAlert()">
                        <i class="fas fa-edit me-2"></i>Escribir Rese침a
                    </button>
                </div>

                {% if resenas %}
                    {% for resena in resenas %}
                    <article class="review-card-vecy" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:1 }}00">
                        <!-- Header Rese침a -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-3">
                                    <div class="contact-icon">
                                        <i class="fas fa-user"></i>
                                    </div>
                                </div>
                                <div>
                                    <h6 class="mb-1 fw-bold">{{ resena.fkusuario_resena.fkuser.first_name }} {{ resena.fkusuario_resena.fkuser.last_name }}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ resena.fecha_resena|date:"d M Y" }}
                                    </small>
                                </div>
                            </div>
                            <div class="stars text-warning">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= resena.estrellas %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Comentario -->
                        {% if resena.comentario %}
                        <p class="mb-0 text-dark lh-lg">{{ resena.comentario }}</p>
                        {% else %}
                        <p class="text-muted mb-0 fst-italic">
                            <i class="fas fa-comment-slash me-2"></i>El cliente no dej칩 un comentario
                        </p>
                        {% endif %}
                        
                        <!-- Respuesta del Vendedor -->
                        {% if resena.respuesta_vendedor %}
                        <div class="vendor-response">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-store text-success me-2"></i>
                                <strong class="text-success">Respuesta del Propietario</strong>
                                <small class="text-muted ms-2">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ resena.fecha_respuesta|date:"d M Y" }}
                                </small>
                            </div>
                            <p class="mb-0 text-dark">{{ resena.respuesta_vendedor }}</p>
                        </div>
                        {% endif %}
                    </article>
                    {% endfor %}
                {% else %}
                <!-- Estado Vac칤o Rese침as -->
                <div class="empty-state-vecy" data-aos="fade-up">
                    <div class="empty-state-content">
                        <div class="empty-state-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <h4 class="text-muted mb-3">Sin Opiniones Todav칤a</h4>
                        <p class="text-muted mb-4">S칠 el primero en compartir tu experiencia con este negocio.</p>
                        <button class="btn-vecy-primary" onclick="showLoginAlert()">
                            <i class="fas fa-edit me-2"></i>Escribir Primera Rese침a
                        </button>
                    </div>
                </div>
                {% endif %}
            </section>
        </div>

        <!-- Sidebar Informaci칩n -->
        <div class="col-lg-4">
            <!-- Informaci칩n de Contacto -->
            <section class="business-contact-card mb-4" data-aos="fade-left">
                <div class="d-flex align-items-center mb-4">
                    <i class="fas fa-address-card fa-2x text-primary me-3"></i>
                    <h4 class="section-title mb-0">Informaci칩n de Contacto</h4>
                </div>
                
                <!-- Direcci칩n -->
                <div class="contact-item">
                    <div class="contact-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div>
                        <strong class="d-block mb-1">Ubicaci칩n</strong>
                        <p class="mb-0 text-muted">{{ negocio.direcc_neg }}</p>
                    </div>
                </div>

                <!-- NIT -->
                <div class="contact-item">
                    <div class="contact-icon">
                        <i class="fas fa-id-card"></i>
                    </div>
                    <div>
                        <strong class="d-block mb-1">NIT Empresarial</strong>
                        <p class="mb-0 text-muted">{{ negocio.nit_neg }}</p>
                    </div>
                </div>

                <!-- Propietario -->
                <div class="contact-item">
                    <div class="contact-icon">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div>
                        <strong class="d-block mb-1">Propietario</strong>
                        <p class="mb-0 text-muted">{{ propietario.fkuser.first_name }} {{ propietario.fkuser.last_name }}</p>
                    </div>
                </div>

                <!-- Contacto -->
                <div class="contact-item">
                    <div class="contact-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div>
                        <strong class="d-block mb-1">Email de Contacto</strong>
                        <p class="mb-0 text-muted">{{ propietario.fkuser.email }}</p>
                    </div>
                </div>

                <!-- Horario -->
                <div class="contact-item">
                    <div class="contact-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <strong class="d-block mb-1">Horario de Atenci칩n</strong>
                        <p class="mb-0 text-muted">Lun - Vie: 8:00 AM - 6:00 PM</p>
                    </div>
                </div>
            </section>

            <!-- Mapa de Ubicaci칩n -->
            <section class="business-contact-card mb-4" data-aos="fade-left" data-aos-delay="200">
                <div class="d-flex align-items-center mb-4">
                    <i class="fas fa-map-marked-alt fa-2x text-primary me-3"></i>
                    <h4 class="section-title mb-0">Ubicaci칩n Exacta</h4>
                </div>
                
                <div class="map-container-vecy">
                    <div id="leaflet-map"></div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn-vecy-outline w-100" onclick="openInOpenStreetMap()">
                        <i class="fas fa-external-link-alt me-2"></i>
                        Abrir en Google Maps
                    </button>
                </div>
            </section>

            <!-- Acciones R치pidas -->
            <section class="business-contact-card" data-aos="fade-left" data-aos-delay="300">
                <div class="d-flex align-items-center mb-4">
                    <i class="fas fa-bolt fa-2x text-warning me-3"></i>
                    <h4 class="section-title mb-0">Acciones R치pidas</h4>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn-vecy-primary" onclick="showLoginAlert()">
                        <i class="fas fa-shopping-cart me-2"></i>Realizar Pedido
                    </button>
                    <button class="btn-vecy-outline" onclick="showLoginAlert()">
                        <i class="fas fa-comment me-2"></i>Contactar al Vendedor
                    </button>
                    <button class="btn-vecy-outline" onclick="showLoginAlert()">
                        <i class="fas fa-share-alt me-2"></i>Compartir Negocio
                    </button>
                </div>
            </section>
        </div>
    </div>
</div>

<!-- Navegaci칩n Inferior -->
<div class="container mb-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <a href="{% url 'principal' %}" class="btn-vecy-outline" data-aos="fade-right">
                    <i class="fas fa-arrow-left me-2"></i>Volver a Negocios
                </a>
                
                <div class="d-flex gap-2" data-aos="fade-left">
                    <button class="btn-vecy-outline" onclick="scrollToTop()">
                        <i class="fas fa-arrow-up me-2"></i>Ir Arriba
                    </button>
                    <button class="btn-vecy-primary" onclick="showLoginAlert()">
                        <i class="fas fa-heart me-2"></i>Guardar Favorito
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- AOS Animation -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Leaflet Maps -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Inicializar AOS
    AOS.init({
        duration: 800,
        once: true,
        offset: 50
    });

    // Mapa Leaflet Profesional
    function initMap() {
        const address = "{{ negocio.direcc_neg }}";
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    
                    // Mapa con configuraci칩n profesional
                    const map = L.map('leaflet-map', {
                        zoomControl: true,
                        scrollWheelZoom: true,
                        dragging: true,
                        tap: true
                    }).setView([lat, lon], 16);
                    
                    // Tile layer con estilo mejorado
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '춸 OpenStreetMap contributors',
                        maxZoom: 19,
                        detectRetina: true
                    }).addTo(map);
                    
                    // Icono personalizado premium
                    const customIcon = L.divIcon({
                        html: `
                            <div style="
                                background: linear-gradient(135deg, #3598db 0%, #4aa8e8 100%);
                                width: 50px;
                                height: 50px;
                                border-radius: 50%;
                                border: 4px solid white;
                                box-shadow: 0 4px 20px rgba(53, 152, 219, 0.4);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 16px;
                                animation: pulse 2s infinite;
                            ">
                                <i class="fas fa-store"></i>
                            </div>
                            <style>
                                @keyframes pulse {
                                    0% { transform: scale(1); }
                                    50% { transform: scale(1.1); }
                                    100% { transform: scale(1); }
                                }
                            </style>
                        `,
                        className: 'leaflet-custom-icon',
                        iconSize: [50, 50],
                        iconAnchor: [25, 50],
                        popupAnchor: [0, -50]
                    });
                    
                    // Marcador con popup elegante
                    const marker = L.marker([lat, lon], {icon: customIcon}).addTo(map);
                    
                    const popupContent = `
                        <div style="min-width: 250px; padding: 12px;">
                            <div class="d-flex align-items-center mb-2">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3598db 0%, #4aa8e8 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; margin-right: 12px;">
                                    <i class="fas fa-store"></i>
                                </div>
                                <div>
                                    <h6 style="margin: 0; color: #3598db; font-weight: 700;">{{ negocio.nom_neg }}</h6>
                                    <small style="color: #7f8c8d;">{{ tipo_negocio.desc_tiponeg }}</small>
                                </div>
                            </div>
                            <p style="margin: 8px 0 0 0; color: #34495e; font-size: 13px; line-height: 1.4;">
                                <i class="fas fa-map-marker-alt me-2" style="color: #3598db;"></i>
                                {{ negocio.direcc_neg }}
                            </p>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent, {
                        className: 'custom-popup',
                        maxWidth: 300
                    }).openPopup();
                    
                } else {
                    showMapError();
                }
            })
            .catch(error => {
                console.error('Error cargando mapa:', error);
                showMapError();
            });
    }
    
    function showMapError() {
        document.getElementById('leaflet-map').innerHTML = `
            <div class="w-100 h-100 bg-gradient-light d-flex align-items-center justify-content-center">
                <div class="text-center p-4">
                    <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted mb-2">Ubicaci칩n no disponible</h5>
                    <p class="text-muted mb-3">No pudimos cargar la ubicaci칩n en este momento.</p>
                    <button class="btn-vecy-primary btn-sm" onclick="openInOpenStreetMap()">
                        <i class="fas fa-external-link-alt me-2"></i>Abrir en mapa externo
                    </button>
                </div>
            </div>
        `;
    }
    
    function openInOpenStreetMap() {
        const address = encodeURIComponent("{{ negocio.direcc_neg }}");
        window.open(`https://www.google.com/maps/search/?api=1&query=${address}`, '_blank');
    }
    
    // Alertas Profesionales
    function showLoginAlert() {
        Swal.fire({
            title: '游댏 Acceso Requerido',
            html: `
                <div class="text-center py-3">
                    <div class="icon-container mb-3">
                        <i class="fas fa-lock fa-4x text-primary mb-3"></i>
                    </div>
                    <h4 class="fw-bold text-dark mb-2">춰칔nete a la Comunidad VECY!</h4>
                    <p class="text-muted mb-4">Accede a todas las funciones premium y conecta con los mejores negocios locales.</p>
                    <div class="d-grid gap-2">
                        <a href="{% url 'iniciar_sesion' %}" class="btn btn-primary btn-lg py-3">
                            <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesi칩n
                        </a>
                        <a href="{% url 'registro_usuario' %}" class="btn btn-outline-primary py-3">
                            <i class="fas fa-user-plus me-2"></i>Crear Cuenta Gratis
                        </a>
                    </div>
                </div>
            `,
            showCloseButton: true,
            showConfirmButton: false,
            width: '420px',
            background: '#ffffff',
            customClass: {
                popup: 'rounded-4 border-0 shadow-lg'
            }
        });
    }
    
    function showNotification(message) {
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: message,
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            background: '#27ae60',
            color: 'white',
            iconColor: 'white'
        });
    }
    
    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Inicializar cuando cargue la p치gina
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        
        // Efectos de scroll suave
        const scrollElements = document.querySelectorAll('[data-aos]');
        
        // Agregar clase de carga inicial
        document.body.classList.add('loaded');
    });
</script>
{% endblock %}