{% extends 'base.html' %}
{% load static %}

{% block title %}VECY - {{ negocio.nom_neg }}{% endblock %}

{% block extra_css %}
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'cliente/css/detalle_neg_logeado.css' %}">
{% endblock %}

{% block content %}
<!-- Hero Section del Negocio -->
<section class="business-hero py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="hero-content text-white">
                    <div class="d-flex align-items-center mb-3">
                        {% if negocio.img_neg %}
                            <img src="{{ negocio.img_neg.url }}" alt="{{ negocio.nom_neg }}" class="hero-logo me-4">
                        {% else %}
                            <div class="hero-logo-placeholder me-4">
                                <i class="fas fa-store"></i>
                            </div>
                        {% endif %}
                        <div>
                            <h1 class="hero-title mb-1">{{ negocio.nom_neg }}</h1>
                            <div class="hero-category">{{ negocio.fktiponeg_neg.desc_tiponeg }}</div>
                        </div>
                    </div>
                    
                    <div class="hero-stats">
                        <div class="d-flex align-items-center">
                            <div class="stars me-3">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= estadisticas_resenas.promedio|default:0 %}
                                        <i class="fas fa-star"></i>
                                    {% elif forloop.counter <= estadisticas_resenas.promedio|default:0|add:0.5 %}
                                        <i class="fas fa-star-half-alt"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="me-4">{{ estadisticas_resenas.promedio|default:0|floatformat:1 }} ({{ estadisticas_resenas.total_resenas|default:0 }} rese√±as)</span>
                        </div>
                        <span><i class="fas fa-map-marker-alt me-1"></i> {{ negocio.direcc_neg }}</span>
                    </div>
                    
                    {% if negocio.desc_neg %}
                    <p class="hero-description">{{ negocio.desc_neg }}</p>
                    {% endif %}
                    
                    <div class="hero-actions">
                        <button class="vecy-btn-primary" onclick="seguirNegocio({{ negocio.pkid_neg }})">
                            <i class="far fa-heart me-1"></i> Seguir Negocio
                        </button>
                        <button class="vecy-btn-outline">
                            <i class="fas fa-share-alt me-1"></i> Compartir
                        </button>
                        <button class="vecy-btn-outline" onclick="abrirModalReporte('negocio', {{ negocio.pkid_neg }})">
                            <i class="fas fa-flag me-1"></i> Reportar
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-center">
                <div class="hero-badge">
                    <div class="badge-content">
                        <div class="badge-rating">{{ estadisticas_resenas.promedio|default:0|floatformat:1 }}</div>
                        <div class="stars mb-2">
                            {% for i in "12345" %}
                                {% if forloop.counter <= estadisticas_resenas.promedio|default:0 %}
                                    <i class="fas fa-star"></i>
                                {% elif forloop.counter <= estadisticas_resenas.promedio|default:0|add:0.5 %}
                                    <i class="fas fa-star-half-alt"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="badge-text">{{ estadisticas_resenas.total_resenas|default:0 }} rese√±as</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Secci√≥n de Productos -->
<section class="products-section">
    <div class="container">
        <div class="section-header mb-5">
            <h2 class="section-title">Productos Destacados</h2>
            <p class="section-subtitle">Descubre lo que este negocio tiene para ofrecerte</p>
        </div>
        
        {% if productos %}
        <div class="row g-4">
            {% for producto_data in productos %}
            {% with producto=producto_data.producto %}
            {% if producto_data.stock > 0 or producto_data.tiene_variantes %}

            <!-- COMPONENTE CON VARIANTES -->
            {% if producto_data.tiene_variantes and producto_data.variantes %}
            <div class="col-xl-3 col-lg-4 col-md-6">
                <div class="product-card-with-variants" data-aos="fade-up" 
                     data-aos-delay="{{ forloop.counter0|add:1 }}00"
                     data-product-id="{{ producto.pkid_prod }}">
                    
                    <div class="selection-indicator">
                        <i class="fas fa-check"></i>
                    </div>

                    <div class="product-image-container">
                        <img src="{% if producto.img_prod %}{{ producto.img_prod.url }}{% else %}https://via.placeholder.com/300x200/3598db/ffffff?text=VECY{% endif %}" 
                             alt="{{ producto.nom_prod }}" class="product-main-image" 
                             id="mainProductImage-{{ producto.pkid_prod }}">
                    </div>

                    <div class="product-info-container">
                        <div>
                            <h3 class="vecy-product-title" id="productTitle-{{ producto.pkid_prod }}">
                                {{ producto.nom_prod }}
                            </h3>

                            <div class="vecy-store-info">
                                <i class="fas fa-store"></i>
                                <span>{{ producto.fknegocioasociado_prod.nom_neg }}</span>
                            </div>

                            <div class="vecy-stock-info {% if producto_data.stock < 10 %}vecy-low-stock{% endif %}">
                                <i class="fas fa-box"></i>
                                <span id="stockInfo-{{ producto.pkid_prod }}">
                                    {% if producto_data.tiene_variantes %}
                                    M√∫ltiples opciones disponibles
                                    {% else %}
                                    {{ producto_data.stock }} disponibles
                                    {% endif %}
                                </span>
                            </div>

                            <div class="product-description">
                                <p class="product-description-text" id="description-{{ producto.pkid_prod }}">
                                    {{ producto.desc_prod|default:"Producto de alta calidad con m√∫ltiples opciones disponibles." }}
                                </p>
                            </div>

                            {% if producto_data.variantes %}
                            <div class="variants-container">
                                <div class="variants-label">
                                    <i class="fas fa-list-alt me-2"></i>
                                    Opciones disponibles:
                                </div>
                                <div class="variants-grid" id="variantsGrid-{{ producto.pkid_prod }}">
                                    <!-- JavaScript generar√° las miniaturas -->
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="product-price-section mt-3">
                            <div class="vecy-price-section">
                                <div class="vecy-price-main">
                                    <span class="vecy-current-price" id="price-{{ producto.pkid_prod }}">
                                        ${{ producto_data.precio_final|floatformat:0 }}
                                    </span>
                                    {% if producto_data.tiene_descuento %}
                                    <span class="vecy-original-price">${{ producto_data.precio_base|floatformat:0 }}</span>
                                    {% endif %}
                                </div>
                                {% if producto_data.tiene_descuento %}
                                <div class="vecy-savings-badge">
                                    Ahorras ${{ producto_data.ahorro|floatformat:0 }}
                                </div>
                                {% endif %}
                            </div>

                            <button class="vecy-add-cart-btn" 
                                    onclick="addToCartWithVariant('{{ producto.pkid_prod }}')"
                                    id="addToCartBtn-{{ producto.pkid_prod }}">
                                <i class="fas fa-cart-plus me-2"></i>
                                Agregar al Carrito
                            </button>
                        </div>
                    </div>

                    <div class="variantes-reales-data" style="display: none;">
                        <!-- PRODUCTO BASE -->
                        <div data-variant 
                             data-variant-id="base"
                             data-variant-name="{{ producto.nom_prod }} - Est√°ndar"
                             data-variant-image="{% if producto.img_prod %}{{ producto.img_prod.url }}{% else %}{% static 'img/placeholder-producto.jpg' %}{% endif %}"
                             data-variant-price="{{ producto_data.precio_base|floatformat:0 }}"
                             data-variant-stock="{{ producto_data.stock }}"
                             data-variant-precio-adicional="0"
                             data-variant-precio-final="{{ producto_data.precio_final|floatformat:0 }}"
                             data-is-base="true">
                        </div>
                        
                        <!-- VARIANTES ADICIONALES -->
                        {% for variante in producto_data.variantes %}
                        {% with precio_base_variante=producto_data.precio_base|add:variante.precio_adicional %}
                        {% with precio_final_variante=producto_data.precio_final|add:variante.precio_adicional %}
                        <div data-variant 
                             data-variant-id="{{ variante.id_variante }}"
                             data-variant-name="{{ variante.nombre_variante }}"
                             data-variant-image="{% if variante.imagen_variante %}{{ variante.imagen_variante.url }}{% else %}{% if producto.img_prod %}{{ producto.img_prod.url }}{% else %}{% static 'img/placeholder-producto.jpg' %}{% endif %}{% endif %}"
                             data-variant-price="{{ precio_base_variante|floatformat:0 }}"
                             data-variant-stock="{{ variante.stock_variante }}"
                             data-variant-precio-adicional="{{ variante.precio_adicional|default:0 }}"
                             data-variant-precio-final="{{ precio_final_variante|floatformat:0 }}"
                             data-is-base="false">
                        </div>
                        {% endwith %}
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- PRODUCTO SIN VARIANTES -->
            {% else %}
            <div class="col-xl-3 col-lg-4 col-md-6">
                <div class="product-card" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:1 }}00">
                    <div class="product-image">
                        {% if producto.img_prod %}
                            <img src="{{ producto.img_prod.url }}" alt="{{ producto.nom_prod }}">
                        {% else %}
                            <div class="product-image-placeholder">
                                <i class="fas fa-box-open"></i>
                            </div>
                        {% endif %}
                        
                        {% if producto_data.tiene_descuento %}
                        <div class="product-badge">
                            <span class="discount-badge">Oferta</span>
                        </div>
                        {% endif %}
                        
                        <div class="product-actions">
                            <button class="btn-action" onclick="addToCart('{{ producto.pkid_prod }}')" title="Agregar al carrito">
                                <i class="fas fa-shopping-cart"></i>
                            </button>
                            <button class="btn-action" onclick="addToFavorites('{{ producto.pkid_prod }}')" title="Agregar a favoritos">
                                <i class="far fa-heart"></i>
                            </button>
                            <button class="btn-action" onclick="quickView('{{ producto.pkid_prod }}')" title="Vista r√°pida">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="product-info">
                        <h3 class="product-title">{{ producto.nom_prod }}</h3>
                        <p class="product-category">{{ producto.fkcategoria_prod.nom_cat }}</p>
                        
                        <div class="product-price">
                            {% if producto_data.tiene_descuento %}
                            <span class="current-price">${{ producto_data.precio_final|floatformat:0 }}</span>
                            <span class="original-price">${{ producto_data.precio_base|floatformat:0 }}</span>
                            {% else %}
                            <span class="current-price">${{ producto_data.precio_final|floatformat:0 }}</span>
                            {% endif %}
                        </div>
                        
                        <div class="product-stock">
                            {% if producto_data.stock > 10 %}
                            <span class="stock-available"><i class="fas fa-check-circle"></i> En stock</span>
                            {% elif producto_data.stock > 0 %}
                            <span class="stock-low"><i class="fas fa-exclamation-triangle"></i> √öltimas unidades</span>
                            {% else %}
                            <span class="stock-out"><i class="fas fa-times-circle"></i> Agotado</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}
            {% endwith %}
            {% endfor %}
        </div>
        
        {% if productos|length > 8 %}
        <div class="text-center mt-5">
            <button class="vecy-btn-primary btn-lg">
                <i class="fas fa-store me-2"></i> Ver todos los productos
            </button>
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <i class="fas fa-box-open"></i>
            <h4>No hay productos disponibles</h4>
            <p>Este negocio a√∫n no ha agregado productos a su cat√°logo.</p>
        </div>
        {% endif %}
    </div>
</section>

<!-- Secci√≥n de Informaci√≥n y Rese√±as -->
<section class="business-detail-section py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <!-- ESTAD√çSTICAS DE RESE√ëAS -->
                <div class="ratings-summary-card vecy-card" data-aos="fade-up" data-aos-delay="100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-bar me-2"></i>
                            Rese√±as del Negocio
                        </h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="average-rating">
                                    <div class="rating-number">{{ estadisticas_resenas.promedio|default:0|floatformat:1 }}</div>
                                    <div class="stars mb-2">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= estadisticas_resenas.promedio|default:0 %}
                                                <i class="fas fa-star"></i>
                                            {% elif forloop.counter <= estadisticas_resenas.promedio|default:0|add:0.5 %}
                                                <i class="fas fa-star-half-alt"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="total-reviews">{{ estadisticas_resenas.total_resenas|default:0 }} rese√±as</div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="rating-bars">
                                    {% for item in estadisticas_resenas.distribucion %}
                                    <div class="rating-bar-item">
                                        <span class="rating-label">
                                            <i class="fas fa-star"></i> {{ item.estrellas }}
                                        </span>
                                        <div class="rating-bar">
                                            <div class="rating-progress" 
                                                 data-percentage="{{ item.porcentaje }}"
                                                 data-estrellas="{{ item.estrellas }}"
                                                 data-cantidad="{{ item.cantidad }}">
                                            </div>
                                        </div>
                                        <span class="rating-count">{{ item.cantidad }}</span>
                                    </div>
                                    {% empty %}
                                    {% for estrellas in "54321" %}
                                    <div class="rating-bar-item">
                                        <span class="rating-label"><i class="fas fa-star"></i> {{ estrellas }}</span>
                                        <div class="rating-bar">
                                            <div class="rating-progress" data-percentage="0"></div>
                                        </div>
                                        <span class="rating-count">0</span>
                                    </div>
                                    {% endfor %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n de rese√±as CON PAGINACI√ìN -->
                <div class="reviews-section vecy-card" data-aos="fade-up" data-aos-delay="200">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-comments me-2"></i>
                                Rese√±as de Clientes
                                <span class="badge bg-primary ms-2">{{ total_resenas }} rese√±as</span>
                            </h5>
                            
                            {% if hay_mas_resenas %}
                            <button class="btn btn-outline-primary btn-sm" onclick="cargarSiguientePagina()">
                                <i class="fas fa-chevron-down me-1"></i> Ver m√°s
                            </button>
                            {% endif %}
                        </div>

                        {% if resenas %}
                            <div class="reviews-list" id="reviewsContainer">
                                {% for resena in resenas %}
                                <div class="review-item" data-resena-id="{{ resena.pkid_resena }}">
                                    <div class="review-header">
                                        <div class="review-user">
                                            <div class="review-user-avatar">
                                                <i class="fas fa-user-circle"></i>
                                            </div>
                                            <div class="review-user-info">
                                                <div class="review-user-name">
                                                    {{ resena.fkusuario_resena.fkuser.first_name }} {{ resena.fkusuario_resena.fkuser.last_name }}
                                                </div>
                                                <div class="review-date">
                                                    {{ resena.fecha_resena|date:"d M Y" }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="review-actions dropdown">
                                            <button class="btn-review-actions" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                {% if resena.fkusuario_resena != perfil_cliente %}
                                                <li>
                                                    <a class="dropdown-item text-danger" href="#" 
                                                       onclick="abrirModalReporte('resena', {{ negocio.pkid_neg }}, {{ resena.pkid_resena }})">
                                                        <i class="fas fa-flag me-2"></i>Reportar Rese√±a
                                                    </a>
                                                </li>
                                                {% else %}
                                                <li>
                                                    <span class="dropdown-item text-muted">
                                                        <i class="fas fa-user me-2"></i>Tu rese√±a
                                                    </span>
                                                </li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="review-content">
                                        <div class="review-stars">
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= resena.estrellas %}
                                                    <i class="fas fa-star text-warning"></i>
                                                {% else %}
                                                    <i class="far fa-star text-warning"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        <p class="review-text">{{ resena.comentario|default:"Sin comentario" }}</p>
                                        
                                        {% if resena.respuesta_vendedor %}
                                        <div class="review-response">
                                            <div class="response-header">
                                                <i class="fas fa-reply me-2"></i>
                                                <strong>Respuesta del vendedor</strong>
                                                <span class="response-date ms-2 text-muted">
                                                    {{ resena.fecha_respuesta|date:"d M Y" }}
                                                </span>
                                            </div>
                                            <p class="response-text">{{ resena.respuesta_vendedor }}</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- PAGINACI√ìN MEJORADA -->
                            <div class="reviews-pagination mt-4 text-center">
                                {% if resenas.has_other_pages %}
                                <nav aria-label="Paginaci√≥n de rese√±as">
                                    <ul class="pagination justify-content-center">
                                        {% if resenas.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ resenas.previous_page_number }}#reviewsContainer">
                                                <i class="fas fa-chevron-left me-1"></i> Anterior
                                            </a>
                                        </li>
                                        {% endif %}
                                        
                                        {% for num in resenas.paginator.page_range %}
                                            {% if num <= 3 or num > resenas.paginator.num_pages|add:-2 %}
                                                {% if resenas.number == num %}
                                                <li class="page-item active">
                                                    <span class="page-link">{{ num }}</span>
                                                </li>
                                                {% else %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{ num }}#reviewsContainer">{{ num }}</a>
                                                </li>
                                                {% endif %}
                                            {% elif num == 4 and resenas.paginator.num_pages > 6 %}
                                                <li class="page-item disabled">
                                                    <span class="page-link">...</span>
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% if resenas.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ resenas.next_page_number }}#reviewsContainer">
                                                Siguiente <i class="fas fa-chevron-right ms-1"></i>
                                            </a>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                                {% endif %}
                                
                                <!-- INFORMACI√ìN DE PAGINACI√ìN -->
                                <div class="pagination-info text-muted small mt-2">
                                    Mostrando {{ resenas.start_index }}-{{ resenas.end_index }} de {{ total_resenas }} rese√±as
                                    {% if total_paginas > 1 %}
                                    ‚Ä¢ P√°gina {{ pagina_actual }} de {{ total_paginas }}
                                    {% endif %}
                                </div>
                                
                                <!-- BOT√ìN "VER M√ÅS RESE√ëAS" -->
                                {% if hay_mas_resenas %}
                                <div class="mt-3">
                                    <button class="btn btn-primary" onclick="cargarSiguientePagina()">
                                        <i class="fas fa-list me-2"></i> Cargar m√°s rese√±as
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="empty-state">
                                <i class="fas fa-comments"></i>
                                <h5>A√∫n no hay rese√±as</h5>
                                <p>S√© el primero en dejar una rese√±a para este negocio</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <!-- Sidebar con informaci√≥n extra para logueados -->
                <div class="sidebar-logged">
                    <!-- Informaci√≥n del negocio -->
                    <div class="sidebar-card vecy-card mb-4" data-aos="fade-left" data-aos-delay="100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-info-circle me-2"></i>
                                Informaci√≥n del Negocio
                            </h5>
                            <div class="business-details">
                                <div class="detail-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <div class="detail-content">
                                        <strong>Direcci√≥n:</strong>
                                        <span>{{ negocio.direcc_neg }}</span>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-id-card"></i>
                                    <div class="detail-content">
                                        <strong>NIT:</strong>
                                        <span>{{ negocio.nit_neg }}</span>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <div class="detail-content">
                                        <strong>Miembro desde:</strong>
                                        <span>{{ negocio.fechacreacion_neg|date:"M Y" }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mapa de Ubicaci√≥n -->
                    <div class="sidebar-card vecy-card mb-4" data-aos="fade-left" data-aos-delay="150">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-map-marked-alt me-2"></i>
                                Ubicaci√≥n - Fosca, Cundinamarca
                            </h5>
                            <div class="map-container-vecy">
                                <div id="leaflet-map"></div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="vecy-btn-outline w-100" onclick="openInGoogleMaps()">
                                    <i class="fas fa-external-link-alt me-2"></i>
                                    Abrir en Google Maps
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario de rese√±a -->
                    <div class="sidebar-card vecy-card" data-aos="fade-left" data-aos-delay="200">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-star me-2"></i>
                                {% if usuario_ya_reseno %}
                                    Actualizar tu Rese√±a
                                {% else %}
                                    Deja tu Rese√±a
                                {% endif %}
                            </h5>
                            
                            {% if usuario_ya_reseno %}
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Ya tienes una rese√±a publicada. Puedes actualizarla si lo deseas.
                            </div>
                            {% endif %}
                            
                            <form method="post" action="{% url 'guardar_resena' %}">
                                {% csrf_token %}
                                <input type="hidden" name="fknegocio_resena" value="{{ negocio.pkid_neg }}">
                                <input type="hidden" name="es_vista_logeada" value="true">
                                
                                <div class="star-rating mb-3 text-center">
                                    <input type="radio" id="star1" name="estrellas" value="1" class="d-none">
                                    <label for="star1" class="star-label">
                                        <i class="fas fa-star fa-lg"></i>
                                    </label>
                                    
                                    <input type="radio" id="star2" name="estrellas" value="2" class="d-none">
                                    <label for="star2" class="star-label">
                                        <i class="fas fa-star fa-lg"></i>
                                    </label>
                                    
                                    <input type="radio" id="star3" name="estrellas" value="3" class="d-none">
                                    <label for="star3" class="star-label">
                                        <i class="fas fa-star fa-lg"></i>
                                    </label>
                                    
                                    <input type="radio" id="star4" name="estrellas" value="4" class="d-none">
                                    <label for="star4" class="star-label">
                                        <i class="fas fa-star fa-lg"></i>
                                    </label>
                                    
                                    <input type="radio" id="star5" name="estrellas" value="5" class="d-none" 
                                           {% if not usuario_ya_reseno or rese√±a_usuario_actual.estrellas == 5 %}checked{% endif %}>
                                    <label for="star5" class="star-label active">
                                        <i class="fas fa-star fa-lg"></i>
                                    </label>
                                </div>
                                
                                <div class="mb-3">
                                    <textarea name="comentario" class="form-control" placeholder="Tu experiencia con este negocio..." rows="3">{% if usuario_ya_reseno %}{{ rese√±a_usuario_actual.comentario }}{% endif %}</textarea>
                                </div>
                                
                                <button type="submit" class="btn-submit-review">
                                    <i class="fas fa-paper-plane me-1"></i>
                                    {% if usuario_ya_reseno %}
                                        Actualizar Rese√±a
                                    {% else %}
                                        Enviar Rese√±a
                                    {% endif %}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- MODALES -->
<div class="modal fade" id="variantsModal" tabindex="-1" aria-labelledby="variantsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="variantsModalLabel">
                    <i class="fas fa-list-alt me-2"></i>
                    Seleccionar Variante
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="variantsModalContent">
                    <!-- Contenido din√°mico de variantes -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="confirmVariantSelection">
                    <i class="fas fa-check me-2"></i>
                    Seleccionar Variante
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade modal-reporte" id="modalReporte" tabindex="-1" aria-labelledby="modalReporteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="modalReporteTitulo">
                    <i class="fas fa-flag me-2"></i>
                    Reportar Contenido
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="reporte-header mb-4">
                    <div class="reporte-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h4 class="reporte-title">Ay√∫danos a mantener la comunidad segura</h4>
                    <p class="reporte-subtitle">Tu reporte es an√≥nimo y nos ayuda a mejorar la experiencia de todos</p>
                </div>
                
                <form id="formReporte">
                    <input type="hidden" id="negocioId" name="negocio_id">
                    <input type="hidden" id="rese√±aId" name="rese√±a_id">
                    <input type="hidden" id="tipoReporte" name="tipo_reporte">
                    
                    <div class="mb-4">
                        <label for="asuntoReporte" class="form-label">Asunto del Reporte</label>
                        <input type="text" class="form-control" id="asuntoReporte" name="asunto" 
                               placeholder="Describe brevemente el motivo del reporte" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="motivoReporte" class="form-label">Motivo Principal</label>
                        <select class="form-select" id="motivoReporte" name="motivo" required>
                            <option value="">Selecciona un motivo</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label for="descripcionReporte" class="form-label">Descripci√≥n Detallada</label>
                        <textarea class="form-control" id="descripcionReporte" name="descripcion" 
                                  rows="4" placeholder="Proporciona todos los detalles relevantes sobre el reporte..."></textarea>
                        <div class="form-text">Mientras m√°s detalles proporciones, m√°s f√°cil ser√° revisar tu reporte.</div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Importante:</strong> Tus reportes nos ayudan a mantener la comunidad segura y confiable. 
                        Revisaremos tu reporte en un plazo m√°ximo de 48 horas.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="vecy-btn-outline" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="vecy-btn-primary" id="btnEnviarReporte" onclick="enviarReporte()">
                    <i class="fas fa-paper-plane me-2"></i>
                    Enviar Reporte
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sistema de carrito -->
{% include 'carrito_sistema.html' %}

{% endblock %}

{% block scripts %}
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- AOS Animation -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<!-- Leaflet Maps -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Inicializar AOS
    AOS.init({
        duration: 800,
        once: true,
        offset: 100
    });

    // URLs para el sistema de reportes
    const REPORTE_URLS = {
        REPORTAR: "{% url 'reportar_negocio' %}",
        OBTENER_OPCIONES: "{% url 'obtener_opciones_reporte' %}"
    };

    // ==================== SISTEMA DE VARIANTES HORIZONTALES ====================
    function inicializarSistemaVariantes() {
        console.log("üîÑ Inicializando sistema de variantes...");
        
        const productosConVariantes = document.querySelectorAll('.product-card-with-variants');
        console.log(`üì¶ Encontrados ${productosConVariantes.length} productos con variantes`);
        
        productosConVariantes.forEach(producto => {
            const productId = producto.getAttribute('data-product-id');
            const variantsGrid = document.getElementById(`variantsGrid-${productId}`);
            const variantsData = producto.querySelector('.variantes-reales-data');
            
            if (variantsGrid && variantsData) {
                console.log(`üîß Procesando producto ${productId}`);
                
                // FORZAR ESTILOS HORIZONTALES
                variantsGrid.style.cssText = `
                    display: flex !important;
                    flex-direction: row !important;
                    flex-wrap: nowrap !important;
                    overflow-x: auto !important;
                    overflow-y: hidden !important;
                    gap: 12px !important;
                    padding: 12px 8px !important;
                    width: 100% !important;
                    min-height: 95px !important;
                    scrollbar-width: thin !important;
                    scrollbar-color: #3598db #f1f5f9 !important;
                `;
                
                generarMiniaturasVariantes(productId, variantsGrid, variantsData);
            } else {
                console.log(`‚ùå No se pudo encontrar variantsGrid o variantsData para ${productId}`);
            }
        });
        
        console.log(`‚úÖ Sistema de variantes inicializado para ${productosConVariantes.length} productos`);
    }

    function generarMiniaturasVariantes(productId, variantsGrid, variantsData) {
        console.log(`üé® Generando miniaturas para producto ${productId}`);
        
        // Limpiar grid existente
        variantsGrid.innerHTML = '';
        
        // Obtener todas las variantes
        const variantes = variantsData.querySelectorAll('[data-variant]');
        console.log(`üìä ${variantes.length} variantes encontradas para producto ${productId}`);
        
        variantes.forEach((variante, index) => {
            const variantId = variante.getAttribute('data-variant-id');
            const variantName = variante.getAttribute('data-variant-name');
            const variantImage = variante.getAttribute('data-variant-image');
            const variantPrice = variante.getAttribute('data-variant-precio-final') || variante.getAttribute('data-variant-price');
            const variantStock = parseInt(variante.getAttribute('data-variant-stock'));
            const isBase = variante.getAttribute('data-is-base') === 'true';
            
            console.log(`  üì¶ Variante ${index}: ${variantName}, Stock: ${variantStock}, Base: ${isBase}`);
            
            // Crear miniatura
            const variantThumb = document.createElement('div');
            variantThumb.className = `variant-thumb ${variantStock === 0 ? 'variant-disabled' : ''} ${index === 0 ? 'selected' : ''}`;
            variantThumb.setAttribute('data-variant-id', variantId);
            variantThumb.setAttribute('data-product-id', productId);
            
            // Determinar estado de stock
            let stockClass = 'stock-available';
            let stockText = 'Disponible';
            
            if (variantStock === 0) {
                stockClass = 'stock-unavailable';
                stockText = 'Agotado';
            } else if (variantStock < 10) {
                stockClass = 'stock-low';
                stockText = `${variantStock} disp`;
            } else {
                stockText = `${variantStock} disp`;
            }
            
            variantThumb.innerHTML = `
                <div class="variant-image-container">
                    ${variantImage ? 
                        `<img src="${variantImage}" alt="${variantName}" onerror="this.src='https://via.placeholder.com/300x200/3598db/ffffff?text=VECY'">` : 
                        `<div class="variant-image-placeholder">
                            <i class="fas fa-cube"></i>
                         </div>`
                    }
                    ${isBase ? `<div class="base-badge">Base</div>` : ''}
                    ${index === 0 ? `<div class="variant-selection-indicator"><i class="fas fa-check"></i></div>` : ''}
                </div>
                <div class="variant-info">
                    <div class="variant-name">${variantName}</div>
                    <div class="variant-price">$${variantPrice}</div>
                    <div class="variant-stock-info ${stockClass}">${stockText}</div>
                </div>
            `;
            
            // Agregar evento click
            variantThumb.addEventListener('click', function() {
                if (variantStock === 0) return;
                
                seleccionarVariante(productId, variantId);
            });
            
            variantsGrid.appendChild(variantThumb);
        });
        
        // Seleccionar primera variante por defecto
        if (variantes.length > 0) {
            const primeraVariante = variantes[0];
            const primeraVariantId = primeraVariante.getAttribute('data-variant-id');
            const primeraVariantStock = parseInt(primeraVariante.getAttribute('data-variant-stock'));
            
            if (primeraVariantStock > 0) {
                seleccionarVariante(productId, primeraVariantId);
            }
        }
        
        console.log(`‚úÖ Generadas ${variantes.length} miniaturas para producto ${productId}`);
    }

    function seleccionarVariante(productId, variantId) {
        console.log(`üéØ Seleccionando variante ${variantId} para producto ${productId}`);
        
        const producto = document.querySelector(`[data-product-id="${productId}"]`);
        const variantsGrid = document.getElementById(`variantsGrid-${productId}`);
        const variantsData = producto.querySelector('.variantes-reales-data');
        
        if (!variantsGrid || !variantsData) return;
        
        // Remover selecci√≥n anterior
        const thumbsAnteriores = variantsGrid.querySelectorAll('.variant-thumb.selected');
        thumbsAnteriores.forEach(thumb => {
            thumb.classList.remove('selected');
            const indicator = thumb.querySelector('.variant-selection-indicator');
            if (indicator) indicator.remove();
        });
        
        // Agregar selecci√≥n nueva
        const thumbSeleccionado = variantsGrid.querySelector(`[data-variant-id="${variantId}"]`);
        if (thumbSeleccionado) {
            thumbSeleccionado.classList.add('selected');
            
            // Agregar indicador de selecci√≥n
            const selectionIndicator = document.createElement('div');
            selectionIndicator.className = 'variant-selection-indicator';
            selectionIndicator.innerHTML = '<i class="fas fa-check"></i>';
            thumbSeleccionado.querySelector('.variant-image-container').appendChild(selectionIndicator);
        }
        
        // Actualizar informaci√≥n del producto
        const varianteSeleccionada = variantsData.querySelector(`[data-variant-id="${variantId}"]`);
        if (varianteSeleccionada) {
            const variantName = varianteSeleccionada.getAttribute('data-variant-name');
            const variantImage = varianteSeleccionada.getAttribute('data-variant-image');
            const variantPrice = varianteSeleccionada.getAttribute('data-variant-precio-final') || varianteSeleccionada.getAttribute('data-variant-price');
            const variantStock = parseInt(varianteSeleccionada.getAttribute('data-variant-stock'));
            
            // Actualizar imagen principal
            const mainImage = document.getElementById(`mainProductImage-${productId}`);
            if (mainImage && variantImage) {
                mainImage.src = variantImage;
            }
            
            // Actualizar precio
            const priceElement = document.getElementById(`price-${productId}`);
            if (priceElement) {
                priceElement.textContent = `$${variantPrice}`;
            }
            
            // Actualizar stock
            const stockElement = document.getElementById(`stockInfo-${productId}`);
            if (stockElement) {
                let stockText = 'M√∫ltiples opciones disponibles';
                if (variantStock === 0) {
                    stockText = 'Agotado';
                } else if (variantStock < 10) {
                    stockText = `${variantStock} disponibles`;
                }
                stockElement.textContent = stockText;
            }
            
            // Actualizar bot√≥n
            const addToCartBtn = document.getElementById(`addToCartBtn-${productId}`);
            if (addToCartBtn) {
                if (variantStock === 0) {
                    addToCartBtn.disabled = true;
                    addToCartBtn.innerHTML = '<i class="fas fa-times me-2"></i>Agotado';
                } else {
                    addToCartBtn.disabled = false;
                    addToCartBtn.innerHTML = '<i class="fas fa-cart-plus me-2"></i>Agregar al Carrito';
                }
            }
            
            console.log(`‚úÖ Variante ${variantId} seleccionada para producto ${productId}`);
        }
    }

    function addToCartWithVariant(productId) {
        const producto = document.querySelector(`[data-product-id="${productId}"]`);
        const variantsGrid = document.getElementById(`variantsGrid-${productId}`);
        
        if (!variantsGrid) {
            // Si no hay variantes, usar funci√≥n normal
            addToCart(productId);
            return;
        }
        
        // Obtener variante seleccionada
        const varianteSeleccionada = variantsGrid.querySelector('.variant-thumb.selected');
        if (!varianteSeleccionada) {
            alert('Por favor selecciona una variante');
            return;
        }
        
        const variantId = varianteSeleccionada.getAttribute('data-variant-id');
        const variantStock = parseInt(varianteSeleccionada.querySelector('.variant-stock-info').textContent);
        
        if (variantStock === 0) {
            alert('Esta variante est√° agotada');
            return;
        }
        
        console.log(`üõí Agregando al carrito: Producto ${productId}, Variante ${variantId}`);
        
        // Usar el sistema modular del carrito
        if (window.vecyCarritoSystem) {
            window.vecyCarritoSystem.addToCartWithVariant(productId);
        } else {
            // Fallback si el sistema no est√° disponible
            alert(`Producto agregado al carrito: ${productId} - Variante: ${variantId}`);
        }
    }

    // ==================== SISTEMA DE MAPAS ====================
    function initMap() {
        // Coordenadas exactas de Fosca, Cundinamarca, Colombia
        const foscaLat = 4.3392;
        const foscaLon = -73.9389;
        
        // Mapa centrado exclusivamente en Fosca
        const map = L.map('leaflet-map', {
            zoomControl: true,
            scrollWheelZoom: false,
            dragging: true,
            tap: true,
            maxBounds: [
                [4.2392, -74.0389], // Suroeste
                [4.4392, -73.8389]  // Noreste
            ],
            maxBoundsViscosity: 1.0
        }).setView([foscaLat, foscaLon], 14);
        
        // Tile layer con estilo mejorado
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18,
            minZoom: 12,
            detectRetina: true
        }).addTo(map);
        
        // Icono personalizado para Fosca
        const customIcon = L.divIcon({
            html: `
                <div style="
                    background: linear-gradient(135deg, #3598db 0%, #4aa8e8 100%);
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    border: 4px solid white;
                    box-shadow: 0 4px 20px rgba(53, 152, 219, 0.4);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 16px;
                ">
                    <i class="fas fa-store"></i>
                </div>
            `,
            className: 'leaflet-custom-icon',
            iconSize: [50, 50],
            iconAnchor: [25, 50],
            popupAnchor: [0, -50]
        });
        
        // Marcador en el centro de Fosca
        const marker = L.marker([foscaLat, foscaLon], {icon: customIcon}).addTo(map);
        
        const popupContent = `
            <div style="min-width: 250px; padding: 12px;">
                <div class="d-flex align-items-center mb-2">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3598db 0%, #4aa8e8 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; margin-right: 12px;">
                        <i class="fas fa-store"></i>
                    </div>
                    <div>
                        <h6 style="margin: 0; color: #3598db; font-weight: 700;">{{ negocio.nom_neg }}</h6>
                        <small style="color: #7f8c8d;">Ubicado en Fosca, Cundinamarca</small>
                    </div>
                </div>
                <p style="margin: 8px 0 0 0; color: #34495e; font-size: 13px; line-height: 1.4;">
                    <i class="fas fa-map-marker-alt me-2" style="color: #3598db;"></i>
                    {{ negocio.direcc_neg }}, Fosca, Cundinamarca
                </p>
                <p style="margin: 4px 0 0 0; color: #7f8c8d; font-size: 12px;">
                    <i class="fas fa-mountains me-2"></i>
                    Municipio de la regi√≥n oriente de Cundinamarca
                </p>
            </div>
        `;
        
        marker.bindPopup(popupContent, {
            className: 'custom-popup',
            maxWidth: 300
        }).openPopup();
        
        // Evitar que el usuario se aleje de Fosca
        map.setMaxBounds(map.getBounds());
    }
    
    function openInGoogleMaps() {
        const address = encodeURIComponent("{{ negocio.direcc_neg }}, Fosca, Cundinamarca, Colombia");
        window.open(`https://www.google.com/maps/search/?api=1&query=${address}`, '_blank');
    }

    // ==================== SISTEMA DE PAGINACI√ìN DE RESE√ëAS ====================
    function cargarSiguientePagina() {
        const urlParams = new URLSearchParams(window.location.search);
        const currentPage = parseInt(urlParams.get('page')) || 1;
        const nextPage = currentPage + 1;
        
        urlParams.set('page', nextPage);
        window.location.href = `${window.location.pathname}?${urlParams.toString()}#reviewsContainer`;
    }

    function cargarPaginaEspecifica(pagina) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('page', pagina);
        window.location.href = `${window.location.pathname}?${urlParams.toString()}#reviewsContainer`;
    }

    // ==================== SISTEMA DE BARRAS DE RATING ====================
    function animarBarrasRating() {
        const ratingBars = document.querySelectorAll('.rating-progress');
        
        ratingBars.forEach((bar) => {
            bar.style.cssText = '';
            bar.style.width = '0%';
            bar.style.height = '10px';
            bar.style.background = 'linear-gradient(90deg, #ffc107, #fd7e14)';
            bar.style.borderRadius = '10px';
            bar.style.transition = 'width 1.5s cubic-bezier(0.4, 0, 0.2, 1)';
            bar.style.display = 'block';
            bar.style.visibility = 'visible';
            bar.style.opacity = '1';
        });
        
        void ratingBars[0]?.offsetHeight;
        
        ratingBars.forEach((bar, index) => {
            const percentage = parseFloat(bar.getAttribute('data-percentage')) || 0;
            
            setTimeout(() => {
                bar.style.width = percentage + '%';
            }, 400 + (index * 300));
        });
    }

    function inicializarSistemaRating() {
        setTimeout(() => {
            const ratingBars = document.querySelectorAll('.rating-progress');
            
            if (ratingBars.length > 0) {
                animarBarrasRating();
            }
        }, 500);
    }

    // ==================== SISTEMA DE ESTRELLAS INTERACTIVO ====================
    function inicializarSistemaEstrellas() {
        const starLabels = document.querySelectorAll('.star-label');
        const starInputs = document.querySelectorAll('input[name="estrellas"]');
        
        function updateStarDisplay(selectedValue) {
            starLabels.forEach(label => {
                const labelValue = parseInt(label.htmlFor.replace('star', ''));
                if (labelValue <= selectedValue) {
                    label.classList.add('active');
                } else {
                    label.classList.remove('active');
                }
            });
        }
        
        const defaultSelected = document.querySelector('input[name="estrellas"]:checked');
        if (defaultSelected) {
            updateStarDisplay(parseInt(defaultSelected.value));
        }
        
        starLabels.forEach((label) => {
            label.addEventListener('mouseenter', function() {
                const hoverValue = parseInt(this.htmlFor.replace('star', ''));
                
                starLabels.forEach((l) => {
                    const labelValue = parseInt(l.htmlFor.replace('star', ''));
                    if (labelValue <= hoverValue) {
                        l.classList.add('hover');
                    } else {
                        l.classList.remove('hover');
                    }
                });
            });
            
            label.addEventListener('click', function() {
                const starId = this.htmlFor;
                const starValue = parseInt(starId.replace('star', ''));
                
                starInputs.forEach(input => {
                    input.checked = false;
                });
                
                document.getElementById(starId).checked = true;
                updateStarDisplay(starValue);
            });
        });
        
        starInputs.forEach(input => {
            input.addEventListener('change', function() {
                const value = parseInt(this.value);
                updateStarDisplay(value);
            });
        });
        
        document.querySelector('.star-rating')?.addEventListener('mouseleave', function() {
            starLabels.forEach(l => l.classList.remove('hover'));
            
            const checkedInput = document.querySelector('input[name="estrellas"]:checked');
            if (checkedInput) {
                updateStarDisplay(parseInt(checkedInput.value));
            }
        });
    }

    // ==================== FUNCIONES DEL NEGOCIO ====================
    function seguirNegocio(negocioId) {
        const button = event.target;
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
        button.disabled = true;
        
        setTimeout(() => {
            alert('Ahora sigues este negocio');
            button.innerHTML = '<i class="fas fa-heart me-1"></i> Siguiendo';
            button.classList.add('btn-following');
            button.disabled = false;
        }, 1000);
    }

    function abrirModalReporte(tipo, negocioId, rese√±aId = null) {
        const titulo = tipo === 'resena' ? 'Reportar Rese√±a' : 'Reportar Negocio';
        document.getElementById('modalReporteTitulo').textContent = titulo;
        
        document.getElementById('formReporte').reset();
        document.getElementById('negocioId').value = negocioId;
        document.getElementById('rese√±aId').value = rese√±aId || '';
        document.getElementById('tipoReporte').value = tipo;
        
        cargarOpcionesReporte(tipo);
        
        const modal = new bootstrap.Modal(document.getElementById('modalReporte'));
        modal.show();
    }

    function cargarOpcionesReporte(tipo) {
        const selectMotivo = document.getElementById('motivoReporte');
        
        selectMotivo.innerHTML = '<option value="">Cargando opciones...</option>';
        
        fetch(`${REPORTE_URLS.OBTENER_OPCIONES}?tipo=${tipo}`)
            .then(response => response.json())
            .then(data => {
                selectMotivo.innerHTML = '<option value="">Selecciona un motivo</option>';
                
                data.opciones.forEach(opcion => {
                    const option = document.createElement('option');
                    option.value = opcion.value;
                    option.textContent = opcion.text;
                    selectMotivo.appendChild(option);
                });
            })
            .catch(error => {
                selectMotivo.innerHTML = '<option value="">Error cargando opciones</option>';
            });
    }

    function enviarReporte() {
        const form = document.getElementById('formReporte');
        const btnEnviar = document.getElementById('btnEnviarReporte');
        
        const asunto = document.getElementById('asuntoReporte').value.trim();
        const motivo = document.getElementById('motivoReporte').value;
        
        if (!asunto || !motivo) {
            alert('Por favor completa todos los campos obligatorios');
            return;
        }
        
        const formData = new FormData(form);
        const datos = {
            negocio_id: formData.get('negocio_id'),
            rese√±a_id: formData.get('rese√±a_id'),
            asunto: asunto,
            motivo: motivo,
            descripcion: document.getElementById('descripcionReporte').value.trim()
        };
        
        const originalText = btnEnviar.innerHTML;
        btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
        btnEnviar.disabled = true;
        
        fetch(REPORTE_URLS.REPORTAR, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(datos)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalReporte'));
                modal.hide();
                alert(data.message);
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            alert('Error de conexi√≥n al enviar el reporte');
        })
        .finally(() => {
            btnEnviar.innerHTML = originalText;
            btnEnviar.disabled = false;
        });
    }

    // ==================== FUNCIONES UTILITARIAS ====================
    function addToFavorites(productId) {
        alert('Producto agregado a favoritos');
    }

    function quickView(productId) {
        alert('Funci√≥n de vista r√°pida');
    }

    function addToCart(productId) {
        if (window.vecyCarritoSystem) {
            window.vecyCarritoSystem.addToCart(productId);
        } else {
            alert(`Producto ${productId} agregado al carrito`);
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ==================== INICIALIZACI√ìN GARANTIZADA ====================
    console.log("üéØ VECY DETALLE NEGOCIO - CARGANDO SISTEMAS...");

    // INICIALIZACI√ìN DIRECTA Y FORZADA
    function forzarInicializacionVariantes() {
        console.log("üí• FORZANDO inicializaci√≥n de variantes...");
        
        const productosConVariantes = document.querySelectorAll('.product-card-with-variants');
        console.log(`üì¶ Encontrados ${productosConVariantes.length} productos con variantes para forzar`);
        
        productosConVariantes.forEach((producto, index) => {
            const productId = producto.getAttribute('data-product-id');
            if (!productId) return;

            const variantsGrid = document.getElementById(`variantsGrid-${productId}`);
            const variantsData = producto.querySelector('.variantes-reales-data');
            
            if (variantsGrid && variantsData) {
                console.log(`üîß Forzando variantes para producto ${productId}`);
                
                // Forzar estilo horizontal INMEDIATAMENTE
                variantsGrid.style.cssText = `
                    display: flex !important;
                    flex-direction: row !important;
                    flex-wrap: nowrap !important;
                    overflow-x: auto !important;
                    overflow-y: hidden !important;
                    gap: 12px !important;
                    padding: 12px 8px !important;
                    width: 100% !important;
                    min-height: 95px !important;
                `;
                
                generarMiniaturasVariantes(productId, variantsGrid, variantsData);
            } else {
                console.log(`‚ùå No se pudo forzar variantes para ${productId}`);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("üöÄ DOM Cargado - Iniciando sistemas...");
        
        inicializarSistemaRating();
        inicializarSistemaEstrellas();
        initMap();
        
        // INICIALIZACI√ìN DE VARIANTES CON RETRASO
        setTimeout(() => {
            console.log("üîÑ Inicializando sistema de variantes con timeout...");
            inicializarSistemaVariantes();
        }, 300);
    });

    window.addEventListener('load', function() {
        console.log("üì¶ Window Loaded - Ejecutando animaciones...");
        setTimeout(animarBarrasRating, 1000);
        
        // SEGUNDA INICIALIZACI√ìN DE VARIANTES
        setTimeout(() => {
            console.log("üîÑ Inicializando sistema de variantes despu√©s de load...");
            inicializarSistemaVariantes();
        }, 500);
    });

    // EJECUTAR INMEDIATAMENTE Y CON M√öLTIPOS INTENTOS
    setTimeout(forzarInicializacionVariantes, 200);
    setTimeout(forzarInicializacionVariantes, 800);
    setTimeout(forzarInicializacionVariantes, 1500);

    // Funci√≥n global para compatibilidad
    function addToCartWithVariant(productId) {
        if (window.vecyCarritoSystem) {
            window.vecyCarritoSystem.addToCartWithVariant(productId);
        } else {
            // Fallback si el sistema modular no est√° disponible
            const producto = document.querySelector(`[data-product-id="${productId}"]`);
            const variantsGrid = document.getElementById(`variantsGrid-${productId}`);
            
            if (variantsGrid) {
                const varianteSeleccionada = variantsGrid.querySelector('.variant-thumb.selected');
                if (varianteSeleccionada) {
                    const variantId = varianteSeleccionada.getAttribute('data-variant-id');
                    alert(`Producto agregado al carrito: ${productId} - Variante: ${variantId}`);
                } else {
                    alert('Por favor selecciona una variante');
                }
            } else {
                addToCart(productId);
            }
        }
    }

    console.log("‚úÖ VECY DETALLE NEGOCIO - SISTEMAS CARGADOS");
</script>
{% endblock %}