{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  {% block extra_css %}{% endblock %}
  <title>{% block title %}VECY{% endblock %}</title>
  <style>
    :root {
      --primary: #3598db;
      --secondary: #34495e;
      --dark: #2d3e50;
      --light: #f8f9fb;
      --white: #ffffff;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--light);
      color: var(--dark);
      overflow-x: hidden;
    }

    /* Header Styles */
    .header {
      background-color: var(--white);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
      padding: 15px 0;
    }

    .logo {
      font-weight: 700;
      font-size: 1.8rem;
      color: var(--primary);
      text-decoration: none;
    }

    .logo span {
      color: var(--secondary);
    }

    .logo:hover {
      color: var(--primary);
      text-decoration: none;
    }

    .search-container {
      position: relative;
      max-width: 500px;
    }

    .search-input {
      border-radius: 50px;
      padding: 10px 20px;
      border: 2px solid var(--light);
      transition: var(--transition);
      width: 100%;
    }

    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(53, 152, 219, 0.25);
    }

    .search-btn {
      position: absolute;
      right: 5px;
      top: 5px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 7px 15px;
      transition: var(--transition);
    }

    .search-btn:hover {
      background: var(--secondary);
    }

    .btn-primary-custom {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 10px 25px;
      transition: var(--transition);
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary-custom:hover {
      background: var(--secondary);
      transform: translateY(-2px);
      color: white;
      text-decoration: none;
    }

    .btn-outline-custom {
      border: 2px solid var(--primary);
      color: var(--primary);
      background: transparent;
      border-radius: 50px;
      padding: 10px 25px;
      transition: var(--transition);
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-outline-custom:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
      text-decoration: none;
    }

    /* Nav Icons */
    .nav-icon {
      position: relative;
      color: var(--dark);
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 10px;
      transition: var(--transition);
    }

    .nav-icon:hover {
      background: var(--light);
      color: var(--primary);
    }

    .nav-icon .badge {
      position: absolute;
      top: -5px;
      right: 0;
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* User dropdown */
    .user-dropdown .dropdown-toggle {
      background: var(--primary);
      border: none;
      border-radius: 50px;
      padding: 8px 20px;
      color: white;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-dropdown .dropdown-toggle:hover {
      background: var(--secondary);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid white;
    }

    .dropdown-menu {
      border: none;
      box-shadow: var(--shadow);
      border-radius: 10px;
      padding: 10px 0;
    }

    .dropdown-item {
      padding: 8px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: var(--transition);
    }

    .dropdown-item:hover {
      background: var(--light);
      color: var(--primary);
    }

    .dropdown-divider {
      margin: 8px 0;
    }

    /* Cart Dropdown */
    .cart-dropdown {
      min-width: 350px;
      max-width: 400px;
      padding: 0;
    }

    .cart-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid var(--light);
      transition: var(--transition);
    }

    .cart-item:hover {
      background: rgba(53, 152, 219, 0.05);
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-item-img {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 12px;
    }

    .cart-item-info {
      flex: 1;
      min-width: 0;
    }

    .cart-item-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cart-item-variante {
      font-size: 0.8rem;
      color: var(--secondary);
      margin-bottom: 2px;
    }

    .cart-item-price {
      color: var(--primary);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .cart-item-quantity {
      font-size: 0.8rem;
      color: var(--secondary);
    }

    .cart-item-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 5px;
    }

    .btn-quantity {
      width: 28px;
      height: 28px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 1px solid var(--primary);
      background: white;
      color: var(--primary);
      font-size: 0.8rem;
      transition: var(--transition);
    }

    .btn-quantity:hover {
      background: var(--primary);
      color: white;
    }

    .btn-remove {
      background: none;
      border: none;
      color: #e74c3c;
      font-size: 0.9rem;
      padding: 4px;
      border-radius: 4px;
      transition: var(--transition);
    }

    .btn-remove:hover {
      background: #e74c3c;
      color: white;
    }

    .cart-total {
      padding: 15px;
      background: var(--light);
      border-top: 1px solid #dee2e6;
    }

    .cart-empty {
      text-align: center;
      padding: 30px 20px;
      color: var(--secondary);
    }

    .cart-empty i {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: #bdc3c7;
    }

    /* Notifications */
    .notification-dropdown {
      min-width: 300px;
      max-width: 400px;
    }

    .notification-item {
      padding: 10px 15px;
      border-bottom: 1px solid var(--light);
      transition: var(--transition);
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-item:hover {
      background: var(--light);
    }

    .notification-item.unread {
      background: rgba(52, 152, 219, 0.05);
    }

    .notification-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }

    .notification-time {
      font-size: 0.7rem;
      color: var(--secondary);
    }

    /* Mobile menu */
    .mobile-menu-btn {
      border: none;
      background: none;
      font-size: 1.5rem;
      color: var(--dark);
    }

    /* Messages */
    .messages-container {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1050;
      width: 90%;
      max-width: 500px;
    }

    /* Pedidos sidebar */
    .pedidos-sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: white;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      transition: var(--transition);
      z-index: 1060;
      overflow-y: auto;
    }

    .pedidos-sidebar.show {
      right: 0;
    }

    .pedidos-sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--light);
      background: var(--primary);
      color: white;
    }

    .pedido-item {
      padding: 15px;
      border-bottom: 1px solid var(--light);
      transition: var(--transition);
    }

    .pedido-item:hover {
      background: rgba(53, 152, 219, 0.05);
    }

    .pedido-estado {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .estado-pendiente {
      background: #fff3cd;
      color: #856404;
    }

    .estado-confirmado {
      background: #d1ecf1;
      color: #0c5460;
    }

    .estado-preparando {
      background: #d1ecf1;
      color: #0c5460;
    }

    .estado-enviado {
      background: #d1edff;
      color: #004085;
    }

    .estado-entregado {
      background: #d4edda;
      color: #155724;
    }

    .estado-cancelado {
      background: #f8d7da;
      color: #721c24;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .nav-icons {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--white);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        padding: 10px;
        z-index: 1000;
        display: flex;
        justify-content: space-around;
      }

      .nav-icon {
        flex-direction: column;
        font-size: 0.8rem;
        padding: 5px 10px;
      }

      .nav-icon i {
        font-size: 1.2rem;
        margin-bottom: 2px;
      }

      .user-dropdown {
        display: none;
      }

      .cart-dropdown {
        min-width: 300px;
        max-width: 90vw;
      }

      .pedidos-sidebar {
        width: 100%;
        right: -100%;
      }
    }

    /* Overlay para sidebar */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1059;
      display: none;
    }

    .sidebar-overlay.show {
      display: block;
    }

    /* Modal Perfil Compacto - ESTILOS SIMPLIFICADOS */
    #editarPerfilModal .modal-content {
      border-radius: 12px;
    }

    #editarPerfilModal .modal-body {
      padding: 1.5rem !important;
      /* Padding forzado */
    }

    #editarPerfilModal .profile-picture-container {
      position: relative;
      display: inline-block;
      margin-bottom: 1rem;
    }

    #editarPerfilModal .profile-picture {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    #editarPerfilModal .profile-picture-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      border: 3px solid white;
      color: white;
      font-size: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    #editarPerfilModal .profile-picture-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.8), rgba(41, 128, 185, 0.9));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.3s ease;
      cursor: pointer;
      border: 3px solid white;
    }

    #editarPerfilModal .profile-picture-container:hover .profile-picture-overlay {
      opacity: 1;
    }

    /* PADDING EN LAS SECCIONES DEL FORMULARIO */
    #editarPerfilModal .form-section {
      padding: 1rem 0;
      border-bottom: 1px solid #f0f0f0;
      margin-bottom: 0.5rem;
    }

    #editarPerfilModal .form-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    #editarPerfilModal .form-section-header {
      display: flex;
      align-items: center;
      margin-bottom: 0.8rem;
    }

    #editarPerfilModal .form-section-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 10px;
      font-size: 0.9rem;
    }

    #editarPerfilModal .form-section-title {
      font-weight: 600;
      color: var(--dark);
      font-size: 1rem;
      margin: 0;
    }

    #editarPerfilModal .form-label {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.4rem;
      font-size: 0.9rem;
    }

    #editarPerfilModal .form-control {
      border: 2px solid #e8f0fe;
      border-radius: 8px;
      padding: 0.6rem 0.8rem;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      background: #fafbfc;
      margin-bottom: 0.5rem;
    }

    #editarPerfilModal .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.2rem rgba(53, 152, 219, 0.15);
      background: white;
    }

    #editarPerfilModal .account-info-card {
      background: linear-gradient(135deg, #f8f9ff, #f0f4ff);
      border: 1px solid #e3e9ff;
      border-radius: 8px;
      padding: 0.8rem;
      margin-bottom: 0.8rem;
    }

    #editarPerfilModal .account-info-label {
      font-weight: 600;
      color: var(--secondary);
      font-size: 0.8rem;
      margin-bottom: 0.2rem;
    }

    #editarPerfilModal .account-info-value {
      font-weight: 700;
      color: var(--dark);
      font-size: 0.9rem;
    }

    #editarPerfilModal .btn-change-photo {
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
      border-radius: 20px;
      padding: 6px 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 0.85rem;
    }

    #editarPerfilModal .btn-save {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 25px;
      padding: 10px 25px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
      font-size: 0.95rem;
    }

    /* Modal más pequeño */
    #editarPerfilModal .modal-dialog {
      max-width: 500px;
    }

    @media (max-width: 576px) {
      #editarPerfilModal .modal-dialog {
        margin: 0.5rem;
      }

      #editarPerfilModal .modal-body {
        padding: 1.25rem !important;
      }
    }
    /* Estilos mejorados para notificaciones */
    .notification-item {
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 1px solid #f8f9fa;
    }

    .notification-item:last-child {
        border-bottom: none;
    }

    .notification-item:hover {
        background: rgba(52, 152, 219, 0.05);
    }

    .notification-item.unread {
        background: rgba(52, 152, 219, 0.08);
        border-left: 3px solid var(--primary);
    }

    .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .notification-title {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 4px;
        color: var(--dark);
    }

    .notification-message {
        font-size: 0.85rem;
        line-height: 1.3;
    }

    .notification-time {
        font-size: 0.75rem;
    }

    .notification-dot {
        width: 8px;
        height: 8px;
        background: #e74c3c;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 8px;
    }

    .notification-list {
        max-height: 400px;
        overflow-y: auto;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="row align-items-center">
        <!-- Logo -->
        <div class="col-lg-2 col-6">
          <a href="{% url 'principal' %}" class="logo">
            VECY
          </a>
        </div>

        <!-- Search Bar -->
        <div class="col-lg-5 d-none d-lg-block">
          <div class="search-container">
            <input type="text" class="search-input" placeholder="Buscar productos, negocios...">
            <button class="search-btn">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>

        <!-- Navigation Icons -->
        <div class="col-lg-5 col-6 text-end">
          {% if request.user.is_authenticated %}
          <div class="d-flex align-items-center justify-content-end gap-3">
            <!-- Wishlist -->
            <a href="#" class="nav-icon position-relative" title="Favoritos" id="favoritos-btn">
              <i class="fas fa-heart"></i>
              <span class="badge" id="wishlist-count">{{ favoritos_count|default:0 }}</span>
            </a>

            <!-- Notifications -->
            <div class="dropdown">
              <a href="#" class="nav-icon position-relative" title="Notificaciones" data-bs-toggle="dropdown"
                id="notifications-dropdown-btn">
                <i class="fas fa-bell"></i>
                <span class="badge" id="notification-count">0</span>
              </a>
              <div class="dropdown-menu dropdown-menu-end notification-dropdown" id="notifications-dropdown-menu">
                <!-- Este contenido se cargará dinámicamente -->
                <div class="text-center py-4">
                  <div class="spinner-border text-primary mb-2" role="status">
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                  <p class="text-muted mb-0">Cargando notificaciones...</p>
                </div>
              </div>
            </div>

            <!-- Pedidos -->
            <a href="#" class="nav-icon position-relative" title="Mis Pedidos" id="pedidos-btn">
              <i class="fas fa-shopping-bag"></i>
              <span class="badge" id="pedidos-count">{{ pedidos_pendientes_count|default:0 }}</span>
            </a>

            <!-- Shopping Cart -->
            <div class="dropdown">
              <a href="#" class="nav-icon position-relative" title="Carrito" data-bs-toggle="dropdown"
                id="cart-dropdown-btn">
                <i class="fas fa-shopping-cart"></i>
                <span class="badge" id="cart-count">{{ carrito_count|default:0 }}</span>
              </a>
              <div class="dropdown-menu dropdown-menu-end cart-dropdown" id="cart-dropdown-menu">
                <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
                  <h6 class="mb-0">Carrito de Compras</h6>
                  <span class="badge bg-primary" id="cart-items-count">0 items</span>
                </div>
                <div id="cart-items-container" style="max-height: 300px; overflow-y: auto;">
                  <!-- Cart items will be loaded here dynamically -->
                  <div class="cart-empty">
                    <i class="fas fa-shopping-cart"></i>
                    <p>Tu carrito está vacío</p>
                    <small class="text-muted">Agrega productos para comenzar</small>
                  </div>
                </div>
                <div class="cart-total">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Total:</strong>
                    <span class="h6 mb-0 text-primary" id="cart-total">$0.00</span>
                  </div>
                  <div class="d-grid gap-2">
                    <a href="{% url 'ver_carrito' %}" class="btn btn-primary-custom btn-sm">
                      <i class="fas fa-shopping-cart me-1"></i>Ver Carrito Completo
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- User Menu -->
            <div class="dropdown user-dropdown">
              <button class="btn dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown"
                aria-expanded="false">
                {% if request.session.usuario_imagen %}
                <img src="{{ request.session.usuario_imagen }}" alt="{{ request.session.usuario_nombre }}"
                  class="user-avatar">
                {% else %}
                <i class="fas fa-user-circle me-1"></i>
                {% endif %}
                {{ request.session.usuario_nombre }}
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editarPerfilModal"
                    onclick="cargarFormularioPerfil()">
                    <i class="fas fa-user me-2"></i>Mi Perfil
                  </a></li>
                <li><a class="dropdown-item" href="#" id="sidebar-pedidos-btn"><i
                      class="fas fa-shopping-bag me-2"></i>Mis Pedidos</a></li>
                <li><a class="dropdown-item" href="#"><i class="fas fa-heart me-2"></i>Favoritos</a></li>
                <li><a class="dropdown-item" href="#"><i class="fas fa-star me-2"></i>Mis Reseñas</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Configuración</a></li>
                <li><a class="dropdown-item" href="#"><i class="fas fa-question-circle me-2"></i>Ayuda</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="{% url 'cerrar_sesion' %}"><i
                      class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a></li>
              </ul>
            </div>
          </div>
          {% else %}
          <!-- Guest User -->
          <div class="d-flex justify-content-end gap-2">
            <a href="{% url 'iniciar_sesion' %}" class="btn btn-outline-custom">Iniciar Sesión</a>
            <a href="{% url 'registro_usuario' %}" class="btn btn-primary-custom">Registrarse</a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile Navigation -->
  {% if request.user.is_authenticated %}
  <nav class="nav-icons d-lg-none">
    <a href="{% url 'principal' %}" class="nav-icon">
      <i class="fas fa-home"></i>
      <span>Inicio</span>
    </a>
    <a href="#" class="nav-icon" id="mobile-favoritos">
      <i class="fas fa-heart"></i>
      <span>Favoritos</span>
    </a>
    <a href="#" class="nav-icon" id="mobile-cart">
      <i class="fas fa-shopping-cart"></i>
      <span>Carrito</span>
    </a>
    <a href="#" class="nav-icon" id="mobile-pedidos">
      <i class="fas fa-shopping-bag"></i>
      <span>Pedidos</span>
    </a>
    <a href="#" class="nav-icon" data-bs-toggle="modal" data-bs-target="#editarPerfilModal"
      onclick="cargarFormularioPerfil()">
      <i class="fas fa-user"></i>
      <span>Perfil</span>
    </a>
  </nav>
  {% endif %}

  <!-- Pedidos Sidebar -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>
  <div class="pedidos-sidebar" id="pedidos-sidebar">
    <div class="pedidos-sidebar-header">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Mis Pedidos</h5>
        <button type="button" class="btn-close btn-close-white" id="close-pedidos-sidebar"></button>
      </div>
    </div>
    <div id="pedidos-content">
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2 text-muted">Cargando pedidos...</p>
      </div>
    </div>
  </div>

  <!-- Messages -->
  {% if messages %}
  <div class="messages-container">
    {% for message in messages %}
    <div
      class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show"
      role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Main Content -->
  <main style="margin-bottom: {% if request.session.usuario_id %}80px{% else %}0{% endif %};">
    {% block content %}
    <!-- El contenido específico de cada página irá aquí -->
    {% endblock %}
  </main>

  <!-- Footer -->
  <footer class="bg-dark text-white py-5 mt-5">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 mb-4">
          <h4 class="text-white mb-3">VECY</h4>
          <p class="text-light">La plataforma que conecta negocios locales con clientes en tu comunidad.</p>
        </div>
        <div class="col-lg-2 mb-4">
          <h5 class="mb-3">Enlaces Rápidos</h5>
          <ul class="list-unstyled">
            <li class="mb-2"><a href="{% url 'principal' %}" class="text-light text-decoration-none">Inicio</a></li>
            <li class="mb-2"><a href="#categorias" class="text-light text-decoration-none">Categorías</a></li>
            <li class="mb-2"><a href="#" class="text-light text-decoration-none">Negocios</a></li>
            <li class="mb-2"><a href="#" class="text-light text-decoration-none">Productos</a></li>
          </ul>
        </div>
        <div class="col-lg-3 mb-4">
          <h5 class="mb-3">Cuenta</h5>
          <ul class="list-unstyled">
            <li class="mb-2"><a href="{% url 'iniciar_sesion' %}" class="text-light text-decoration-none">Iniciar
                Sesión</a></li>
            <li class="mb-2"><a href="{% url 'registro_usuario' %}"
                class="text-light text-decoration-none">Registrarse</a></li>
            <li class="mb-2"><a href="{% url 'cambiar_contrasena' %}" class="text-light text-decoration-none">Recuperar
                Contraseña</a></li>
          </ul>
        </div>
        <div class="col-lg-3 mb-4">
          <h5 class="mb-3">Contacto</h5>
          <ul class="list-unstyled text-light">
            <li class="mb-2"><i class="fas fa-map-marker-alt me-2"></i> Dirección: Calle Principal 123</li>
            <li class="mb-2"><i class="fas fa-phone me-2"></i> Teléfono: +1 234 567 890</li>
            <li class="mb-2"><i class="fas fa-envelope me-2"></i> Email: info@vecy.com</li>
          </ul>
        </div>
      </div>
      <hr class="bg-light">
      <div class="row align-items-center">
        <div class="col-md-6">
          <p class="mb-0">&copy; 2024 VECY. Todos los derechos reservados.</p>
        </div>
        <div class="col-md-6 text-md-end">
          <a href="#" class="text-light me-3"><i class="fab fa-facebook fa-lg"></i></a>
          <a href="#" class="text-light me-3"><i class="fab fa-twitter fa-lg"></i></a>
          <a href="#" class="text-light"><i class="fab fa-instagram fa-lg"></i></a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Modal para Editar Perfil - VERSIÓN COMPACTA -->
  <div class="modal fade modal-perfil-compact" id="editarPerfilModal" tabindex="-1"
    aria-labelledby="editarPerfilModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <!-- Header compacto -->
        <div class="modal-header bg-gradient-primary text-white border-0 py-3">
          <div class="w-100 text-center">
            <h5 class="modal-title fw-bold mb-0" id="editarPerfilModalLabel">
              <i class="fas fa-user-edit me-2"></i>Editar Perfil
            </h5>
          </div>
          <button type="button" class="btn-close btn-close-white position-absolute end-0 top-0 m-2"
            data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <!-- Body compacto -->
        <div class="modal-body p-4"> <!-- AQUÍ PUSE p-4 para padding -->
          <div id="perfil-form-container">
            <!-- Spinner compacto -->
            <div class="text-center py-4">
              <div class="spinner-border text-primary mb-2" style="width: 2rem; height: 2rem;" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <p class="text-muted small mb-0">Cargando formulario...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // =============================================
    // SISTEMA DE NOTIFICACIONES MEJORADO
    // =============================================
    class NotificationSystem {
        constructor() {
            this.isLoading = false;
            this.init();
        }

        init() {
            this.loadNotifications();
            this.setupEventListeners();
            this.setupPolling();
        }

        setupEventListeners() {
            // Cargar notificaciones cuando se abre el dropdown
            const notificationsBtn = document.getElementById('notifications-dropdown-btn');
            if (notificationsBtn) {
                notificationsBtn.addEventListener('click', () => {
                    this.loadNotifications(true);
                });
            }
        }

        // Cargar notificaciones
        async loadNotifications(showDropdown = false) {
            if (this.isLoading) return;
            
            this.isLoading = true;
            try {
                const response = await fetch('{% url "get_notifications" %}');
                const data = await response.json();
                
                if (data.success) {
                    this.updateNotificationUI(data.notifications, data.unread_count);
                    if (showDropdown) {
                        this.showNotificationsDropdown(data.notifications);
                    }
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            } finally {
                this.isLoading = false;
            }
        }

        // Actualizar contador
        updateNotificationUI(notifications, unreadCount) {
            const notificationCountElement = document.getElementById('notification-count');
            if (notificationCountElement) {
                notificationCountElement.textContent = unreadCount;
                // Mostrar/ocultar badge según si hay notificaciones
                if (unreadCount > 0) {
                    notificationCountElement.style.display = 'flex';
                } else {
                    notificationCountElement.style.display = 'none';
                }
            }
        }

        // Mostrar notificaciones en el dropdown
        showNotificationsDropdown(notifications) {
            const dropdownMenu = document.getElementById('notifications-dropdown-menu');
            if (!dropdownMenu) return;

            if (notifications.length === 0) {
                dropdownMenu.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
                        <h6 class="mb-0">Notificaciones</h6>
                    </div>
                    <div class="text-center py-4">
                        <i class="fas fa-bell-slash text-muted fa-2x mb-2"></i>
                        <p class="text-muted mb-0">No hay notificaciones</p>
                    </div>
                    <div class="text-center py-2 border-top">
                        <a href="{% url 'ver_notificaciones' %}" class="text-primary small">Ver historial</a>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
                    <h6 class="mb-0">Notificaciones</h6>
                    <div>
                        <a href="#" class="small text-primary" id="mark-all-read">Marcar todas</a>
                        <a href="{% url 'ver_notificaciones' %}" class="small text-primary ms-2">Ver todas</a>
                    </div>
                </div>
                <div class="notification-list" style="max-height: 400px; overflow-y: auto;">
            `;

            notifications.forEach(notification => {
                const unreadClass = notification.leida ? '' : 'unread';
                const icon = this.getNotificationIcon(notification.tipo);
                
                html += `
                    <div class="notification-item ${unreadClass}" data-id="${notification.id}">
                        <div class="d-flex align-items-start p-3">
                            <div class="notification-icon" style="background: ${icon.color};">
                                <i class="${icon.class}"></i>
                            </div>
                            <div class="notification-content flex-grow-1">
                                <div class="notification-title">${notification.titulo}</div>
                                <div class="notification-message small text-muted">${notification.mensaje}</div>
                                <div class="notification-time small text-muted mt-1">${notification.tiempo}</div>
                            </div>
                            ${!notification.leida ? '<span class="notification-dot ms-2 mt-1"></span>' : ''}
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
                <div class="text-center py-2 border-top">
                    <a href="{% url 'ver_notificaciones' %}" class="text-primary small">Ver historial completo</a>
                </div>
            `;

            dropdownMenu.innerHTML = html;
            this.setupNotificationEvents();
        }

        // Iconos por tipo de notificación
        getNotificationIcon(tipo) {
            const icons = {
                'pedido': { class: 'fas fa-shopping-bag', color: '#3498db' },
                'oferta': { class: 'fas fa-bolt', color: '#e74c3c' },
                'negocio': { class: 'fas fa-store', color: '#2ecc71' },
                'sistema': { class: 'fas fa-info-circle', color: '#f39c12' },
                'alerta': { class: 'fas fa-exclamation-triangle', color: '#e67e22' },
                'promocion': { class: 'fas fa-tag', color: '#9b59b6' }
            };
            return icons[tipo] || icons.sistema;
        }

        // Configurar eventos de notificaciones
        setupNotificationEvents() {
            // Marcar como leída al hacer click
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const notificationId = item.dataset.id;
                    this.markAsRead(notificationId);
                    item.classList.remove('unread');
                    item.querySelector('.notification-dot')?.remove();
                    
                    // Actualizar contador
                    const currentCount = parseInt(document.getElementById('notification-count').textContent);
                    if (currentCount > 0) {
                        document.getElementById('notification-count').textContent = currentCount - 1;
                    }
                });
            });

            // Marcar todas como leídas
            document.getElementById('mark-all-read')?.addEventListener('click', (e) => {
                e.preventDefault();
                this.markAllAsRead();
            });
        }

        // Marcar notificación como leída
        async markAsRead(notificationId) {
            try {
                await fetch('{% url "mark_notification_read" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ notification_id: notificationId })
                });
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Marcar todas como leídas
        async markAllAsRead() {
            try {
                await fetch('{% url "mark_all_notifications_read" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });
                
                // Actualizar UI
                document.getElementById('notification-count').textContent = '0';
                document.getElementById('notification-count').style.display = 'none';
                document.querySelectorAll('.notification-item').forEach(item => {
                    item.classList.remove('unread');
                    item.querySelector('.notification-dot')?.remove();
                });
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
            }
        }

        // Polling para nuevas notificaciones
        setupPolling() {
            setInterval(() => {
                this.loadNotifications();
            }, 30000); // Cada 30 segundos
        }
    }

    // =============================================
    // FUNCIONES GLOBALES
    // =============================================

    // Función para obtener cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // =============================================
    // CÓDIGO EXISTENTE DE CARRITO Y PEDIDOS
    // =============================================

    document.addEventListener('DOMContentLoaded', function () {
      // Inicializar sistema de notificaciones
      window.notificationSystem = new NotificationSystem();

      // Elementos del DOM
      const cartDropdownBtn = document.getElementById('cart-dropdown-btn');
      const cartDropdownMenu = document.getElementById('cart-dropdown-menu');
      const cartItemsContainer = document.getElementById('cart-items-container');
      const cartTotal = document.getElementById('cart-total');
      const cartItemsCount = document.getElementById('cart-items-count');
      const cartCount = document.getElementById('cart-count');

      const pedidosSidebar = document.getElementById('pedidos-sidebar');
      const sidebarOverlay = document.getElementById('sidebar-overlay');
      const pedidosBtn = document.getElementById('pedidos-btn');
      const sidebarPedidosBtn = document.getElementById('sidebar-pedidos-btn');
      const mobilePedidos = document.getElementById('mobile-pedidos');
      const closePedidosSidebar = document.getElementById('close-pedidos-sidebar');
      const pedidosContent = document.getElementById('pedidos-content');

      // Cargar carrito al abrir el dropdown
      if (cartDropdownBtn) {
        cartDropdownBtn.addEventListener('click', loadCartData);
      }

      // Abrir sidebar de pedidos
      function openPedidosSidebar() {
        pedidosSidebar.classList.add('show');
        sidebarOverlay.classList.add('show');
        document.body.style.overflow = 'hidden';
        loadPedidosData();
      }

      // Cerrar sidebar de pedidos
      function closePedidosSidebarFunc() {
        pedidosSidebar.classList.remove('show');
        sidebarOverlay.classList.remove('show');
        document.body.style.overflow = '';
      }

      // Event listeners para pedidos
      if (pedidosBtn) pedidosBtn.addEventListener('click', openPedidosSidebar);
      if (sidebarPedidosBtn) sidebarPedidosBtn.addEventListener('click', openPedidosSidebar);
      if (mobilePedidos) mobilePedidos.addEventListener('click', openPedidosSidebar);
      if (closePedidosSidebar) closePedidosSidebar.addEventListener('click', closePedidosSidebarFunc);
      if (sidebarOverlay) sidebarOverlay.addEventListener('click', closePedidosSidebarFunc);

      // Cargar datos del carrito
      function loadCartData() {
        fetch('{% url "carrito_data" %}')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              updateCartUI(data);
            }
          })
          .catch(error => {
            console.error('Error loading cart data:', error);
          });
      }

      // Actualizar UI del carrito
      function updateCartUI(data) {
        const items = data.items;
        const totales = data.totales;

        // Actualizar contadores
        cartCount.textContent = data.carrito_count;
        cartItemsCount.textContent = `${data.carrito_count} item${data.carrito_count !== 1 ? 's' : ''}`;
        cartTotal.textContent = `$${totales.total.toLocaleString('es-CO')}`;

        // Actualizar items del carrito
        if (items.length === 0) {
          cartItemsContainer.innerHTML = `
            <div class="cart-empty">
              <i class="fas fa-shopping-cart"></i>
              <p>Tu carrito está vacío</p>
              <small class="text-muted">Agrega productos para comenzar</small>
            </div>
          `;
        } else {
          let itemsHTML = '';
          items.forEach(item => {
            const precioTotal = item.precio_unitario * item.cantidad;
            itemsHTML += `
              <div class="cart-item">
                <img src="${item.imagen || '{% static "img/placeholder-product.jpg" %}'}" 
                     alt="${item.nombre}" class="cart-item-img">
                <div class="cart-item-info">
                  <div class="cart-item-name">${item.nombre}</div>
                  ${item.variante ? `<div class="cart-item-variante">${item.variante}</div>` : ''}
                  <div class="cart-item-price">$${item.precio_unitario.toLocaleString('es-CO')} x ${item.cantidad}</div>
                  <div class="cart-item-actions">
                    <button class="btn-quantity" onclick="updateCartQuantity(${item.id}, -1)">
                      <i class="fas fa-minus"></i>
                    </button>
                    <span class="cart-item-quantity">${item.cantidad}</span>
                    <button class="btn-quantity" onclick="updateCartQuantity(${item.id}, 1)">
                      <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn-remove" onclick="removeCartItem(${item.id})">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            `;
          });
          cartItemsContainer.innerHTML = itemsHTML;
        }
      }

      // Cargar datos de pedidos
      function loadPedidosData() {
        fetch('{% url "mis_pedidos_data" %}')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              updatePedidosUI(data.pedidos);
            } else {
              pedidosContent.innerHTML = `
                <div class="text-center py-5">
                  <i class="fas fa-exclamation-triangle text-warning fa-2x mb-3"></i>
                  <p>Error al cargar los pedidos</p>
                </div>
              `;
            }
          })
          .catch(error => {
            console.error('Error loading pedidos data:', error);
            pedidosContent.innerHTML = `
              <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle text-danger fa-2x mb-3"></i>
                <p>Error de conexión</p>
              </div>
            `;
          });
      }

      // Actualizar UI de pedidos
      function updatePedidosUI(pedidos) {
        if (pedidos.length === 0) {
          pedidosContent.innerHTML = `
            <div class="text-center py-5">
              <i class="fas fa-shopping-bag text-muted fa-2x mb-3"></i>
              <p>No tienes pedidos recientes</p>
              <small class="text-muted">Realiza tu primera compra</small>
            </div>
          `;
        } else {
          let pedidosHTML = '';
          pedidos.forEach(pedido => {
            const estadoClass = `estado-${pedido.estado_pedido}`;
            pedidosHTML += `
              <div class="pedido-item">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <strong>Pedido #${pedido.numero_pedido}</strong>
                    <div class="text-muted small">${pedido.fecha_pedido}</div>
                  </div>
                  <span class="pedido-estado ${estadoClass}">${pedido.estado_display}</span>
                </div>
                <div class="mb-2">
                  <small class="text-muted">${pedido.negocio_nombre}</small>
                </div>
                <div class="mb-2">
                  ${pedido.productos.map(producto => `
                    <div class="d-flex justify-content-between small">
                      <span>${producto.nombre} x${producto.cantidad}</span>
                      <span>$${(producto.precio_unitario * producto.cantidad).toLocaleString('es-CO')}</span>
                    </div>
                  `).join('')}
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <strong>Total: $${pedido.total_pedido.toLocaleString('es-CO')}</strong>
                  ${pedido.puede_cancelar ? `
                    <button class="btn btn-outline-danger btn-sm" onclick="cancelarPedido(${pedido.pkid_pedido})">
                      Cancelar
                    </button>
                  ` : ''}
                </div>
                ${pedido.tiempo_restante ? `
                  <div class="text-end small text-muted mt-1">
                    Puedes cancelar en: ${pedido.tiempo_restante}
                  </div>
                ` : ''}
              </div>
            `;
          });
          pedidosContent.innerHTML = pedidosHTML;
        }
      }

      // Cargar carrito al iniciar la página si el usuario está autenticado
      {% if request.user.is_authenticated %}
      loadCartData();
      {% endif %}
    });

    // Función global para actualizar cantidad
    window.updateCartQuantity = function (itemId, cambio) {
      fetch('{% url "actualizar_cantidad_carrito" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          item_id: itemId,
          cambio: cambio
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            loadCartData(); // Recargar carrito
          } else {
            alert(data.message || 'Error al actualizar la cantidad');
          }
        })
        .catch(error => {
          console.error('Error updating cart quantity:', error);
          alert('Error al actualizar la cantidad');
        });
    };

    // Función global para eliminar item
    window.removeCartItem = function (itemId) {
      if (!confirm('¿Estás seguro de que quieres eliminar este producto del carrito?')) {
        return;
      }

      fetch('{% url "eliminar_item_carrito" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          item_id: itemId
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            loadCartData(); // Recargar carrito
          } else {
            alert('Error al eliminar el producto');
          }
        })
        .catch(error => {
          console.error('Error removing cart item:', error);
          alert('Error al eliminar el producto');
        });
    };

    // Función global para cancelar pedido
    window.cancelarPedido = function (pedidoId) {
      if (!confirm('¿Estás seguro de que quieres cancelar este pedido?')) {
        return;
      }

      fetch('{% url "cancelar_pedido" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          pedido_id: pedidoId
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Pedido cancelado exitosamente');
            loadPedidosData(); // Recargar pedidos
          } else {
            alert(data.message || 'Error al cancelar el pedido');
          }
        })
        .catch(error => {
          console.error('Error canceling order:', error);
          alert('Error al cancelar el pedido');
        });
    };

    // =============================================
    // FUNCIONES DE PERFIL (MANTENER EXISTENTES)
    // =============================================

    // Función para cargar el formulario en el modal
    function cargarFormularioPerfil() {
        const container = document.getElementById('perfil-form-container');
        
        // Mostrar spinner
        container.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Cargando formulario...</p>
            </div>
        `;
        
        // Cargar formulario via AJAX
        fetch('{% url "get_perfil_form" %}')
            .then(response => response.text())
            .then(html => {
                container.innerHTML = html;
                inicializarEventosPerfil();
            })
            .catch(error => {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar el formulario
                    </div>
                `;
            });
    }

    // Función para inicializar eventos del formulario
    function inicializarEventosPerfil() {
        const form = document.getElementById('perfilForm');
        const fileInput = document.getElementById('id_img_user');
        
        if (form) {
            form.addEventListener('submit', guardarPerfil);
        }
        
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                previewImage(this);
            });
        }
    }

    // Función para previsualizar imagen
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                let preview = document.getElementById('profile-picture-preview');
                let placeholder = document.getElementById('profile-picture-placeholder');
                
                if (preview) {
                    preview.src = e.target.result;
                } else if (placeholder) {
                    const newImg = document.createElement('img');
                    newImg.src = e.target.result;
                    newImg.className = 'profile-picture';
                    newImg.id = 'profile-picture-preview';
                    newImg.alt = 'Foto de perfil';
                    placeholder.parentNode.replaceChild(newImg, placeholder);
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function guardarPerfil(e) {
        e.preventDefault();
        
        const form = e.target;
        const formData = new FormData(form);
        const btnGuardar = document.getElementById('btn-guardar');
        const messagesDiv = document.getElementById('form-messages');
        
        // Cambiar estado del botón
        const originalText = btnGuardar.innerHTML;
        btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
        btnGuardar.disabled = true;
        
        // Limpiar mensajes anteriores
        if (messagesDiv) {
            messagesDiv.className = 'alert d-none';
            messagesDiv.innerHTML = '';
        }
        
        // Limpiar errores anteriores
        document.querySelectorAll('[id^="error-"]').forEach(el => {
            el.textContent = '';
        });
        
        // Enviar datos
        fetch('{% url "actualizar_perfil" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (messagesDiv) {
                    messagesDiv.className = 'alert alert-success';
                    messagesDiv.innerHTML = `<i class="fas fa-check me-2"></i>${data.message}`;
                }
                
                actualizarInterfazUsuario(data);
                
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editarPerfilModal'));
                    if (modal) {
                        modal.hide();
                    }
                    location.reload();
                }, 2000);
                
            } else {
                if (messagesDiv) {
                    messagesDiv.className = 'alert alert-danger';
                    messagesDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${data.message}`;
                }
                
                if (data.errors) {
                    for (const [field, error] of Object.entries(data.errors)) {
                        const errorElement = document.getElementById(`error-${field}`);
                        if (errorElement) {
                            errorElement.textContent = error;
                        }
                    }
                }
                
                btnGuardar.innerHTML = originalText;
                btnGuardar.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (messagesDiv) {
                messagesDiv.className = 'alert alert-danger';
                messagesDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error de conexión';
            }
            btnGuardar.innerHTML = originalText;
            btnGuardar.disabled = false;
        });
    }

    function actualizarInterfazUsuario(data) {
        const userDropdown = document.querySelector('.user-dropdown .dropdown-toggle');
        if (userDropdown && data.usuario_nombre) {
            const userNameElement = userDropdown.querySelector('.user-avatar')?.nextSibling || 
                                  userDropdown.querySelector('i').nextSibling;
            if (userNameElement) {
                userNameElement.textContent = ' ' + data.usuario_nombre;
            }
        }
        
        if (data.usuario_imagen) {
            const userAvatar = document.querySelector('.user-dropdown .user-avatar');
            if (userAvatar) {
                userAvatar.src = data.usuario_imagen;
            } else {
                const dropdownToggle = document.querySelector('.user-dropdown .dropdown-toggle');
                const icon = dropdownToggle.querySelector('i');
                if (icon) {
                    const newAvatar = document.createElement('img');
                    newAvatar.src = data.usuario_imagen;
                    newAvatar.alt = data.usuario_nombre;
                    newAvatar.className = 'user-avatar';
                    newAvatar.style.width = '32px';
                    newAvatar.style.height = '32px';
                    newAvatar.style.borderRadius = '50%';
                    newAvatar.style.objectFit = 'cover';
                    newAvatar.style.border = '2px solid white';
                    newAvatar.style.marginRight = '8px';
                    dropdownToggle.insertBefore(newAvatar, icon);
                    icon.style.display = 'none';
                }
            }
            
            const profilePreview = document.getElementById('profile-picture-preview');
            if (profilePreview) {
                profilePreview.src = data.usuario_imagen;
            }
        }
    }

    // Inicializar cuando el modal se muestra
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('editarPerfilModal');
        if (modal) {
            modal.addEventListener('show.bs.modal', function() {
                cargarFormularioPerfil();
            });
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.getElementById('perfil-form-container').innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Cargando formulario...</p>
                    </div>
                `;
            });
        }
    });
  </script>
  {% block scripts %}{% endblock %}
</body>

</html>