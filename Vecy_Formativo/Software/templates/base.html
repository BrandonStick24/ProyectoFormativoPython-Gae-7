{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  {% block extra_css %}{% endblock %}
  <title>{% block title %}VECY{% endblock %}</title>
  <link rel="icon" href="{% static 'media/logo_chat.png' %}" type="image/png">
  <style>
    :root {
      --primary: #3598db;
      --secondary: #34495e;
      --dark: #2d3e50;
      --light: #f8f9fb;
      --white: #ffffff;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--light);
      color: var(--dark);
      overflow-x: hidden;
    }

    /* Header Styles */
    .header {
      background-color: var(--white);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
      padding: 15px 0;
    }

    .logo {
      font-weight: 700;
      font-size: 1.8rem;
      color: var(--primary);
      text-decoration: none;
    }

    .logo span {
      color: var(--secondary);
    }

    .logo:hover {
      color: var(--primary);
      text-decoration: none;
    }

    .search-container {
      position: relative;
      max-width: 500px;
    }

    .search-input {
      border-radius: 50px;
      padding: 10px 20px;
      border: 2px solid var(--light);
      transition: var(--transition);
      width: 100%;
    }

    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(53, 152, 219, 0.25);
    }

    .search-btn {
      position: absolute;
      right: 5px;
      top: 5px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 7px 15px;
      transition: var(--transition);
    }

    .search-btn:hover {
      background: var(--secondary);
    }

    /* Estilos para el autocompletado */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }

    .autocomplete-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 400px;
      overflow-y: auto;
      z-index: 1050;
      display: none;
      margin-top: 5px;
    }

    .autocomplete-suggestions.show {
      display: block;
    }

    .suggestion-item {
      padding: 10px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: var(--transition);
      border-bottom: 1px solid #f5f5f5;
    }

    .suggestion-item:hover {
      background-color: #f8f9fa;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--light);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      color: var(--primary);
      font-size: 0.8rem;
    }

    .suggestion-text {
      flex: 1;
    }

    .suggestion-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }

    .suggestion-category {
      font-size: 0.8rem;
      color: #666;
    }

    .recent-searches {
      padding: 10px 15px;
      background: #f8f9fa;
      border-bottom: 1px solid #ddd;
    }

    .recent-title {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .clear-history {
      color: var(--primary);
      cursor: pointer;
      font-size: 0.7rem;
    }

    .clear-history:hover {
      text-decoration: underline;
    }

    .recent-item {
      display: inline-block;
      background: white;
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 4px 12px;
      margin: 3px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .recent-item:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .no-suggestions {
      padding: 20px;
      text-align: center;
      color: #666;
      font-style: italic;
    }

    .search-loading {
      padding: 10px;
      text-align: center;
    }

    .btn-primary-custom {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 10px 25px;
      transition: var(--transition);
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary-custom:hover {
      background: var(--secondary);
      transform: translateY(-2px);
      color: white;
      text-decoration: none;
    }

    .btn-outline-custom {
      border: 2px solid var(--primary);
      color: var(--primary);
      background: transparent;
      border-radius: 50px;
      padding: 10px 25px;
      transition: var(--transition);
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-outline-custom:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
      text-decoration: none;
    }

    /* Nav Icons */
    .nav-icon {
      position: relative;
      color: var(--dark);
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 10px;
      transition: var(--transition);
    }

    .nav-icon:hover {
      background: var(--light);
      color: var(--primary);
    }

    .nav-icon .badge {
      position: absolute;
      top: -5px;
      right: 0;
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* User dropdown */
    .user-dropdown .dropdown-toggle {
      background: var(--primary);
      border: none;
      border-radius: 50px;
      padding: 8px 20px;
      color: white;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-dropdown .dropdown-toggle:hover {
      background: var(--secondary);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid white;
    }

    .dropdown-menu {
      border: none;
      box-shadow: var(--shadow);
      border-radius: 10px;
      padding: 10px 0;
    }

    .dropdown-item {
      padding: 8px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: var(--transition);
    }

    .dropdown-item:hover {
      background: var(--light);
      color: var(--primary);
    }

    .dropdown-divider {
      margin: 8px 0;
    }

    /* Cart Dropdown */
    .cart-dropdown {
      min-width: 350px;
      max-width: 400px;
      padding: 0;
    }

    .cart-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid var(--light);
      transition: var(--transition);
    }

    .cart-item:hover {
      background: rgba(53, 152, 219, 0.05);
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-item-img {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 12px;
    }

    .cart-item-info {
      flex: 1;
      min-width: 0;
    }

    .cart-item-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cart-item-variante {
      font-size: 0.8rem;
      color: var(--secondary);
      margin-bottom: 2px;
    }

    .cart-item-price {
      color: var(--primary);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .cart-item-quantity {
      font-size: 0.8rem;
      color: var(--secondary);
    }

    .cart-item-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 5px;
    }

    .btn-quantity {
      width: 28px;
      height: 28px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 1px solid var(--primary);
      background: white;
      color: var(--primary);
      font-size: 0.8rem;
      transition: var(--transition);
    }

    .btn-quantity:hover {
      background: var(--primary);
      color: white;
    }

    .btn-remove {
      background: none;
      border: none;
      color: #e74c3c;
      font-size: 0.9rem;
      padding: 4px;
      border-radius: 4px;
      transition: var(--transition);
    }

    .btn-remove:hover {
      background: #e74c3c;
      color: white;
    }

    .cart-total {
      padding: 15px;
      background: var(--light);
      border-top: 1px solid #dee2e6;
    }

    .cart-empty {
      text-align: center;
      padding: 30px 20px;
      color: var(--secondary);
    }

    .cart-empty i {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: #bdc3c7;
    }

    /* Notifications */
    .notification-dropdown {
      min-width: 300px;
      max-width: 400px;
    }

    .notification-item {
      padding: 10px 15px;
      border-bottom: 1px solid var(--light);
      transition: var(--transition);
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-item:hover {
      background: var(--light);
    }

    .notification-item.unread {
      background: rgba(52, 152, 219, 0.05);
    }

    .notification-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }

    .notification-time {
      font-size: 0.7rem;
      color: var(--secondary);
    }

    /* Mobile menu */
    .mobile-menu-btn {
      border: none;
      background: none;
      font-size: 1.5rem;
      color: var(--dark);
    }

    /* Messages */
    .messages-container {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1050;
      width: 90%;
      max-width: 500px;
    }

    /* Pedidos sidebar */
    .pedidos-sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: white;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      transition: var(--transition);
      z-index: 1060;
      overflow-y: auto;
    }

    .pedidos-sidebar.show {
      right: 0;
    }

    .pedidos-sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--light);
      background: var(--primary);
      color: white;
    }

    .pedido-item {
      padding: 15px;
      border-bottom: 1px solid var(--light);
      transition: var(--transition);
    }

    .pedido-item:hover {
      background: rgba(53, 152, 219, 0.05);
    }

    .pedido-estado {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .estado-pendiente {
      background: #fff3cd;
      color: #856404;
    }

    .estado-confirmado {
      background: #d1ecf1;
      color: #0c5460;
    }

    .estado-preparando {
      background: #d1ecf1;
      color: #0c5460;
    }

    .estado-enviado {
      background: #d1edff;
      color: #004085;
    }

    .estado-entregado {
      background: #d4edda;
      color: #155724;
    }

    .estado-cancelado {
      background: #f8d7da;
      color: #721c24;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .nav-icons {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--white);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        padding: 10px;
        z-index: 1000;
        display: flex;
        justify-content: space-around;
      }

      .nav-icon {
        flex-direction: column;
        font-size: 0.8rem;
        padding: 5px 10px;
      }

      .nav-icon i {
        font-size: 1.2rem;
        margin-bottom: 2px;
      }

      .user-dropdown {
        display: none;
      }

      .cart-dropdown {
        min-width: 300px;
        max-width: 90vw;
      }

      .pedidos-sidebar {
        width: 100%;
        right: -100%;
      }

      /* Autocompletado m√≥vil */
      .autocomplete-suggestions {
        position: fixed;
        top: 60px;
        left: 10px;
        right: 10px;
        max-height: 300px;
        z-index: 1100;
      }
    }

    /* Overlay para sidebar */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1059;
      display: none;
    }

    .sidebar-overlay.show {
      display: block;
    }

    /* Modal Perfil Compacto - ESTILOS SIMPLIFICADOS */
    #editarPerfilModal .modal-content {
      border-radius: 12px;
    }

    #editarPerfilModal .modal-body {
      padding: 1.5rem !important;
      /* Padding forzado */
    }

    #editarPerfilModal .profile-picture-container {
      position: relative;
      display: inline-block;
      margin-bottom: 1rem;
    }

    #editarPerfilModal .profile-picture {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    #editarPerfilModal .profile-picture-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      border: 3px solid white;
      color: white;
      font-size: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    #editarPerfilModal .profile-picture-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.8), rgba(41, 128, 185, 0.9));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.3s ease;
      cursor: pointer;
      border: 3px solid white;
    }

    #editarPerfilModal .profile-picture-container:hover .profile-picture-overlay {
      opacity: 1;
    }

    /* PADDING EN LAS SECCIONES DEL FORMULARIO */
    #editarPerfilModal .form-section {
      padding: 1rem 0;
      border-bottom: 1px solid #f0f0f0;
      margin-bottom: 0.5rem;
    }

    #editarPerfilModal .form-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    #editarPerfilModal .form-section-header {
      display: flex;
      align-items: center;
      margin-bottom: 0.8rem;
    }

    #editarPerfilModal .form-section-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 10px;
      font-size: 0.9rem;
    }

    #editarPerfilModal .form-section-title {
      font-weight: 600;
      color: var(--dark);
      font-size: 1rem;
      margin: 0;
    }

    #editarPerfilModal .form-label {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.4rem;
      font-size: 0.9rem;
    }

    #editarPerfilModal .form-control {
      border: 2px solid #e8f0fe;
      border-radius: 8px;
      padding: 0.6rem 0.8rem;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      background: #fafbfc;
      margin-bottom: 0.5rem;
    }

    #editarPerfilModal .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.2rem rgba(53, 152, 219, 0.15);
      background: white;
    }

    #editarPerfilModal .account-info-card {
      background: linear-gradient(135deg, #f8f9ff, #f0f4ff);
      border: 1px solid #e3e9ff;
      border-radius: 8px;
      padding: 0.8rem;
      margin-bottom: 0.8rem;
    }

    #editarPerfilModal .account-info-label {
      font-weight: 600;
      color: var(--secondary);
      font-size: 0.8rem;
      margin-bottom: 0.2rem;
    }

    #editarPerfilModal .account-info-value {
      font-weight: 700;
      color: var(--dark);
      font-size: 0.9rem;
    }

    #editarPerfilModal .btn-change-photo {
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
      border-radius: 20px;
      padding: 6px 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 0.85rem;
    }

    #editarPerfilModal .btn-save {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 25px;
      padding: 10px 25px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
      font-size: 0.95rem;
    }

    /* Modal m√°s peque√±o */
    #editarPerfilModal .modal-dialog {
      max-width: 500px;
    }

    @media (max-width: 576px) {
      #editarPerfilModal .modal-dialog {
        margin: 0.5rem;
      }

      #editarPerfilModal .modal-body {
        padding: 1.25rem !important;
      }
    }
    /* Estilos mejorados para notificaciones */
    .notification-item {
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 1px solid #f8f9fa;
    }

    .notification-item:last-child {
        border-bottom: none;
    }

    .notification-item:hover {
        background: rgba(52, 152, 219, 0.05);
    }

    .notification-item.unread {
        background: rgba(52, 152, 219, 0.08);
        border-left: 3px solid var(--primary);
    }

    .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .notification-title {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 4px;
        color: var(--dark);
    }

    .notification-message {
        font-size: 0.85rem;
        line-height: 1.3;
    }

    .notification-time {
        font-size: 0.75rem;
    }

    .notification-dot {
        width: 8px;
        height: 8px;
        background: #e74c3c;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 8px;
    }

    .notification-list {
        max-height: 400px;
        overflow-y: auto;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="row align-items-center">
        <!-- Logo -->
        <div class="col-lg-2 col-6">
          <a href="{% url 'cliente_dashboard' %}" class="logo">
            VECY
          </a>
        </div>

        <!-- Search Bar - CON AUTOCOMPLETADO -->
        <div class="col-lg-5 d-none d-lg-block">
          <div class="autocomplete-container">
            <input type="text" class="search-input" id="search-input" 
                   placeholder="Buscar productos, negocios..." 
                   value="{{ request.GET.q|default:'' }}"
                   autocomplete="off">
            <button class="search-btn" id="search-btn">
              <i class="fas fa-search"></i>
            </button>
            <div class="autocomplete-suggestions" id="autocomplete-suggestions-desktop">
              <!-- Las sugerencias se cargar√°n aqu√≠ din√°micamente -->
            </div>
          </div>
        </div>

        <!-- Mobile Search Bar (oculta en desktop) -->
        <div class="col-12 d-lg-none mt-2">
          <div class="autocomplete-container">
            <input type="text" class="search-input" id="search-input-mobile" 
                   placeholder="Buscar productos, negocios..." 
                   value="{{ request.GET.q|default:'' }}"
                   autocomplete="off">
            <button class="search-btn" id="search-btn-mobile">
              <i class="fas fa-search"></i>
            </button>
            <div class="autocomplete-suggestions" id="autocomplete-suggestions-mobile">
              <!-- Las sugerencias se cargar√°n aqu√≠ din√°micamente -->
            </div>
          </div>
        </div>

        <!-- Navigation Icons -->
        <div class="col-lg-5 col-6 text-end">
          {% if request.user.is_authenticated %}
          <div class="d-flex align-items-center justify-content-end gap-3">
            <!-- Wishlist -->
            <a href="#" class="nav-icon position-relative" title="Favoritos" id="favoritos-btn">
              <i class="fas fa-heart"></i>
              <span class="badge" id="wishlist-count">{{ favoritos_count|default:0 }}</span>
            </a>

            <!-- Notifications -->
            <div class="dropdown">
              <a href="#" class="nav-icon position-relative" title="Notificaciones" data-bs-toggle="dropdown"
                id="notifications-dropdown-btn">
                <i class="fas fa-bell"></i>
                <span class="badge" id="notification-count">0</span>
              </a>
              <div class="dropdown-menu dropdown-menu-end notification-dropdown" id="notifications-dropdown-menu">
                <!-- Este contenido se cargar√° din√°micamente -->
                <div class="text-center py-4">
                  <div class="spinner-border text-primary mb-2" role="status">
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                  <p class="text-muted mb-0">Cargando notificaciones...</p>
                </div>
              </div>
            </div>

            <!-- Pedidos -->
            <a href="#" class="nav-icon position-relative" title="Mis Pedidos" id="pedidos-btn">
              <i class="fas fa-shopping-bag"></i>
              <span class="badge" id="pedidos-count">{{ pedidos_pendientes_count|default:0 }}</span>
            </a>

            <!-- Shopping Cart -->
            <div class="dropdown">
              <a href="#" class="nav-icon position-relative" title="Carrito" data-bs-toggle="dropdown"
                id="cart-dropdown-btn">
                <i class="fas fa-shopping-cart"></i>
                <span class="badge" id="cart-count">{{ carrito_count|default:0 }}</span>
              </a>
              <div class="dropdown-menu dropdown-menu-end cart-dropdown" id="cart-dropdown-menu">
                <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
                  <h6 class="mb-0">Carrito de Compras</h6>
                  <span class="badge bg-primary" id="cart-items-count">0 items</span>
                </div>
                <div id="cart-items-container" style="max-height: 300px; overflow-y: auto;">
                  <!-- Cart items will be loaded here dynamically -->
                  <div class="cart-empty">
                    <i class="fas fa-shopping-cart"></i>
                    <p>Tu carrito est√° vac√≠o</p>
                    <small class="text-muted">Agrega productos para comenzar</small>
                  </div>
                </div>
                <div class="cart-total">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Total:</strong>
                    <span class="h6 mb-0 text-primary" id="cart-total">$0.00</span>
                  </div>
                  <div class="d-grid gap-2">
                    <a href="{% url 'ver_carrito' %}" class="btn btn-primary-custom btn-sm">
                      <i class="fas fa-shopping-cart me-1"></i>Ver Carrito Completo
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- User Menu -->
            <div class="dropdown user-dropdown">
              <button class="btn dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown"
                aria-expanded="false">
                {% if request.session.usuario_imagen %}
                <img src="{{ request.session.usuario_imagen }}" alt="{{ request.session.usuario_nombre }}"
                  class="user-avatar">
                {% else %}
                <i class="fas fa-user-circle me-1"></i>
                {% endif %}
                {{ request.session.usuario_nombre }}
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editarPerfilModal"
                    onclick="cargarFormularioPerfil()">
                    <i class="fas fa-user me-2"></i>Mi Perfil
                  </a></li>
                <li><a class="dropdown-item" href="#" id="sidebar-pedidos-btn"><i
                      class="fas fa-shopping-bag me-2"></i>Mis Pedidos</a></li>
                <li><a class="dropdown-item" href="#"><i class="fas fa-heart me-2"></i>Favoritos</a></li>
                <li><a class="dropdown-item" href="#"><i class="fas fa-star me-2"></i>Mis Rese√±as</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Configuraci√≥n</a></li>
                <li><a class="dropdown-item" href="#"><i class="fas fa-question-circle me-2"></i>Ayuda</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="{% url 'cerrar_sesion' %}"><i
                      class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n</a></li>
              </ul>
            </div>
          </div>
          {% else %}
          <!-- Guest User -->
          <div class="d-flex justify-content-end gap-2">
            <a href="{% url 'iniciar_sesion' %}" class="btn btn-outline-custom">Iniciar Sesi√≥n</a>
            <a href="{% url 'registro_usuario' %}" class="btn btn-primary-custom">Registrarse</a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile Navigation -->
  {% if request.user.is_authenticated %}
  <nav class="nav-icons d-lg-none">
    <a href="{% url 'principal' %}" class="nav-icon">
      <i class="fas fa-home"></i>
      <span>Inicio</span>
    </a>
    <a href="#" class="nav-icon" id="mobile-favoritos">
      <i class="fas fa-heart"></i>
      <span>Favoritos</span>
    </a>
    <a href="#" class="nav-icon" id="mobile-cart">
      <i class="fas fa-shopping-cart"></i>
      <span>Carrito</span>
    </a>
    <a href="#" class="nav-icon" id="mobile-pedidos">
      <i class="fas fa-shopping-bag"></i>
      <span>Pedidos</span>
    </a>
    <a href="#" class="nav-icon" data-bs-toggle="modal" data-bs-target="#editarPerfilModal"
      onclick="cargarFormularioPerfil()">
      <i class="fas fa-user"></i>
      <span>Perfil</span>
    </a>
  </nav>
  {% endif %}

  <!-- Pedidos Sidebar -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>
  <div class="pedidos-sidebar" id="pedidos-sidebar">
    <div class="pedidos-sidebar-header">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Mis Pedidos</h5>
        <button type="button" class="btn-close btn-close-white" id="close-pedidos-sidebar"></button>
      </div>
    </div>
    <div id="pedidos-content">
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2 text-muted">Cargando pedidos...</p>
      </div>
    </div>
  </div>

  <!-- Messages -->
  {% if messages %}
  <div class="messages-container">
    {% for message in messages %}
    <div
      class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show"
      role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Main Content -->
  <main style="margin-bottom: {% if request.user.is_authenticated %}80px{% else %}0{% endif %};">
    {% block content %}
    <!-- El contenido espec√≠fico de cada p√°gina ir√° aqu√≠ -->
    {% endblock %}
  </main>

  <!-- Footer -->
  <footer class="bg-dark text-white py-5 mt-5">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 mb-4">
          <h4 class="text-white mb-3">VECY</h4>
          <p class="text-light">La plataforma que conecta negocios locales con clientes en tu comunidad.</p>
        </div>
        <div class="col-lg-2 mb-4">
          <h5 class="mb-3">Enlaces R√°pidos</h5>
          <ul class="list-unstyled">
            <li class="mb-2"><a href="{% url 'principal' %}" class="text-light text-decoration-none">Inicio</a></li>
            <li class="mb-2"><a href="#categorias" class="text-light text-decoration-none">Categor√≠as</a></li>
            <li class="mb-2"><a href="#" class="text-light text-decoration-none">Negocios</a></li>
            <li class="mb-2"><a href="#" class="text-light text-decoration-none">Productos</a></li>
          </ul>
        </div>
        <div class="col-lg-3 mb-4">
          <h5 class="mb-3">Cuenta</h5>
          <ul class="list-unstyled">
            <li class="mb-2"><a href="{% url 'iniciar_sesion' %}" class="text-light text-decoration-none">Iniciar
                Sesi√≥n</a></li>
            <li class="mb-2"><a href="{% url 'registro_usuario' %}"
                class="text-light text-decoration-none">Registrarse</a></li>
            <li class="mb-2"><a href="{% url 'cambiar_contrasena' %}" class="text-light text-decoration-none">Recuperar
                Contrase√±a</a></li>
          </ul>
        </div>
        <div class="col-lg-3 mb-4">
          <h5 class="mb-3">Contacto</h5>
          <ul class="list-unstyled text-light">
            <li class="mb-2"><i class="fas fa-map-marker-alt me-2"></i> Direcci√≥n: Calle Principal 123</li>
            <li class="mb-2"><i class="fas fa-phone me-2"></i> Tel√©fono: +1 234 567 890</li>
            <li class="mb-2"><i class="fas fa-envelope me-2"></i> Email: info@vecy.com</li>
          </ul>
        </div>
      </div>
      <hr class="bg-light">
      <div class="row align-items-center">
        <div class="col-md-6">
          <p class="mb-0">&copy; 2024 VECY. Todos los derechos reservados.</p>
        </div>
        <div class="col-md-6 text-md-end">
          <a href="#" class="text-light me-3"><i class="fab fa-facebook fa-lg"></i></a>
          <a href="#" class="text-light me-3"><i class="fab fa-twitter fa-lg"></i></a>
          <a href="#" class="text-light"><i class="fab fa-instagram fa-lg"></i></a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Modal para Editar Perfil - VERSI√ìN COMPACTA -->
  <div class="modal fade modal-perfil-compact" id="editarPerfilModal" tabindex="-1"
    aria-labelledby="editarPerfilModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <!-- Header compacto -->
        <div class="modal-header bg-gradient-primary text-white border-0 py-3">
          <div class="w-100 text-center">
            <h5 class="modal-title fw-bold mb-0" id="editarPerfilModalLabel">
              <i class="fas fa-user-edit me-2"></i>Editar Perfil
            </h5>
          </div>
          <button type="button" class="btn-close btn-close-white position-absolute end-0 top-0 m-2"
            data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <!-- Body compacto -->
        <div class="modal-body p-4"> <!-- AQU√ç PUSE p-4 para padding -->
          <div id="perfil-form-container">
            <!-- Spinner compacto -->
            <div class="text-center py-4">
              <div class="spinner-border text-primary mb-2" style="width: 2rem; height: 2rem;" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <p class="text-muted small mb-0">Cargando formulario...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
/// =============================================
// CONFIGURACI√ìN GLOBAL
// =============================================
const VECY_CONFIG = {
    IS_LOGGED_IN: {% if request.user.is_authenticated %}true{% else %}false{% endif %},
    RECENT_SEARCHES_KEY: 'vecy_recent_searches_final'
};

// =============================================
// SISTEMA DE AUTOCOMPLETADO COMPLETO
// =============================================
class VecyAutocomplete {
    constructor() {
        this.searchTimeout = null;
        this.currentQuery = '';
        this.init();
    }

    init() {
        console.log('üöÄ Inicializando VecyAutocomplete...');
        
        // Configurar ambos campos
        this.setupSearchField('search-input', 'autocomplete-suggestions-desktop');
        this.setupSearchField('search-input-mobile', 'autocomplete-suggestions-mobile');
        
        this.setupGlobalEvents();
        console.log('‚úÖ VecyAutocomplete listo');
    }

    setupSearchField(inputId, suggestionsId) {
        const input = document.getElementById(inputId);
        const suggestions = document.getElementById(suggestionsId);
        
        if (!input || !suggestions) {
            console.warn(`‚ö†Ô∏è No se encontr√≥: ${inputId} o ${suggestionsId}`);
            return;
        }

        // Evento input
        input.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            console.log(`‚å®Ô∏è Input "${inputId}": "${query}"`);
            this.handleInput(query, suggestions, inputId);
        });

        // Evento focus
        input.addEventListener('focus', () => {
            const query = input.value.trim();
            console.log(`üëÅÔ∏è Focus en ${inputId}: "${query}"`);
            
            if (query.length === 0) {
                this.showRecentSearches(suggestions, inputId);
            } else if (query.length >= 2) {
                this.handleInput(query, suggestions, inputId);
            }
        });

        // Evento keydown
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = input.value.trim();
                console.log(`‚ÜµÔ∏è Enter en ${inputId}: "${query}"`);
                this.performSearch(query, inputId);
            } else if (e.key === 'Escape') {
                this.hideSuggestions(suggestions);
            }
        });

        // Bot√≥n de b√∫squeda
        const buttonId = inputId.includes('mobile') ? 'search-btn-mobile' : 'search-btn';
        const button = document.getElementById(buttonId);
        if (button) {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const query = input.value.trim();
                console.log(`üñ±Ô∏è Bot√≥n ${inputId}: "${query}"`);
                this.performSearch(query, inputId);
            });
        }
    }

    setupGlobalEvents() {
        // Cerrar al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                this.hideAllSuggestions();
            }
        });

        // Cerrar con Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.hideAllSuggestions();
            }
        });
    }

    async handleInput(query, suggestionsElement, inputId) {
        this.currentQuery = query;
        clearTimeout(this.searchTimeout);

        if (query.length === 0) {
            this.showRecentSearches(suggestionsElement, inputId);
            return;
        }

        if (query.length < 2) {
            this.showMessage(suggestionsElement, 
                'Escribe al menos 2 caracteres...', 'info');
            return;
        }

        this.showLoading(suggestionsElement, query);

        this.searchTimeout = setTimeout(async () => {
            // Verificar que la query no haya cambiado
            if (this.currentQuery !== query) {
                console.log(`‚è≠Ô∏è Query cambi√≥ de "${query}" a "${this.currentQuery}", ignorando...`);
                return;
            }

            try {
                console.log(`üîç Buscando: "${query}"`);
                const data = await this.fetchSuggestions(query);
                
                // Verificar que sigamos con la misma query
                if (this.currentQuery === query) {
                    this.displaySuggestions(data, query, suggestionsElement);
                }
            } catch (error) {
                console.error('‚ùå Error en b√∫squeda:', error);
                this.showMessage(suggestionsElement, 'Error al buscar sugerencias', 'error');
            }
        }, 350);
    }

    async fetchSuggestions(query) {
        try {
            const url = `/api/sugerencia-debug/?q=${encodeURIComponent(query)}`;
            console.log(`üì° Llamando API: ${url}`);
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            console.log(`‚úÖ API respondi√≥: ${data.suggestions?.length || 0} sugerencias`);
            
            // DEBUG: Mostrar las sugerencias
            if (data.suggestions && data.suggestions.length > 0) {
                data.suggestions.forEach((s, i) => {
                    console.log(`   ${i+1}. ${s.value}`);
                });
            }
            
            return data;
            
        } catch (error) {
            console.error('‚ùå Error en fetch:', error);
            throw error;
        }
    }

    displaySuggestions(data, query, container) {
        if (!container) return;

        let html = '';

        if (!data.success || !data.suggestions || data.suggestions.length === 0) {
            console.log(`üì≠ No hay resultados para: "${query}"`);
            html = this.getNoResultsHTML(query);
        } else {
            console.log(`‚ú® Mostrando ${data.suggestions.length} sugerencias`);
            
            // Mostrar todas las sugerencias (solo productos)
            data.suggestions.forEach(suggestion => {
                html += this.getSuggestionItemHTML(suggestion, query);
            });

            // Opci√≥n "Buscar todo" al final
            const searchUrl = VECY_CONFIG.IS_LOGGED_IN ? 
                '/productos-filtrados/' : '/productos/';
            
            html += `
                <div class="search-all-container">
                    <div class="suggestion-item search-all-item" 
                         data-url="${searchUrl}?q=${encodeURIComponent(query)}">
                        <div class="suggestion-icon" style="background: var(--primary);">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="suggestion-text">
                            <div class="suggestion-title">Buscar todo: "${query}"</div>
                            <div class="suggestion-category">Ver todos los resultados</div>
                        </div>
                        <div class="text-primary">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
        container.classList.add('show');
        this.attachSuggestionEvents(container);
    }

    getSuggestionItemHTML(suggestion, query) {
        const icon = this.getIconForType(suggestion.type);
        
        // Resaltar la query en el texto (si est√° presente)
        let displayText = suggestion.text;
        if (query && suggestion.value.toLowerCase().includes(query.toLowerCase())) {
            const regex = new RegExp(`(${this.escapeRegExp(query)})`, 'gi');
            displayText = suggestion.text.replace(regex, '<mark class="highlight-query">$1</mark>');
        }

        return `
            <div class="suggestion-item" data-url="${suggestion.url || '#'}">
                <div class="suggestion-icon" style="background: ${icon.color};">
                    <i class="${icon.class}"></i>
                </div>
                <div class="suggestion-text">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="suggestion-title">${displayText}</div>
                        ${suggestion.precio_formateado ? 
                            `<span class="text-primary fw-bold ms-2">${suggestion.precio_formateado}</span>` : ''}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                        <span class="suggestion-category">
                            <i class="${icon.small} me-1"></i>${suggestion.category}
                        </span>
                        ${suggestion.negocio ? 
                            `<small class="text-muted"><i class="fas fa-store me-1"></i>${suggestion.negocio}</small>` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    getNoResultsHTML(query) {
        return `
            <div class="no-suggestions">
                <div class="text-center py-4">
                    <i class="fas fa-search fa-2x text-muted mb-3"></i>
                    <div class="fw-bold">No hay resultados para "${query}"</div>
                    <div class="small text-muted mt-2">
                        Intenta con otras palabras o revisa la ortograf√≠a
                    </div>
                </div>
            </div>
        `;
    }

    showRecentSearches(container, inputId) {
        const searches = this.getRecentSearches();
        
        if (!container) return;
        
        console.log(`üìö Mostrando ${searches.length} b√∫squedas recientes`);
        
        if (searches.length === 0) {
            this.showMessage(container, 'No hay b√∫squedas recientes', 'history');
            return;
        }
        
        let html = `
            <div class="recent-searches">
                <div class="recent-title">
                    <span><i class="fas fa-history me-2"></i>B√∫squedas recientes</span>
                    <button type="button" class="btn-clear-history btn btn-link p-0 text-primary">
                        <i class="fas fa-trash-alt me-1"></i>Limpiar
                    </button>
                </div>
                <div class="recent-items-container">
        `;
        
        searches.forEach((search, index) => {
            const isNew = index < 2 ? '<span class="badge bg-primary ms-1" style="font-size: 0.6rem; padding: 1px 4px;">nuevo</span>' : '';
            html += `
                <div class="recent-item" data-search="${this.escapeHtml(search)}">
                    <i class="fas fa-search me-2"></i>
                    <span class="recent-item-text">${search}</span>
                    ${isNew}
                </div>
            `;
        });
        
        html += `</div></div>`;
        
        container.innerHTML = html;
        container.classList.add('show');
        
        // Eventos para items del historial
        container.querySelectorAll('.recent-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const searchTerm = item.dataset.search;
                console.log(`‚Ü©Ô∏è Click en historial: "${searchTerm}"`);
                
                const input = document.getElementById(inputId);
                if (input) {
                    input.value = searchTerm;
                    input.focus();
                    this.performSearch(searchTerm, inputId);
                }
            });
        });
        
        // Evento para limpiar historial
        container.querySelector('.btn-clear-history')?.addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('¬øEst√°s seguro de que quieres limpiar todo el historial de b√∫squedas?')) {
                localStorage.removeItem(VECY_CONFIG.RECENT_SEARCHES_KEY);
                this.showRecentSearches(container, inputId);
                console.log('üóëÔ∏è Historial limpiado');
            }
        });
    }

    showLoading(container, query) {
        if (!container) return;
        
        container.innerHTML = `
            <div class="search-loading">
                <div class="d-flex align-items-center justify-content-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary me-3"></div>
                    <span>Buscando "${query}"...</span>
                </div>
            </div>
        `;
        container.classList.add('show');
    }

    showMessage(container, message, type = 'info') {
        if (!container) return;
        
        const icons = {
            info: 'info-circle',
            error: 'exclamation-triangle',
            history: 'history',
            search: 'search'
        };
        
        container.innerHTML = `
            <div class="no-suggestions">
                <i class="fas fa-${icons[type] || 'info-circle'} me-2"></i>
                ${message}
            </div>
        `;
        container.classList.add('show');
    }

    performSearch(query, inputId) {
        if (!query || query.trim() === '') return;
        
        console.log(`üîé Ejecutando b√∫squeda: "${query}"`);
        
        // Guardar en historial
        this.saveToRecentSearches(query);
        
        // Ocultar sugerencias
        this.hideAllSuggestions();
        
        // Redirigir
        const searchUrl = VECY_CONFIG.IS_LOGGED_IN ? 
            '/productos-filtrados/' : '/productos/';
        
        console.log(`üìç Redirigiendo a: ${searchUrl}?q=${encodeURIComponent(query)}`);
        window.location.href = `${searchUrl}?q=${encodeURIComponent(query)}`;
    }

    saveToRecentSearches(searchTerm) {
        try {
            if (!searchTerm || searchTerm.trim().length < 2) {
                console.log('‚ö†Ô∏è B√∫squeda muy corta, no guardando en historial');
                return false;
            }
            
            let searches = this.getRecentSearches();
            
            // Eliminar duplicados (case insensitive)
            searches = searches.filter(s => 
                s.toLowerCase() !== searchTerm.toLowerCase()
            );
            
            // Agregar al inicio
            searches.unshift(searchTerm);
            
            // Limitar a 12 b√∫squedas
            if (searches.length > 12) {
                searches = searches.slice(0, 12);
            }
            
            localStorage.setItem(VECY_CONFIG.RECENT_SEARCHES_KEY, JSON.stringify(searches));
            console.log(`üíæ Historial guardado: "${searchTerm}" (total: ${searches.length})`);
            return true;
            
        } catch (error) {
            console.error('‚ùå Error guardando historial:', error);
            return false;
        }
    }

    getRecentSearches() {
        try {
            const searches = localStorage.getItem(VECY_CONFIG.RECENT_SEARCHES_KEY);
            return searches ? JSON.parse(searches) : [];
        } catch (error) {
            console.error('‚ùå Error leyendo historial:', error);
            return [];
        }
    }

    getIconForType(type) {
        const icons = {
            'producto': { 
                class: 'fas fa-box', 
                small: 'fas fa-box',
                color: '#3498db' 
            },
            'negocio': { 
                class: 'fas fa-store', 
                small: 'fas fa-store',
                color: '#2ecc71' 
            },
            'categoria': { 
                class: 'fas fa-tag', 
                small: 'fas fa-tag',
                color: '#9b59b6' 
            }
        };
        return icons[type] || icons.producto;
    }

    attachSuggestionEvents(container) {
        container.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', () => {
                const url = item.dataset.url;
                console.log(`üéØ Click en sugerencia: ${url}`);
                
                if (url && url !== '#') {
                    window.location.href = url;
                }
                this.hideAllSuggestions();
            });
            
            // Efecto hover
            item.addEventListener('mouseenter', () => {
                item.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
                item.style.transform = 'translateX(3px)';
            });
            
            item.addEventListener('mouseleave', () => {
                item.style.backgroundColor = '';
                item.style.transform = '';
            });
        });
    }

    hideSuggestions(container) {
        if (container) {
            container.classList.remove('show');
        }
    }

    hideAllSuggestions() {
        document.querySelectorAll('.autocomplete-suggestions').forEach(container => {
            this.hideSuggestions(container);
        });
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// =============================================
// INICIALIZACI√ìN
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Inicializando VECY Search System...');
    
    // Inicializar autocompletado
    window.vecyAutocomplete = new VecyAutocomplete();
    
    // Agregar estilos din√°micos
    this.addAutocompleteStyles();
    
    console.log('‚úÖ Sistema de b√∫squeda VECY inicializado correctamente');
});

// =============================================
// ESTILOS DIN√ÅMICOS
// =============================================
function addAutocompleteStyles() {
    const styles = document.createElement('style');
    styles.textContent = `
        /* Animaciones */
        .autocomplete-suggestions {
            animation: fadeIn 0.25s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 12px;
            overflow: hidden;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Items de sugerencia */
        .suggestion-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }
        
        .suggestion-item:hover {
            background-color: rgba(52, 152, 219, 0.08) !important;
            border-left: 4px solid var(--primary);
            padding-left: 12px;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        /* Iconos */
        .suggestion-icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        /* Texto */
        .suggestion-text {
            flex: 1;
            min-width: 0;
        }
        
        .suggestion-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .highlight-query {
            background-color: rgba(255, 193, 7, 0.3);
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: 700;
        }
        
        .suggestion-category {
            font-size: 0.8rem;
            color: #6c757d;
            display: flex;
            align-items: center;
        }
        
        /* Historial */
        .recent-searches {
            padding: 15px;
        }
        
        .recent-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.85rem;
            color: #495057;
        }
        
        .recent-items-container {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .recent-item {
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .recent-item:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateX(5px);
        }
        
        .recent-item:hover .badge {
            background-color: white !important;
            color: var(--primary) !important;
        }
        
        .recent-item-text {
            flex: 1;
            font-size: 0.9rem;
        }
        
        /* Buscar todo */
        .search-all-container {
            background: linear-gradient(135deg, #f8f9ff, #e3f2fd);
            border-top: 2px solid #e9ecef;
        }
        
        .search-all-item {
            background: white !important;
            border: 2px solid var(--primary) !important;
            margin: 10px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.15);
        }
        
        .search-all-item:hover {
            background: var(--primary) !important;
            color: white !important;
        }
        
        .search-all-item:hover .text-primary {
            color: white !important;
        }
        
        /* Estados */
        .no-suggestions, .search-loading {
            padding: 30px 20px;
            text-align: center;
            color: #6c757d;
        }
        
        .no-suggestions i {
            font-size: 2.2rem;
            margin-bottom: 15px;
            color: #adb5bd;
        }
        
        .search-loading .spinner-border {
            width: 1.3rem;
            height: 1.3rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .autocomplete-suggestions {
                position: fixed !important;
                top: 70px !important;
                left: 10px !important;
                right: 10px !important;
                max-height: 70vh;
                overflow-y: auto;
                z-index: 1050;
            }
            
            .suggestion-item {
                padding: 14px 12px;
            }
            
            .suggestion-icon {
                width: 36px;
                height: 36px;
            }
        }
    `;
    document.head.appendChild(styles);
}

// =============================================
// FUNCIONES DE PERFIL (MANTENIDAS)
// =============================================
function cargarFormularioPerfil() {
    const container = document.getElementById('perfil-form-container');
    if (!container) return;
    
    container.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2 text-muted">Cargando formulario...</p>
        </div>
    `;
    
    fetch('{% url "get_perfil_form" %}')
        .then(response => response.text())
        .then(html => {
            container.innerHTML = html;
            inicializarEventosPerfil();
        })
        .catch(error => {
            console.error('Error cargando formulario:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al cargar el formulario
                </div>
            `;
        });
}

function inicializarEventosPerfil() {
    const form = document.getElementById('perfilForm');
    if (form) form.addEventListener('submit', guardarPerfil);
    
    const fileInput = document.getElementById('id_img_user');
    if (fileInput) fileInput.addEventListener('change', previewImage);
}

function previewImage(event) {
    const input = event.target;
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('profile-picture-preview');
            const placeholder = document.getElementById('profile-picture-placeholder');
            
            if (preview) {
                preview.src = e.target.result;
            } else if (placeholder) {
                placeholder.style.backgroundImage = `url(${e.target.result})`;
                placeholder.style.backgroundSize = 'cover';
                placeholder.innerHTML = '';
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function guardarPerfil(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    const btnGuardar = form.querySelector('#btn-guardar');
    const originalText = btnGuardar.innerHTML;
    
    btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
    btnGuardar.disabled = true;
    
    fetch('{% url "actualizar_perfil" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editarPerfilModal'));
                if (modal) modal.hide();
                location.reload();
            }, 1500);
        } else {
            alert(data.message || 'Error al guardar');
            btnGuardar.innerHTML = originalText;
            btnGuardar.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexi√≥n');
        btnGuardar.innerHTML = originalText;
        btnGuardar.disabled = false;
    });
}

// Funci√≥n getCookie para el perfil
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

console.log('‚ú® Script VECY cargado completamente');
  </script>
  {% block scripts %}{% endblock %}
</body>

</html>